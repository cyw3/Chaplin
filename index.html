<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Hexo</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Hexo"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hexo"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Hexo"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Hexo"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="John Doe"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Hexo","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"John Doe"},"publisher":{"@type":"Organization","name":"Hexo","logo":{"@type":"ImageObject","url":"http://example.com/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-24T05:34:45.046Z" title="7/24/2022, 1:34:45 PM">2022-07-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-24T05:34:45.046Z" title="7/24/2022, 1:34:45 PM">2022-07-24</time></span><span class="level-item"> YalesonChan </span><span class="level-item">11 minutes read (About 1689 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/24/2016-01-20-OpenCV-with-CodeBlocks/">OpenCV with CodeBlocks</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>近年，机器学习当火。而OpenCV便是机器学习在图像识别领域的热门框架。恰好近来闲来无事，便开始捣鼓一番OpenCV。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li>OpenCV介绍</li>
<li>minGW版OpenCV配置方式</li>
<li>CodeBlocks IDE示例代码实现</li>
</ol>
<h2 id="1-OpenCV介绍"><a href="#1-OpenCV介绍" class="headerlink" title="1.OpenCV介绍"></a>1.OpenCV介绍</h2><p>OpenCV的全称是：Open Source Computer Vision Library。OpenCV是一个基于BSD许可（开源）发行的跨平台计算机视觉库，可以运行在Linux、Windows和Mac OS操作系统上。它轻量级而且高效——由一系列 C 函数和少量 C++ 类构成，同时提供了Python、Ruby、MATLAB等语言的接口，实现了图像处理和计算机视觉方面的很多通用算法。</p>
<p>为什么有OpenCV？</p>
<p>计算机视觉市场巨大而且持续增长，且这方面没有标准API，如今的计算机视觉软件大概有以下三种：</p>
<ol>
<li>研究代码（慢，不稳定，独立并与其他库不兼容）</li>
<li>耗费很高的商业化工具（比如Halcon, MATLAB+Simulink）</li>
<li>依赖硬件的一些特别的解决方案（比如视频监控，制造控制系统，医疗设备）这是如今的现状。而标准的API将简化计算机视觉程序和解决方案的开发。OpenCV致力于成为这样的标准API。</li>
</ol>
<p>OpenCV致力于真实世界的实时应用，通过优化的C代码的编写对其<br>执行速度带来了可观的提升，并且可以通过购买Intel的IPP高性能多媒体函数库(Integrated Performance Primitives)得到更快的处理速度。</p>
<p>主要应用方向有：人机互动，人脸识别，运动跟踪，图像分割等等。</p>
<h2 id="2-minGW版OpenCV配置方式"><a href="#2-minGW版OpenCV配置方式" class="headerlink" title="2.minGW版OpenCV配置方式"></a>2.minGW版OpenCV配置方式</h2><p>首先，我们来看看需要准备的什么吧。</p>
<p>Win7系统</p>
<p><a target="_blank" rel="noopener" href="http://sourceforge.net/projects/mingw/files/Installer/">mingw-get-setup.exe</a></p>
<p><a target="_blank" rel="noopener" href="http://opencv.org/downloads.html">opencv-2.4.9.exe</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cmake.org/download/">cmake-3.2.0-rc1-win32-x86.exe</a></p>
<p>然后，双击opencv-2.4.9.exe，这是opencv的一个自解压程序，指定好安装目录，他将自动把.exe里的文件解压到指定目录。现在，咱们来看看OpenCV的目录结构吧。</p>
<blockquote>
<p>opencv</p>
<blockquote>
<p>build、sources</p>
</blockquote>
</blockquote>
<blockquote>
<p>build</p>
<blockquote>
<p>doc、include、java、python、x64、x86、LICENSE、OpenCVConfig.cmake、OpenCVConfig-version.cmake</p>
</blockquote>
</blockquote>
<p>可知，在opencv目录下有两个文件夹，分别为build、以及source。其中source是OpenCV的源码。而build是各个语言版本编译过后的库文件，包含c、c++、java、python等语言。x86文件夹和x86文件夹分别对应的是32-bit、64-bit系统下的库。在x64、x86中，有如下目录结构：</p>
<blockquote>
<p>vc10、vc11、vc12</p>
</blockquote>
<p>分别对应的是Virtual Studio2010、2011、2012编译后的库。因为不同的编译器(即便相同的编译器，但不同版本，编译后的文件也是不同的)。同编译器编译出来的OpenCV，只能在相应的编译环境下运行。在早前的如OpenCV 2.3.1中还有vc9（对应vs2008）和mingw版本，而在2.4版本之后便只有vc系列了。</p>
<p>而现在，因为我们使用的编译器是MinGW，而该版本的OpenCV没有对应的编译后文件，所以，我们不得不来自己对源码进行编译。</p>
<p>那么，接下来，我们便开始编译工作了。</p>
<p>1)安装MinGW。</p>
<p>很简单。直接双击，指定安装目录，确认安装即可。</p>
<p>2)出现以下界面，至少点击以下两图所示的条目，并安装。</p>
<p><img src="/img/MinGW0.png" alt="MinGW0"></p>
<p><img src="/img/MinGW1.png" alt="MinGW1"></p>
<p>3)安装cmake</p>
<p>4)运行cmake，在where is the source code中填入OpenCV源代码文件的路径，比如：“…&#x2F;opencv_2410&#x2F;sources”；在where to build the binaries中填入编译文件需要存放的路径，比如：“…&#x2F;MinGW&#x2F;Debug”(存放路径文件自己定义新建一个即可)。(三点表示省略)</p>
<p><img src="/img/cmake.jpg" alt="cmake"></p>
<p>5)点击“Configure”;在Specify the generator for this project中选择MinGW Makefiles(选择刚刚安装的MinGW或者本机已有的)，选中Specify native compilers，点击“Next”。</p>
<p><img src="/img/cmake1.jpg" alt="cmake1"></p>
<p>6)选择编译器路径，这里Compilers: C 选择目录为“…&#x2F;MinGW&#x2F;bin&#x2F;gcc.exe”; C++ 选择目录为 “…&#x2F;MinGw&#x2F;bin&#x2F;g++.exe”，点击“Finish”</p>
<p><img src="/img/cmake2.jpg" alt="cmake2"></p>
<p>7)然后再次点“Configure”</p>
<p><img src="/img/cmake3.jpg" alt="cmake3"></p>
<p>8)等走完进度条，选择需要的Generate选项，此处可以不操作直接点“Generate”，走完进度条便生成了“MinGW Makefiles”</p>
<p><img src="/img/cmake4.jpg" alt="cmake4"></p>
<p>9)之后用mingw对其进行编译，cmd打开命令提示符窗口，进到刚才的保存目录，这里是“…&#x2F;opencv2.4.10&#x2F;MinGW&#x2F;Debug”，输入“mingw32-make”，回车；等待运行完毕后，输入 mingw32-make install,回车；（此过程大约需1-2个小时）</p>
<p>10)运行完毕后便生成了mingw版的OpenCV库，进入“…&#x2F;opencv2.4.10&#x2F;MinGW&#x2F;Debug&#x2F;install”文件夹，便可以看到所需的头文件和库文件</p>
<p><img src="/img/cmake5.jpg" alt="cmake5"></p>
<h2 id="3-CodeBlocks-IDE示例代码实现"><a href="#3-CodeBlocks-IDE示例代码实现" class="headerlink" title="3.CodeBlocks IDE示例代码实现"></a>3.CodeBlocks IDE示例代码实现</h2><p>我所选用的IDE是</p>
<p><a target="_blank" rel="noopener" href="http://www.codeblocks.org/">codeblocks-13.12mingw-setup.exe</a></p>
<p>codeblocks默认使用的编译器是MinGW。</p>
<p>1)双击安装codeblocks</p>
<p>2)启动codeblocks，新建一个“Console application”项目，任意取一个名字。</p>
<p>3)测试代码如下</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &quot;cv.h&quot;  </span></span><br><span class="line"><span class="comment">#include &quot;highgui.h&quot;  </span></span><br><span class="line">int main()  </span><br><span class="line">&#123;  </span><br><span class="line">    IplImage* img = cvLoadImage(<span class="string">&quot;test.jpg&quot;</span>);  </span><br><span class="line">    cvNamedWindow( <span class="string">&quot;test&quot;</span>, <span class="number">0</span> );  </span><br><span class="line">    cvShowImage(<span class="string">&quot;test&quot;</span>, img);  </span><br><span class="line">    cvWaitKey(<span class="number">0</span>);  </span><br><span class="line">    cvReleaseImage( &amp;img );  </span><br><span class="line">    cvDestroyWindow( <span class="string">&quot;test&quot;</span> );  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>4)设置opencv相关头文件以及库文件路径</p>
<p>这一步是关键。因为还是有点麻烦的。</p>
<p>(1)右击项目名称，选build options：</p>
<p><img src="/img/codeblocks0.jpg" alt="codeblocks0"></p>
<p>(2)弹出窗口，首先添加头文件路径，依次点击：Search directories-&gt;Complier-&gt;Add，选择头文件所在目录</p>
<p><img src="/img/codeblocks1.png" alt="codeblocks1"></p>
<p>(3)选择库文件路径，依次点击Linker-&gt;Add，选择vc10下的lib库路径</p>
<p><img src="/img/codeblocks2.png" alt="codeblocks2"></p>
<p>(4)最后点击 Linker settings，添加相应库文件，这里如果不知道自己会用到那些库文件的话，可以将vc10&#x2F;lib下的所有库文件全部添加进去</p>
<p><img src="/img/codeblocks3.png" alt="codeblocks3"></p>
<p>5)动态库调用设置</p>
<p>两种方法任选其一即可：</p>
<p>1.可以设置系统变量，将“…\opencv\build\x86\vc10\bin;”添加到系统变量中</p>
<p>2.将…\opencv\build\x86\vc10\bin下的所有dll文件复制到codeblocks对应工程下的bin\Debug文件夹下即可（如果会分辨opencv库文件的话，也可以只将用到的动态库复制即可）。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item"> YalesonChan </span><span class="level-item">9 minutes read (About 1292 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/24/2016-01-19-Rescue-Simulation-League-Team-Description-S.O.S-(Iran)/">RoboCup Rescue 2015 – Rescue Simulation League Team Description S.O.S (Iran)</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这是我过去一年一直在准备并参与的一个比赛<strong>RoboCup Recuse Similation League</strong>。虽然现在比赛已经结束，但还是抽出时间整理了下以前的东西。为了下届学弟学妹们，也翻译了些许文章。而这一片是描述我们在世界级别比赛上的最大的对手，世界冠军<strong>S.O.S</strong>。这是<a target="_blank" rel="noopener" href="http://roborescue.sourceforge.net/2015/TDP/S.O.S.%20-%20Agent%20&%20Multi-Agent%20Challenge.pdf">原文链接</a>。以下便开始翻译内容。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li>摘要</li>
<li>介绍</li>
<li>Agent</li>
</ol>
<h2 id="摘要："><a href="#摘要：" class="headerlink" title="摘要："></a>摘要：</h2><p>SOS团队是众所周知的，在救援仿真联赛中表现出色。我们已经在这个比赛中取得了很多的奖项。去年，我们在巴西举行的机器人世界杯获得第一名。我们团队已经发展了多年，主要是老成员，这些年在不同的比赛中我们的基本代码的得分非常稳定，本文旨在提高老战略和解决新出现的逻辑错误和增加新的功能。</p>
<h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1.介绍"></a>1.介绍</h2><p>该S.O.S.基础AT的能力和技能，在往年的TDP（2010- 2014年）进行了说明，因此本文所要描绘的是我们的计划，就2015年机器人世界杯新战略的细节改进进行介绍。</p>
<p>去年SOS成员开发全速和低速通信，但到2015年机器人世界杯大赛SOS的主要重点是没有沟通的地图，这种方式专门为消防官兵和警察部队AT创造。在自然灾害中所有类型的事件会发生。正因为如此，在最困难的情况下，我们将执行这么多的活动，来操纵我们的代码。</p>
<h2 id="2-agent"><a href="#2-agent" class="headerlink" title="2 agent"></a>2 agent</h2><h3 id="2-1-警察"><a href="#2-1-警察" class="headerlink" title="2.1 警察"></a>2.1 警察</h3><p>我们去年的TDP没有讨论被添加到Policeforce代码的新功能。因此，在今年的TDP，我们注重描写警察的算法和方法。</p>
<h3 id="2-1-1-清理系统"><a href="#2-1-1-清理系统" class="headerlink" title="2.1.1 清理系统"></a>2.1.1 清理系统</h3><p>改变在2013年模拟服务器中大量的AT卡在地图上的陡峭的边缘问题。定义此问题时必须指出的是，当AT是停留在一个凹区域，其他代理将包围它并引起排斥力卡ＡＴ。其结果是，大量的时间将在释放该ＡＴ的过程中被浪费。</p>
<p>清理时与街道不具有相同的方向原因。道路有在关节角的方向之间的陡峭的角度，这将导致在凹形区域中的间隙的棱角产生影响。简单和基本的解决办法是清除整条道路，但我们已经避免了，因为这会浪费大量的周期。<br>　<br>该SOS警方已经设计和开发新的系统和算法，将减小卡在边缘AT的概率。清除时，我们的算法考虑到所有的未来路径，然后选择最佳路径（基于接下来的步骤），同时考虑所有选项（而不是选择和清除的道路的主要方向），这将导致降低卡在陡峭的边缘可能性。图（1）图（2），我们可以比较SOS新的结算方法，由浙江大学队结算。</p>
<p><img src="/img/SOS.png" alt="SOS"></p>
<h3 id="2-1-2-消防队到达火区"><a href="#2-1-2-消防队到达火区" class="headerlink" title="2.1.2 消防队到达火区"></a>2.1.2 消防队到达火区</h3><p>一个在警察部队的其他变动是增加了中断状态，用于帮助消防队处理火灾。如果一个警察看到或感知火灾发生后，AT开始估计火灾的大小。如果猜测，火灾是相当小的尺寸，警方会放弃自己的任务，首先释放消防大队AT和火之间的路径，所以大火将更快熄灭。</p>
<h3 id="2-1-3-检查火灾的概率状态"><a href="#2-1-3-检查火灾的概率状态" class="headerlink" title="2.1.3 检查火灾的概率状态"></a>2.1.3 检查火灾的概率状态</h3><p>加入警队的另一个特点是检查火灾概率状态。在这种状态下，如果警方检测一些建筑物的高温，AT开始估计火灾可能发生。如果发生火灾的地区是ＡＴ附近，ＡＴ将清除道路，所以可以阻止火灾发生。</p>
<h3 id="2-1-4-无通讯世界模型"><a href="#2-1-4-无通讯世界模型" class="headerlink" title="2.1.4　无通讯世界模型"></a>2.1.4　无通讯世界模型</h3><p>我们的警察部队也更新与消防队的通讯，这是在没有通信战略的世界模型下。在没有沟通的策略下，如果ＡＴ检测火的集群，遵循火找到它的边界。但是，什么是比找到火并通知火的新信息消防大队代理更重要。警方代理发现消防大队的负责灭火，并更新了消防的信息。由于没有沟通，根据他们的旧世界模式不明，为消防队的最有可能的地方，警方搜查了代理商的确切位置。然后警察代理更新世界模型的每个消防队的信息，如果火剂的最后一次更新的时间超过15个周期。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item"> YalesonChan </span><span class="level-item">15 minutes read (About 2178 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/24/2016-01-22-Gaussian-Blur/">Gaussian Blur</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>玩了OpenCV之后，感觉自己能分分钟写出个PS软件，真是嘚瑟了。不过，这倒是也是个方向。所以，现在就来写个滤镜吧。</p>
<p>说到底，在计算机眼中，所谓的图片就是一个矩阵，对于他的处理跟线性代数是极其相关的，所以大学狗还是认真学习去吧。好了，不闹了。说到滤镜，说到矩阵，当然要想到PS软件里面的”Gaussian Blur”啦。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><p>Gaussian Blur的介绍</p>
</li>
<li><p>Gaussian Blur的原理</p>
</li>
<li><p>Gaussian Blur的例子以及代码实现</p>
</li>
</ol>
<h2 id="1-Gaussian-Blur的介绍"><a href="#1-Gaussian-Blur的介绍" class="headerlink" title="1. Gaussian Blur的介绍"></a>1. Gaussian Blur的介绍</h2><p>高斯模糊（英语：Gaussian Blur），也叫高斯平滑，是在Adobe Photoshop、GIMP以及Paint.NET等图像处理软件中广泛使用的处理效果，通常用它来减少图像噪声以及降低细节层次。</p>
<p>这种模糊技术生成的图像，其视觉效果就像是经过一个半透明屏幕在观察图像，这与镜头焦外成像效果散景以及普通照明阴影中的效果都明显不同。高斯平滑也用于计算机视觉算法中的预先处理阶段，以增强图像在不同比例大小下的图像效果。 从数学的角度来看，图像的高斯模糊过程就是图像与正态分布做卷积。由于正态分布又叫作高斯分布，所以这项技术就叫作高斯模糊。图像与圆形方框模糊做卷积将会生成更加精确的焦外成像效果。由于高斯函数的傅立叶变换是另外一个高斯函数，所以高斯模糊对于图像来说就是一个低通滤波器。</p>
<p>本文介绍”高斯模糊”的算法，这是一个非常简单易懂的算法。本质上，它是一种<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Smoothing">数据平滑技术（data smoothing）</a>。</p>
<h2 id="2-Gaussian-Blur的原理"><a href="#2-Gaussian-Blur的原理" class="headerlink" title="2. Gaussian Blur的原理"></a>2. Gaussian Blur的原理</h2><blockquote>
<p>所谓”模糊”，可以理解成每一个像素都取周边像素的平均值。</p>
</blockquote>
<p>是的，”平均值”是<strong>模糊</strong>的关键。他能够将清晰度高的照片，运用平均值，将图片的细节隐藏，使这个像素矩阵的变化更为平滑。</p>
<p>咱们先来看看个例子：</p>
<p><img src="/img/gs0.png" alt="gs0"></p>
<p>还未进行模糊处理过的图片，里面的像素数值是不定，细节暴露的。就比如上图，中间数值是2，周边是1。</p>
<p><img src="/img/gs1.png" alt="gs1"></p>
<p>“中间点”取”周围点”的平均值，就会变成1。在数值上，这是一种”平滑化”。在图形上，就相当于产生”模糊”效果，”中间点”失去细节。</p>
<p>显然，计算平均值时，取值范围越大，”模糊效果”越强烈。</p>
<p><img src="/img/gs2.jpg" alt="gs2"></p>
<p>上面分别是原图、模糊半径3像素、模糊半径10像素的效果。模糊半径越大，图像就越模糊。从数值角度看，就是数值越平滑。</p>
<p>这就是<em>模糊</em>的原理。而以上这个例子的模糊算法便是最常见的3x3模板的均值模糊，即取一定半径内的像素值之平均值作为当前点的新的像素值。</p>
<p>其实，这个时候，本文也算是结束了。因为，你会发现，其他图像模糊算法是大同小异的，只是在求均值的时候因为侧重点的不同而赋予这个矩阵的各个像素点以不同的权重而已。不过，我还是会继续讲下去的，不然会被打死。</p>
<p>那么我们接着来，大家一定听说过’Gaussian’这位伟大的学者吧。那么他有名的”高斯分布”，也就是”正态分布”也是知道的吧。对的，就是你想的那样。所谓的”高斯模糊”，就是将<em>高斯分布</em>和<em>模糊</em>两者结合起来的，然后就随随便便的冠上了伟大的”Gsussian”的名头，让人还以为高大上，很难，其实就是求均值。</p>
<p>前面我们说到了”权重”，是想让这个矩阵中筛选出对于中间点是相对更加重要的点，并给它在求均值的时候更大的影响力。而高斯模糊中的权重函数，真是高斯分布。</p>
<p><img src="/img/gs3.png" alt="gs3"></p>
<p>由高斯分布可以知道，距离中点越近的点，显然他的权重是越大的；相反，越远，权重就越小。</p>
<p>计算平均值的时候，我们只需要将”中心点”作为原点，其他点按照其在正态曲线上的位置，分配权重，就可以得到一个加权平均值。</p>
<p>接下来祭出高斯分布的密度函数的计算公式：</p>
<p><img src="/img/GAOSI.png" alt="GAOSI"></p>
<p>其中，μ是x的均值，σ是x的方差。因为计算平均值的时候，中心点就是原点，所以μ等于0。</p>
<p><img src="/img/gaosi1.png" alt="gaosi1"></p>
<p>又因为像素矩阵是二维的，而现在这个密度函数是一维的。根据一维高斯函数，可以推导得到二维高斯函数：</p>
<p><img src="/img/gaosi2.png" alt="gaosi2"></p>
<h2 id="3-Gaussian-Blur的步骤以及代码实现"><a href="#3-Gaussian-Blur的步骤以及代码实现" class="headerlink" title="3. Gaussian Blur的步骤以及代码实现"></a>3. Gaussian Blur的步骤以及代码实现</h2><p>根据高斯模糊的原理，我们已经知道，要根据二维高斯函数求取像素矩阵的均值，以此来进行模糊处理。</p>
<p>1）求取权重矩阵</p>
<p>咱们还是使用的阮一峰老师博客的例子：</p>
<p>假定使用的3x3模板，中心点的坐标是（0,0），那么距离它最近的8个点的坐标如下，更远的点以此类推：</p>
<p><img src="/img/gs5.png" alt="gs5"></p>
<p>为了计算权重矩阵，需要设定σ的值。假定σ&#x3D;1.5，分别将这个九宫格中的各个点的坐标代入上面的二维高斯函数计算公式，求出各自的G(x,y).则模糊半径为1的权重矩阵如下：</p>
<p><img src="/img/gs6.png" alt="gs6"></p>
<p>这9个点的权重总和等于0.4787147，如果只计算这9个点的加权平均，还必须让它们的权重之和等于1，因此上面9个值还要分别除以0.4787147，得到最终的权重矩阵。</p>
<p><img src="/img/gs7.png" alt="gs7"></p>
<p>2）计算高斯模糊</p>
<p>就是说计算中间点的值。</p>
<p>假设现有9个像素点，灰度值（0-255）如下：</p>
<p><img src="/img/gs8.png" alt="gs8"></p>
<p>各自乘上各自对应的权重。</p>
<p><img src="/img/gs9.png" alt="gs9"></p>
<p><img src="/img/gs10.png" alt="gs10"></p>
<p>将这九个值相加即可得到中间点的数值。这就是中间点高斯模糊值。</p>
<p>对所有点重复这个过程，就得到了高斯模糊后的图像。如果原图是彩色图片，可以对RGB三个通道分别做高斯模糊。</p>
<p>对于边缘的点，就是把已有的点拷贝到另一面的对应位置，模拟出完整的矩阵。</p>
<p>那么接下是<a target="_blank" rel="noopener" href="https://github.com/cyw3/CywLeetCode/blob/master/LeetCode/src/com/cyw/algorithms/GaussianBlur.java">代码实现</a>：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import java.awt.Color;</span><br><span class="line">import java.awt.image.BufferedImage;</span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import javax.imageio.ImageIO;</span><br><span class="line"> </span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">GaussianBlur</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="regexp">/**</span></span><br><span class="line"><span class="regexp">　*　简单高斯模糊算法</span></span><br><span class="line"><span class="regexp">　*　@param　args</span></span><br><span class="line"><span class="regexp">　*　@throws　IOException　[参数说明]</span></span><br><span class="line"><span class="regexp">　*　@return　void　[返回类型说明]</span></span><br><span class="line"><span class="regexp">　*　@exception　throws　[违例类型]　[违例说明]</span></span><br><span class="line"><span class="regexp">　*　@see　[类、类#方法、类#成员]</span></span><br><span class="line"><span class="regexp">　*/</span></span><br><span class="line">	public static void main(String [] args) throws IOException &#123;</span><br><span class="line">		BufferedImage img = ImageIO.read(new File(<span class="string">&quot;BigData.jpg&quot;</span>));</span><br><span class="line">		System.out.println(img);</span><br><span class="line">		int height = img.getHeight();</span><br><span class="line">		int width = img.getWidth();</span><br><span class="line">		</span><br><span class="line">		<span class="regexp">/**</span></span><br><span class="line"><span class="regexp">		 * 计算一个九宫格的平均值</span></span><br><span class="line"><span class="regexp">		 */</span></span><br><span class="line">		int[][] matrix = new int[<span class="number">3</span>][<span class="number">3</span>];</span><br><span class="line">		int[] values = new int[<span class="number">9</span>];</span><br><span class="line">		<span class="keyword">for</span> (int i = <span class="number">0</span>;i&lt;width;i++)&#123;</span><br><span class="line">			<span class="keyword">for</span>(int j = <span class="number">0</span>;j&lt;height;j++)&#123;</span><br><span class="line">				readPixel(img,i,j,values);</span><br><span class="line">				fillMatrix(matrix,values);</span><br><span class="line">				img.setRGB(i, j, avgMatrix(matrix));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		ImageIO.write(img,<span class="string">&quot;jpeg&quot;</span>,new File(<span class="string">&quot;test.jpg&quot;</span>));<span class="regexp">//</span>保存在工程为test.jpeg文件</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	private static void readPixel(BufferedImage img, int x, int y, int[] pixels)&#123;</span><br><span class="line">		int xStart = x - <span class="number">1</span>;</span><br><span class="line">		int yStart = y - <span class="number">1</span>;</span><br><span class="line">		int current = <span class="number">0</span>;</span><br><span class="line">		<span class="regexp">//</span></span><br><span class="line">		<span class="keyword">for</span> (int i=xStart;i&lt;<span class="number">3</span>+xStart;i++)&#123;</span><br><span class="line">			<span class="keyword">for</span>(int j=yStart;j&lt;<span class="number">3</span>+yStart;j++)&#123;</span><br><span class="line">				int tx=i;</span><br><span class="line">				<span class="keyword">if</span>(tx&lt;<span class="number">0</span>)&#123;</span><br><span class="line">					tx=-tx;</span><br><span class="line">				&#125;<span class="keyword">else</span> <span class="keyword">if</span>(tx&gt;=img.getWidth())&#123;</span><br><span class="line">					tx=x;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				int ty=j;</span><br><span class="line">				<span class="keyword">if</span>(ty&lt;<span class="number">0</span>)&#123;</span><br><span class="line">					ty=-ty;</span><br><span class="line">				&#125;<span class="keyword">else</span> <span class="keyword">if</span>(ty&gt;=img.getHeight())&#123;</span><br><span class="line">					ty=y;</span><br><span class="line">				&#125;</span><br><span class="line">				pixels[current++]=img.getRGB(tx,ty);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	private static void fillMatrix(int[][] matrix, int... values) &#123;</span><br><span class="line">		int filled=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;matrix.length;i++)&#123;</span><br><span class="line">			int[] x=matrix[i];</span><br><span class="line">			<span class="keyword">for</span>(int j=<span class="number">0</span>;j&lt;x.length;j++)&#123;</span><br><span class="line">				x[j]=values[filled++];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	private static int avgMatrix(int[][] matrix)&#123;</span><br><span class="line">		int r=<span class="number">0</span>;</span><br><span class="line">		int g=<span class="number">0</span>;</span><br><span class="line">		int  b=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;matrix.length;i++)&#123;</span><br><span class="line">			int[] x=matrix[i];</span><br><span class="line">			<span class="keyword">for</span>(int j=<span class="number">0</span>;j&lt;x.length;j++)&#123;</span><br><span class="line">				<span class="keyword">if</span>(j==<span class="number">1</span>)&#123;</span><br><span class="line">					continue;</span><br><span class="line">				&#125;</span><br><span class="line">				Color c=new Color(x[j]);</span><br><span class="line">				r+=c.getRed();</span><br><span class="line">				g+=c.getGreen();</span><br><span class="line">				b+=c.getBlue();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> new Color(r/<span class="number">8</span>,g/<span class="number">8</span>,b/<span class="number">8</span>).getRGB();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>再来个wiki上面的例子吧，大家可以巩固一下：</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A#.E9.AB.98.E6.96.AF.E7.9F.A9.E9.98.B5.E7.A4.BA.E4.BE.8B"><img src="/img/GSexample.png" alt="GSexample"></a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item"> YalesonChan </span><span class="level-item">32 minutes read (About 4726 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/24/2016-04-04-Android-Activity/">Activity on Android</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Activity是Android组件中最基本也是最为常见用的<a target="_blank" rel="noopener" href="http://www.cnblogs.com/pepcod/archive/2013/02/11/2937403.html">四大组件</a>（Activity，Service服务,Content Provider内容提供者，BroadcastReceiver广播接收器）之一。Activity是一个应用程序组件，提供一个屏幕，用户可以用来交互为了完成某项任务。在一个Android应用中，一个Activity通常就是一个单独的屏幕，它上面可以显示一些控件也可以监听并处理用户的事件做出响应。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li>Activity的状态</li>
<li>Activity的生命周期</li>
<li>Activity栈</li>
<li>Activity的加载模式以及区别</li>
<li>Activity 之间通信</li>
<li>Activity 的 Intent Filter</li>
</ol>
<h2 id="一、Activity的状态"><a href="#一、Activity的状态" class="headerlink" title="一、Activity的状态"></a>一、Activity的状态</h2><p>在 Android 中，Activity 拥有四种基本状态：</p>
<p>活动态Active&#x2F;Runing：当一个Activity在Activity栈顶，它处于可视的、有焦点、可接受用户输入的激活状态。Android试图尽最大可能保持它活动状态，杀死其它Activity来确保当前活动Activity有足够的资源可使用。当另外一个Activity被激活，这个将会被暂停。</p>
<p>暂停态Paused：当 Activity 被另一个透明或者 Dialog 样式的 Activity 覆盖时的状态。此时它依然与窗口管理器保持连接，系统继续维护其内部状态，所以它仍然可见，但它已经失去了焦点故不可与用户交互。当被暂停，一个Activity仍会被当成活动状态，只不过是不可以接受用户输入。在极特殊的情况下，Android将会杀死一个暂停的Activity来为活动的Activity提供充足的资源。当一个Activity变为完全隐藏，它将会变成停止。</p>
<p>停止态Stoped：当 Activity 被另外一个 Activity 覆盖、失去焦点并不可见时处于 Stoped状态。当一个Activity不是可视的，它“停止”了。这个Activity将仍然在内存中保存它所有的状态和会员信息。尽管如此，当其它地方需要内存时，它将是最有可能被释放资源的。当一个Activity停止后，一个很重要的步骤是要保存数据和当前UI状态。一旦一个Activity退出或关闭了，它将变为待用状态。</p>
<p>待用态Killed：在一个Activity被杀死后和被装在前，它是待用状态的。待用Acitivity被移除Activity栈，并且需要在显示和可用之前重新启动它。</p>
<p>当一个 Activity 实例被创建、销毁或者启动另外一个 Activity时，它在这四种状态之间进行转换，这种转换的发生依赖于用户程序的动作。下图说明了Activity在不同状态间转换的时机和条件：</p>
<p><img src="/img/ActivityStates.jpg" alt="ActivityStates.jpg"></p>
<p>如上所示，Android 程序员可以决定一个 Activity 的“生”，但不能决定它的“死”，也就时说程序员可以启动一个 Activity，但是却不能手动的“结束”一个 Activity。当你调用 Activity.finish()方法时，结果和用户按下 BACK 键一样：告诉 Activity Manager 该 Activity 实例完成了相应的工作，可以被“回收”。随后 Activity Manager 激活处于栈第二层的 Activity 并重新入栈，同时原 Activity 被压入到栈的第二层，从 Active 状态转到 Paused 状态。例如：从 Activity1 中启动了 Activity2，则当前处于栈顶端的是 Activity2，第二层是 Activity1，当我们调用 Activity2.finish()方法时，Activity Manager 重新激活 Activity1 并入栈，Activity2 从 Active 状态转换 Stoped 状态，Activity1. onActivityResult(int requestCode, int resultCode, Intent data)方法被执行，Activity2 返回的数据通过 data参数返回给 Activity1。</p>
<h2 id="二、-Activity的生命周期"><a href="#二、-Activity的生命周期" class="headerlink" title="二、 Activity的生命周期"></a>二、 Activity的生命周期</h2><p>Activty的生命周期的也就是它所在进程的生命周期。</p>
<p><img src="/img/ActivityLoop.jpg" alt="ActivityLoop.jpg"></p>
<p>一个Activity的启动顺序：<br>onCreate()——&gt;onStart()——&gt;onResume()</p>
<p>当另一个Activity启动时:<br>第一个Activity onPause()——&gt;第二个Activity onCreate()——&gt;onStart()——&gt; onResume() ——&gt;第一个Activity onStop()</p>
<p>当返回到第一个Activity时：<br>第二个Activity onPause() ——&gt; 第一个Activity onRestart()——&gt;onStart()——&gt;onResume() ——&gt;第二个Activity onStop()——&gt;onDestroy()</p>
<p>一个Activity的销毁顺序:<br>（情况一）onPause()——&gt;<Process Killed><br>（情况二）onPause()——&gt;onStop()——&gt;<Process Killed><br>（情况三）onPause()——&gt;onStop()——&gt;onDestroy()</p>
<p>每一个活动（ Activity ）都处于某一个状态，对于开发者来说，是无法控制其应用程序处于某一个状态的，这些均由系统来完成。但是当一个活动的状态发生改变的时候，开发者可以通过调用 onXX()的方法获取到相关的通知信息。</p>
<p>在实现 Activity 类的时候，通过覆盖（ override ）这些方法即可在你需要处理的时候来调用。</p>
<p>1、onCreate ：当活动第一次启动的时候，触发该方法，可以在此时完成活动的初始化工作。 onCreate 方法有一个参数，该参数可以为空( null )，也可以是之前调用 onSaveInstanceState()方法保存到存储设备中的数据。</p>
<p>2、onStart ：该方法在 onCreate() 方法之后被调用，或者在 Activity 从 Stop 状态转换为 Active 状态时被调用。该方法的触发表示所属活动将被展现给用户。</p>
<p>3、onResume ：当一个活动和用户发生交互的时候，触发该方法。在 Activity 从 Pause 状态转换到 Active 状态时被调用。</p>
<p>4、onPause ：当一个正在前台运行的活动因为其他的活动需要前台运行而转入后台运行的时候，触发该方法。这时候需要将活动的状态持久化，比如正在编辑的数据库记录等。</p>
<p>5、onStop：当一个活动不再需要展示给用户的时候，触发该方法。如果内存紧张，系统会直接结束这个活动，而不会触发 onStop 方法。 所以保存状态信息是应该在onPause时做，而不是onStop时做。活动如果没有在前台运行，都将被停止或者Linux管理进程为了给新的活动预留足够的存储空间而随时结束这些活动。因此对于开发者来说，在设计应用程序的时候，必须时刻牢记这一原则。在一些情况下，onPause方法或许是活动触发的最后的方法，因此开发者需要在这个时候保存需要保存的信息。</p>
<p>6、onRestart ：当处于停止状态的活动需要再次展现给用户的时候，触发该方法。</p>
<p>7、onDestroy ：当活动销毁的时候，触发该方法。和onStop方法一样，如果内存紧张，系统会直接结束这个活动而不会触发该方法。</p>
<p>8、onSaveInstanceState ：系统调用该方法，允许活动保存之前的状态，比如说在一串字符串中的光标所处的位置等。 通常情况下，开发者不需要重写覆盖该方法，在默认的实现中，已经提供了自动保存活动所涉及到的用户界面组件的所有状态信息。</p>
<h2 id="三、Activity栈"><a href="#三、Activity栈" class="headerlink" title="三、Activity栈"></a>三、Activity栈</h2><p>Android 是通过一种 Activity 栈的方式来管理 Activity 的，一个 Activity 的实例的状态决定它在栈中的位置。处于前台的 Activity 总是在栈的顶端，当前台的 Activity 因为异常或其它原因被销毁时，处于栈第二层的 Activity 将被激活，上浮到栈顶。当新的 Activity 启动入栈时，原 Activity 会被压入到栈的第二层。一个 Activity 在栈中的位置变化反映了它在不同状态间的转换。Activity 的状态与它在栈中的位置关系如下图所示：</p>
<p><img src="/img/ActivityStack.jpg" alt="ActivityStack.jpg"></p>
<p>每个Activity的状态是由它在Activity栈（是一个后进先出LIFO，包含所有正在运行Activity的队列）中的位置决定的。</p>
<p>一个应用程序的优先级是受最高优先级的Activity影响的。当决定某个应用程序是否要终结去释放资源，Android内存管理使用栈来决定基于Activity的应用程序的优先级。</p>
<p><img src="/img/ActivityStack2.jpg" alt="ActivityStack2.jpg"></p>
<h2 id="四、Activity的加载模式以及区别"><a href="#四、Activity的加载模式以及区别" class="headerlink" title="四、Activity的加载模式以及区别"></a>四、Activity的加载模式以及区别</h2><p>在Android的多Activity开发中，Activity之间的跳转可能需要有多种方式，有时是普通的生成一个新实例，有时希望跳转到原来某个Activity实例，而不是生成大量的重复的Activity。加载模式便是决定以哪种方式启动一个跳转到原来某个Activity实例。</p>
<p>在Android里，有4种Activity的启动模式，分别为：</p>
<p>1、标准模式standard：一调用startActivity()方法就会产生一个新的实例。</p>
<p>2、singleTop:如果已经有一个实例位于Activity栈的顶部时，就不产生新的实例，而只是调用Activity中的newInstance()方法。如果不位于栈顶，会产生一个新的实例。</p>
<p>3、singleTask: 会在一个新的task中产生这个实例，以后每次调用都会使用这个，不会去产生新的实例了。</p>
<p>4、singleInstance: 这个跟singleTask基本上是一样，只有一个区别：在这个模式下的Activity实例所处的task中，只能有这个activity实例，不能有其他的实例。</p>
<p>这些启动模式可以在功能清单文件AndroidManifest.xml中的launchMode属性进行设置。</p>
<p>相关的代码中也有一些标志可以使用,比如我们想只启用一个实例,则可以使用 Intent.FLAG_ACTIVITY_REORDER_TO_FRONT 标志，这个标志表示：如果这个activity已经启动了，就不产生新的activity，而只是把这个activity实例加到栈顶来就可以了。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intent intent =new Intent(ReorderFour.this,ReorderTwo.<span class="keyword">class</span>);  </span><br><span class="line">intent.addFlags(Intent.<span class="variable constant_">FLAG_ACTIVITY_REORDER_TO_FRONT</span>);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>

<p>四种加载模式的区别:</p>
<p>1、所属task的区别</p>
<p>一般情况下，standard和singleTop的Activity的目标task，和收到的Intent的发送者在同一个task内，就相当于谁调用它，它就跟谁在同一个Task中。</p>
<p>除非Intent包括参数FLAG_ACTIVITY_NEW_TASK。如果提供了FLAG_ACTIVITY_NEW_TASK参数，会启动到别的task里。<br>singleTask和singleInstance总是把要启动的Activity作为一个task的根元素，他们不会被启动到一个其他task里。</p>
<p>2、是否允许多个实例</p>
<p>standard和singleTop可以被实例化多次，并且是可以存在于不同的task中。这种实例化时一个task可以包括一个activity的多个实例。</p>
<p>singleTask和singleInstance则限制只生成一个实例，并且是task的根元素。</p>
<p>singleTop 要求在创建intent的时候，如果栈顶已经有要创建的Activity的实例，则将intent发送给该实例，而不创建新的实例。</p>
<p>3、是否允许其它Activity存在于本task内</p>
<p>singleInstance独占一个task，其它Activity不能存在那个task里。</p>
<p>如果它启动了一个新的Activity，不管新的Activity的launch mode如何，新的Activity都将会到别的task里运行（如同加了FLAG_ACTIVITY_NEW_TASK参数）。</p>
<p>而另外三种模式，则可以和其它activity共存。</p>
<p>4、是否每次都生成新实例</p>
<p>standard对于每一个启动Intent都会生成一个activity的新实例。</p>
<p>singleTop的Activity如果在task的栈顶的话，则不生成新的该activity的实例，直接使用栈顶的实例，否则，生成该activity的实例。</p>
<p>比如：现在task栈元素为A-B-C-D（D在栈顶），这时候给D发一个启动intent，如果D是standard的，则生成D的一个新实例，栈变为A－B－C－D－D。如果D是singleTop的话，则不会生产D的新实例，栈状态仍为A-B-C-D。</p>
<p>如果这时候给B发Intent的话，不管B的launchmode是standard还是 singleTop，都会生成B的新实例，栈状态变为A-B-C-D-B。</p>
<p>singleInstance是其所在栈的唯一Activity，它会每次都被重用。</p>
<p>singleTask如果在栈顶，则接受intent，否则，该intent会被丢弃，但是该task仍会回到前台。当已经存在的Activity实例处理新的intent时候，会调用onNewIntent()方法，如果收到intent生成一个Activity实例，那么用户可以通过back键回到上一个状态；如果是已经存在的一个Activity来处理这个intent的话，用户不能通过按back键返回到这之前的状态。</p>
<h2 id="五、Activity-之间通信"><a href="#五、Activity-之间通信" class="headerlink" title="五、Activity 之间通信"></a>五、Activity 之间通信</h2><p>在 Android 中，不同的Activity实例可能运行在一个进程中，也可能运行在不同的进程中。因此我们需要一种特别的机制帮助我们在 Activity 之间传递消息。</p>
<p>1、使用 Intent 通信</p>
<p>Android 中通过 Intent 对象来表示一条消息，一个 Intent 对象不仅包含有这个消息的目的地，还可以包含消息的内容，这好比一封 Email，其中不仅应该包含收件地址，还可以包含具体的内容。对于一个 Intent 对象，消息“目的地”是必须的，而内容则是可选项。</p>
<p>在通过 Activity. startActivity(intent)启动另外一个 Activity 的时候，我们在 Intent 类的构造器中指定了“收件人地址”。</p>
<p>如果我们想要给“收件人”Activity 说点什么的话，那么可以通过下面这封“e-mail”来将我们消息传递出去：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Intent intent =new Intent(CurrentActivity.this,OtherActivity.<span class="keyword">class</span>);</span><br><span class="line"> <span class="regexp">//</span> 创建一个带“收件人地址”的 email </span><br><span class="line">Bundle bundle =new Bundle();<span class="regexp">//</span> 创建 email 内容</span><br><span class="line">bundle.putBoolean(<span class="string">&quot;boolean_key&quot;</span>, <span class="literal">true</span>);<span class="regexp">//</span> 编写内容</span><br><span class="line">bundle.putString(<span class="string">&quot;string_key&quot;</span>, <span class="string">&quot;string_value&quot;</span>); </span><br><span class="line">intent.putExtra(<span class="string">&quot;key&quot;</span>, bundle);<span class="regexp">//</span> 封装 email </span><br><span class="line">startActivity(intent);<span class="regexp">//</span> 启动新的 Activity</span><br></pre></td></tr></table></figure>

<p>那么“收件人”该如何收信呢？在 OtherActivity类的 onCreate()或者其它任何地方使用下面的代码就可以打开这封“e-mail”阅读其中的信息：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent intent =getIntent();<span class="regexp">//</span> 收取 email </span><br><span class="line">Bundle bundle =intent.getBundleExtra(<span class="string">&quot;key&quot;</span>);<span class="regexp">//</span> 打开 email </span><br><span class="line">bundle.getBoolean(<span class="string">&quot;boolean_key&quot;</span>);<span class="regexp">//</span> 读取内容</span><br><span class="line">bundle.getString(<span class="string">&quot;string_key&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>上面我们通过 bundle对象来传递信息，bundle维护了个 HashMap&lt;String, Object&gt;对象，将我们的数据存贮在这个 HashMap 中来进行传递。但是像上面这样的代码稍显复杂，因为 Intent 内部为我们准备好了一个 bundle，所以我们也可以使用这种更为简便的方法：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent intent =new Intent(<span class="variable constant_">EX06</span>.this,OtherActivity.<span class="keyword">class</span>); </span><br><span class="line">intent.putExtra(<span class="string">&quot;boolean_key&quot;</span>, <span class="literal">true</span>); </span><br><span class="line">intent.putExtra(<span class="string">&quot;string_key&quot;</span>, <span class="string">&quot;string_value&quot;</span>); </span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intent intent=getIntent(); </span><br><span class="line">intent.getBooleanExtra(<span class="string">&quot;boolean_key&quot;</span>,<span class="literal">false</span>); </span><br><span class="line">intent.getStringExtra(<span class="string">&quot;string_key&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>2、使用 SharedPreferences</p>
<p>SharedPreferences 使用 xml 格式为 Android 应用提供一种永久的数据存贮方式。对于一个 Android 应用，它存贮在文件系统的 &#x2F;data&#x2F; data&#x2F;your_app_package_name&#x2F;shared_prefs&#x2F;目录下，可以被处在同一个应用中的所有 Activity 访问。Android 提供了相关的 API 来处理这些数据而不需要程序员直接操作这些文件或者考虑数据同步问题。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/<span class="regexp">/ 写入 SharedPreferences </span></span><br><span class="line"><span class="regexp">SharedPreferences preferences = getSharedPreferences(&quot;name&quot;, MODE_PRIVATE); </span></span><br><span class="line"><span class="regexp">Editor editor = preferences.edit(); </span></span><br><span class="line"><span class="regexp">editor.putBoolean(&quot;boolean_key&quot;, true); </span></span><br><span class="line"><span class="regexp">editor.putString(&quot;string_key&quot;, &quot;string_value&quot;); </span></span><br><span class="line"><span class="regexp">editor.commit(); </span></span><br><span class="line"><span class="regexp">       </span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 读取 SharedPreferences </span></span><br><span class="line"><span class="regexp">SharedPreferences preferences = getSharedPreferences(&quot;name&quot;, MODE_PRIVATE); </span></span><br><span class="line"><span class="regexp">preferences.getBoolean(&quot;boolean_key&quot;, false); </span></span><br><span class="line"><span class="regexp">preferences.getString(&quot;string_key&quot;, &quot;default_value&quot;);</span></span><br></pre></td></tr></table></figure>

<p>3、其它方式</p>
<p>Android 提供了包括 SharedPreferences 在内的很多种数据存贮方式，比如 SQLite，文件等，程序员可以通过这些 API 实现 Activity 之间的数据交换。如果必要，我们还可以使用 IPC 方式。</p>
<h2 id="六、Activity-的-Intent-Filter"><a href="#六、Activity-的-Intent-Filter" class="headerlink" title="六、Activity 的 Intent Filter"></a>六、Activity 的 Intent Filter</h2><p>Intent Filter 描述了一个组件愿意接收什么样的 Intent 对象，Android 将其抽象为 android.content.IntentFilter 类。在 Android 的 AndroidManifest.xml 配置文件中可以通过 <intent-filter >节点为一个 Activity 指定其 Intent Filter，以便告诉系统该 Activity 可以响应什么类型的 Intent。</p>
<p>当程序员使用 startActivity(intent) 来启动另外一个 Activity 时，如果直接指定 intent 对象的 Component 属性，那么 Activity Manager 将试图启动其 Component 属性指定的 Activity。否则 Android 将通过 Intent 的其它属性从安装在系统中的所有 Activity 中查找与之最匹配的一个启动，如果没有找到合适的 Activity，应用程序会得到一个系统抛出的异常。Activity中Intent Filter 的匹配过程如下：</p>
<p><img src="/img/ActivityIntentFilter.jpg" alt="ActivityIntentFilter.jpg"></p>
<p>1、Action 匹配<br>Action 是一个用户定义的字符串，用于描述一个 Android 应用程序组件，一个 Intent Filter 可以包含多个 Action。在 AndroidManifest.xml 的 Activity 定义时可以在其 <intent-filter >节点指定一个 Action 列表用于标示 Activity 所能接受的“动作”，例如：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> &lt;intent-filter &gt; </span><br><span class="line"> &lt;action <span class="symbol">android:</span>name=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt; </span><br><span class="line"> &lt;action <span class="symbol">android:</span>name=<span class="string">&quot;com.cyw.myaction&quot;</span> /&gt; </span><br><span class="line">……</span><br><span class="line"> &lt;<span class="regexp">/intent-filter&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果我们在启动一个 Activity 时使用这样的 Intent 对象：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent intent =new Intent(); </span><br><span class="line">intent.setAction(<span class="string">&quot;com.cyw.myaction&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>那么所有的 Action 列表中包含了“com.cyw.myaction”的 Activity 都将会匹配成功。<br>Android 预定义了一系列的 Action 分别表示特定的系统动作。这些 Action 通过常量的方式定义在 android.content. Intent中，以“ACTION_”开头。我们可以在 Android 提供的文档中找到它们的详细说明。</p>
<p>2、URI 数据匹配</p>
<p>一个 Intent 可以通过 URI 携带外部数据给目标组件。在 <intent-filter >节点中，通过 <data/>节点匹配外部数据。<br>mimeType 属性指定携带外部数据的数据类型，scheme 指定协议，host、port、path 指定数据的位置、端口、和路径。如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;data <span class="symbol">android:</span>mimeType=<span class="string">&quot;mimeType&quot;</span> <span class="symbol">android:</span>scheme=<span class="string">&quot;scheme&quot;</span> </span><br><span class="line"><span class="symbol">android:</span>host=<span class="string">&quot;host&quot;</span> <span class="symbol">android:</span>port=<span class="string">&quot;port&quot;</span> <span class="symbol">android:</span>path=<span class="string">&quot;path&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>

<p>如果在 Intent Filter 中指定了这些属性，那么只有所有的属性都匹配成功时 URI 数据匹配才会成功。</p>
<p>3、Category 类别匹配<br><intent-filter >节点中可以为组件定义一个 Category 类别列表，当 Intent 中包含这个列表的所有项目时 Category 类别匹配才会成功。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item"> YalesonChan </span><span class="level-item">19 minutes read (About 2829 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/24/2016-04-04-Android-Service/">Service on Android</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Service是Android组件中最基本也是最为常见用的四大组件之一。</p>
<p>service可以在和多场合的应用中使用，比如播放多媒体的时候用户启动了其他Activity这个时候程序要在后台继续播放，比如检测SD卡上文件的变化，再或者在后台记录你地理信息位置的改变等等，总之服务嘛，总是藏在后头的。</p>
<p>Service是在一段不定的时间运行在后台，不和用户交互应用组件。每个Service必须在manifest中通过<service>来声明。可以通过contect.startservice和contect.bindserverice来启动。</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/newcj/archive/2011/05/30/2061370.html">Service</a>和其他的应用组件一样，运行在进程的主线程中。这就是说如果service需要很多耗时或者阻塞的操作，需要在其子线程中实现。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li>Service的生命周期及启动模式</li>
<li>Service的分类</li>
<li>Service与Thread的区别</li>
<li>Service的优先级</li>
</ol>
<h2 id="一、Service的生命周期及启动模式"><a href="#一、Service的生命周期及启动模式" class="headerlink" title="一、Service的生命周期及启动模式"></a>一、Service的生命周期及启动模式</h2><p><img src="/img/ServiceLoop.png" alt="ServiceLoop.png"></p>
<p>1、使用context.startService() 启动Service是会会经历：<br>context.startService() -&gt;onCreate()- &gt;onStart()-&gt;Service running<br>context.stopService()  -&gt;onDestroy() -&gt;Service stop</p>
<p>startService的时候，如果Service还没有运行，则android先调用onCreate()然后调用onStart()；如果Service已经运行，则只调用onStart()，所以一个Service的onStart方法可能会重复调用多次。</p>
<p>stopService的时候，直接onDestroy，如果是调用者自己直接退出而没有调用stopService的话，Service会一直在后台运行。该Service的调用者再启动起来后可以通过stopService关闭Service。</p>
<p>2、使用使用context.bindService()启动Service会经历：<br>context.bindService()-&gt;onCreate()-&gt;onBind()-&gt;Service running<br>onUnbind() -&gt; onDestroy() -&gt;Service stop</p>
<p>onBind将返回给客户端一个IBind接口实例，IBind允许客户端回调服务的方法，比如得到Service运行的状态或其他操作。这个时候把调用者（Context，例如Activity）会和Service绑定在一起，Context退出了，Srevice就会调用onUnbind-&gt;onDestroy相应退出。</p>
<p>所以调用bindService的生命周期为：onCreate –&gt; onBind(只一次，不可多次绑定) –&gt; onUnbind –&gt; onDestory。</p>
<p>在Service每一次的开启关闭过程中，只有onStart可被多次调用(通过多次startService调用)，其他onCreate，onBind，onUnbind，onDestory在一个生命周期中只能被调用一次。</p>
<p>3、被启动startService又被绑定bindService的服务的生命周期：如果一个Service又被启动又被绑定，则该Service将会一直在后台运行。并且不管如何调用，onCreate始终只会调用一次，对应startService调用多少次，Service的onStart便会调用多少次。</p>
<p>此时，Service 的终止，需要unbindService与stopService同时调用，才能终止 Service，不管 startService 与 bindService 的调用顺序，如果先调用 unbindService 此时服务不会自动终止，再调用 stopService 之后服务才会停止，如果先调用 stopService 此时服务也不会终止，而再调用 unbindService 或者 之前调用 bindService 的 Context 不存在了（如Activity 被 finish 的时候）之后服务才会自动停止；</p>
<p>4、启动service，根据onStartCommand的返回值不同，有两个附加的模式：<br>1)START_STICKY 用于显示启动和停止service。<br>2)START_NOT_STICKY或START_REDELIVER_INTENT用于有命令需要处理时才运行的模式。</p>
<p>startService与bindService的区别：<br>1、使用startService()方法启用服务，调用者与服务之间没有关连，即使调用者退出了，服务仍然运行。<br>如果打算采用Context.startService()方法启动服务，在服务未被创建时，系统会先调用服务的onCreate()方法，接着调用onStart()方法。</p>
<p>如果调用startService()方法前服务已经被创建，多次调用startService()方法并不会导致多次创建服务，但会导致多次调用onStart()方法。</p>
<p>采用startService()方法启动的服务，只能调用Context.stopService()方法结束服务，服务结束时会调用onDestroy()方法。</p>
<p>2、使用bindService()方法启用服务，调用者与服务绑定在了一起，调用者一旦退出，服务也就终止，大有“不求同时生，必须同时死”的特点。<br>onBind()只有采用Context.bindService()方法启动服务时才会回调该方法。该方法在调用者与服务绑定时被调用，当调用者与服务已经绑定，多次调用Context.bindService()方法并不会导致该方法被多次调用。</p>
<p>采用Context.bindService()方法启动服务时只能调用onUnbind()方法解除调用者与服务解除，服务结束时会调用onDestroy()方法。</p>
<p>在什么情况下使用 startService 或 bindService 或 同时使用startService 和 bindService?</p>
<p>1、如果你只是想要启动一个后台服务长期进行某项任务那么使用 startService 便可以了。</p>
<p>2、如果你想要与正在运行的 Service 取得联系，那么有两种方法，一种是使用 broadcast ，另外是使用 bindService .</p>
<p>1)broadcast 的缺点是如果交流较为频繁，容易造成性能上的问题，并且 BroadcastReceiver 本身执行代码的时间是很短的（也许执行到一半，后面的代码便不会执行）</p>
<p>2)bindService 则没有这些问题，因此我们肯定选择使用 bindService（这个时候你便同时在使用 startService 和 bindService 了，这在 Activity 中更新 Service 的某些运行状态是相当有用的）。</p>
<p>3、如果你的服务只是公开一个远程接口，供连接上的客服端（android 的 Service 是C&#x2F;S架构）远程调用执行方法。这个时候你可以不让服务一开始就运行，而只用 bindService ，这样在第一次 bindService 的时候才会创建服务的实例运行它，这会节约很多系统资源，特别是如果你的服务是Remote Service，那么该效果会越明显（当然在 Service 创建的时候会花去一定时间，你应当注意到这点）。</p>
<p>另外注意的是，当在旋转手机屏幕的时候，当手机屏幕在“横”“竖”变换时，此时如果你的 Activity 如果会自动旋转的话，旋转其实是 Activity 的重新创建，因此旋转之前的使用 bindService 建立的连接便会断开（Context 不存在了），对应服务的生命周期与上述相同。</p>
<h2 id="二、Service的分类"><a href="#二、Service的分类" class="headerlink" title="二、Service的分类"></a>二、Service的分类</h2><p>按运行地点分类：</p>
<p><img src="/img/ServiceL.png" alt="ServiceL.png"></p>
<p>其实remote服务还是很少见的，并且一般都是系统服务。</p>
<p>按运行类型分类：</p>
<p><img src="/img/ServiceQ.png" alt="ServiceQ.png"></p>
<p>有同学可能会问，后台服务我们可以自己创建 ONGOING 的 Notification 这样就成为前台服务吗？答案是否定的，前台服务是在做了上述工作之后需要调用 startForeground （ android 2.0 及其以后版本 ）或 setForeground （android 2.0 以前的版本）使服务成为 前台服务。这样做的好处在于，当服务被外部强制终止掉的时候，ONGOING 的 Notification 任然会移除掉。</p>
<p>按使用方式分类：</p>
<p><img src="/img/ServiceW.png" alt="ServiceW.png"></p>
<h2 id="三、Service与Thread的区别"><a href="#三、Service与Thread的区别" class="headerlink" title="三、Service与Thread的区别"></a>三、Service与Thread的区别</h2><p>很多时候，你可能会问，为什么要用 Service，而不用 Thread 呢，因为用 Thread 是很方便的，比起 Service 也方便多了，下面来解释一下。</p>
<p>1、Thread：Thread 是程序执行的最小单元，它是分配CPU的基本单位。可以用 Thread 来执行一些异步的操作。</p>
<p>2、Service：Service 是android的一种机制，当它运行的时候如果是Local Service，那么对应的 Service 是运行在主进程的 main 线程上的。如：onCreate，onStart 这些函数在被系统调用的时候都是在主进程的 main 线程上运行的。如果是Remote Service，那么对应的 Service 则是运行在独立进程的 main 线程上。因此请不要把 Service 理解成线程，它跟线程半毛钱的关系都没有！</p>
<p>既然这样，那么为什么要用 Service 呢？</p>
<p>其实这跟 android 的系统机制有关，我们先拿 Thread 来说。Thread 的运行是独立于 Activity 的，也就是说当一个 Activity 被 finish 之后，如果你没有主动停止 Thread 或者 Thread 里的run 方法没有执行完毕的话，Thread 也会一直执行。因此这里会出现一个问题：当 Activity 被 finish 之后，你不再持有该 Thread 的引用。另一方面，你没有办法在不同的 Activity 中对同一Thread 进行控制。</p>
<p>举个例子：如果你的 Thread 需要不停地隔一段时间就要连接服务器做某种同步的话，该 Thread 需要在 Activity 没有start的时候也在运行。这个时候当你 start 一个 Activity 就没有办法在该 Activity 里面控制之前创建的 Thread。因此你便需要创建并启动一个 Service ，在 Service 里面创建、运行并控制该 Thread，这样便解决了该问题（因为任何 Activity 都可以控制同一 Service，而系统也只会创建一个对应 Service 的实例）。</p>
<p>因此你可以把 Service 想象成一种消息服务，而你可以在任何有 Context 的地方调用 Context.startService、Context.stopService、Context.bindService，Context.unbindService，来控制它。你也可以在 Service 里注册 BroadcastReceiver，在其他地方通过发送 broadcast 来控制它，当然这些都是 Thread 做不到的。</p>
<h2 id="四、Service的优先级"><a href="#四、Service的优先级" class="headerlink" title="四、Service的优先级"></a>四、Service的优先级</h2><p>拥有service的进程具有较高的优先级。只要在该service已经被启动(start)或者客户端连接(bindService)到它，Android系统会尽量保持拥有service的进程运行。当内存不足时，需要保持拥有service的进程。</p>
<p>1、如果service正在调用onCreate,onStartCommand或者onDestory方法，那么用于当前service的进程则变为前台进程以避免被killed。</p>
<p>2、如果当前service已经被启动(start)，拥有它的进程则比那些用户可见的进程优先级低一些，但是比那些不可见的进程更重要，这就意味着service一般不会被killed.</p>
<p>3、如果客户端已经连接到service(bindService),那么拥有Service的进程则拥有最高的优先级，可以认为service是可见的。</p>
<p>4、如果service可以使用startForeground(int, Notification)方法来将service设置为前台状态，那么系统就认为是对用户可见的，不会在内存不足时killed。</p>
<p>5、如果有其他的应用组件作为Service,Activity等运行在相同的进程中，那么将会增加该进程的重要性。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item"> YalesonChan </span><span class="level-item">40 minutes read (About 6058 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/24/2016-04-09-Android-HotFix/">Android热修复方案</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>当一个App发布之后，突然发现了一个严重bug需要进行紧急修复，这时候公司各方就会忙得焦头烂额：重新打包App、测试、向各个应用市场和渠道换包、提示用户升级、用户下载、覆盖安装。有时候仅仅是为了修改了一行代码，也要付出巨大的成本进行换包和重新发布。</p>
<p>这时候就提出一个问题：有没有办法以补丁的方式动态修复紧急Bug，不再需要重新发布App，不再需要用户重新下载，覆盖安装？</p>
<p>虽然Android系统并没有提供这个技术，但是很幸运的告诉大家，答案是：可以，热补丁动态修复技术可以解决以上这些问题。</p>
<p>对于热修复方案，当前市场有四种解决方案，分别是 Xposed、AndFix、ClassLoader、Proxy&#x2F;Delegate。前两个是阿里开源的框架，第三个是QQ空间团队想出的对策。在我看来，前两个方案的思路是极其相似的，都是想要通过指针替换掉出Bug的方法、类，不同的是Xposed将需要替换的方法连接到hookedMethodCallback，以他来实现替换后方法的调配，而AndFix就比较简洁粗暴了，直接就是获取需要替换的方法指针，将指针指向修改之后的新的java代码；相比之下，ClassLoader方案便较为巧妙的多了，他巧妙利用了BaseDexClassLoader的机制，类似于dex分包技术。Proxy&#x2F;Delegate的方案则是使用ProxyApplication动态加载主程序dex。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li>Xposed</li>
<li>AndFix</li>
<li>ClassLoader</li>
<li>基于Proxy&#x2F;Delegate</li>
<li>四种方案的比较</li>
<li>基于以上四种方案的开源框架以及比较</li>
</ol>
<h2 id="一、Xposed"><a href="#一、Xposed" class="headerlink" title="一、Xposed"></a>一、Xposed</h2><p>大体上的原理是：</p>
<p>1、首先，我们来理解一个概念——Zygote进程。</p>
<p>在Android系统中，每一个应用程序都是由Zygote进程进行孵化出来的。Zygote进程是由init进程创建而成。Zygote在启动时候，创建了一个Davlik虚拟机实例，每当Zygote进程创建孵化出一个应用程序进程时，都会将这个Daclik虚拟机实例进行拷贝一份，拷贝到新创建的应用程序进程之中，从而使得每一个应用程序进程都有一个独立的Dalvik虚拟机实例。</p>
<p>这样看来，Zygote进程就犹如一个盛产的孕妇，每生产一个孩子，也就是应用程序进程，都会给孩子先打疫苗（拷贝一份Davlik虚拟机实例到应用程序之中），让孩子们能够正常的健康成长。</p>
<p>Zygote进程在启动的过程中，除了会创建一个Dalvik虚拟机实例之外，还会将Java运行时库加载到进程中来，以及注册一些Android核心类的JNI方法来前面创建的Dalvik虚拟机实例中去。注意，一个应用程序进程被Zygote进程孵化出来的时候，不仅会获得Zygote进程中的Dalvik虚拟机实例拷贝，还会与Zygote一起共享Java运行时库。这也就是可以将XposedBridge这个jar包（Xposed的关键jar包）加载到每一个Android应用程序中的原因。XposedBridge有一个私有的Native方法hookMethodNative，这个方法也在app_process中使用。这个函数提供一个方法对象利用Java的Reflection机制来对内置方法覆写。</p>
<p>2、接着，我们再来看看Xposed的关键思想Hook。</p>
<p>Hook的中文翻译是，挂钩、钓钩，比较形象。那么它要用来钓哪一条鱼的呢？根据不同的鱼，我们以便准备不同的鱼饵。</p>
<p>所以，在Android系统启动时候Zygote进程加载的XposedBridge jar包，就有了用武之地。在XposedBridge之中有一个私有的方法——hookMethodNative，它将一个方法作为输入参数并且改变Dalvik虚拟机中对于该方法的定义。它将该方法的类型改变为native并且将这个方法的实现链接到它的本地的通用类的方法。</p>
<p>在hookMethodNative的实现中，会调用XposedBridge中的handleHookedMethod这个方法来传递参数。而这个方法，我们可以称之为鱼竿。它将一个方法对象，也就是我们需要替换的方法或者类，作为输入参数，当然，你可以使用java的反射几只来获取这个方法，不过，这个方法对象，这个输入参数就是我们说的“鱼饵”了，根据鱼饵，我们使用鱼竿，便可以钓起我们想要钓起的大鱼。而大鱼便是所要hook的方法对象Method的指针。得到所需要替换的Method指针之后，因为我们的目的是要替换有bug的方法。所以，我们将得到的指针链接到hookedMethodCallback上面去，并设置该Method指向替换成为的方法，以便hookedMethodCallback可以获取真正期望执行的java方法。</p>
<p>现在所有被hook的方法，都指向了hookedMethodCallback的c方法中，然后在此方法中实现调用替换成为的java方法。</p>
<p>handleHookedMethod这个方法类似于一个统一调度的Dispatch任务分派例程，其对应的底层的C++函数是xposedCallHandler。而handleHookedMethod实现里面会根据一个全局结构hookedMethodCallbacks来选择相应的hook函数，并调用他们的before, after函数。</p>
<p>那么，hook的具体过程是：</p>
<p>1、首先通过DexClassloader（这个会在ClassLoader部分具体说明）来加载所要hook的方法，分析类后，进c++层，拿到要hook的Method类，然后在handleHookedMethod中，通过dvmslotTomethod方法获取所要替换的Method*指针。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Method* method = dvmSlotToMethod(declaredClass, slot);</span><br></pre></td></tr></table></figure>

<p>declaredClass就是所hook方法所在的类，对应的object。slot是Method类中，描述此java对象在vm中的索引；那么通过这个方法，我们就获取了c层的Method指针</p>
<p>2、将该方法标记为一个native方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SET_METHOD_FLAG</span>(method, <span class="variable constant_">ACC_NATIVE</span>);</span><br></pre></td></tr></table></figure>

<p>3、重定向该方法到hookedMethodCallback，这样当被hook的java方法执行时，就会调到c层的hookedMethodCallback方法。通过meth-&gt;nativeFunc重定向MethodCallBridge到hookedMethodCallback这个方法上，控制这个c++指针是无视java的private的。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method-&gt;nativeFunc = &amp;hookedMethodCallback;</span><br></pre></td></tr></table></figure>

<p>另外，在method结构体中有</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method-&gt;insns = (const u2*) hookInfo;</span><br></pre></td></tr></table></figure>

<p>用insns指向替换成为的方法，以便hookedMethodCallback可以获取真正期望执行的java方法。<br>现在所有被hook的方法，都指向了hookedMethodCallbackc方法中，然后在此方法中实现调用替换成为的java方法。</p>
<p>3、优点</p>
<p>1）无需重启就可以达到修复bug的目的</p>
<p>2）多个模块可同时进行安装</p>
<p>3）无需修改任何的APK</p>
<p>4、缺点</p>
<p>1）需要Android 的root权限</p>
<p>2）Dexposed不支持Art模式（5.0+），且写补丁有点困难，需要反射写混淆后的代码，粒度太细，要替换的方法多的话，工作量会比较大。
 </p>
<h2 id="二、AndFix"><a href="#二、AndFix" class="headerlink" title="二、AndFix"></a>二、AndFix</h2><p>1、AndFix的原理就是方法的替换，把有bug的方法替换成补丁文件中的方法。 </p>
<p><img src="/img/1.png" alt="1.png"></p>
<p>注：在Native层使用指针替换的方式替换bug方法，以达到修复bug的目的。</p>
<p>使用AndFix修复热修复的整体流程：</p>
<p><img src="/img/2.png" alt="2.png"></p>
<p>AndFix，我觉得是阿里开源的自动化程度比较高的热修复框架了。因为你发现，框架、工具已经可以做到帮你查找修改前修改后类的不同，并能够将之打包成为对应的补丁。开发人员所要负责的不过是对于Bug的修改而已。</p>
<p><img src="/img/3.png" alt="3.png"></p>
<p>修复补丁的具体过程是：</p>
<p>1）我们及时修复好bug之后，我们可以apkpatch工具将两个apk做一次对比，然后找出不同的部分。可以看到生成的apatch了文件。若果这个时候，我们把后缀改成zip再解压开，里面有一个dex文件。反编译之后查看一下源码，里面就是被修复的代码所在的类文件,这些更改过的类都加上了一个_CF的后缀，并且变动的方法都被加上了一个叫@MethodReplace的annotation，通过clazz和method指定了需要替换的方法。</p>
<p>2）客户端得到补丁文件后就会根据annotation来寻找需要替换的方法。从AndFixManager.fix方法开始，客户端找到对应的需要替换的方法，然后在fix方法的具体实现中调用fixClass方法进行方法替换过程。</p>
<p>3）由JNI层完成方法的替换。fixClass方法遍历补丁class里的方法，在jni层对所需要替换的方法进行一一替换。关键代码如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void replaceMethod(ClassLoader classLoader, String clz, String meth, Method method) &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    String key = clz + <span class="string">&quot;@&quot;</span> + classLoader.toString();</span><br><span class="line">    Class&lt;<span class="string">?&gt;</span> clazz = mFixedClass.get(key);</span><br><span class="line">    <span class="keyword">if</span> (clazz == null) &#123;<span class="regexp">//</span> <span class="keyword">class</span> <span class="keyword">not</span> load</span><br><span class="line">      /<span class="regexp">/ 要被替换的class</span></span><br><span class="line"><span class="regexp">      Class&lt;?&gt; clzz = classLoader.loadClass(clz);</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 这里也很黑科技，通过C层，改写accessFlags，把需要替换的类的所有方法（Field）改成了public，具体可以看Method结构体</span></span><br><span class="line"><span class="regexp">      clazz = AndFix.initTargetClass(clzz);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    if (clazz != null) &#123;/</span><span class="regexp">/ initialize class OK</span></span><br><span class="line"><span class="regexp">      mFixedClass.put(key, clazz);</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 需要被替换的函数</span></span><br><span class="line"><span class="regexp">      Method src = clazz.getDeclaredMethod(meth, method.getParameterTypes());</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 这里是调用了jni，art和dalvik分别执行不同的替换逻辑，在cpp进行实现</span></span><br><span class="line"><span class="regexp">      AndFix.addReplaceMethod(src, method);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125; catch (Exception e) &#123;</span></span><br><span class="line"><span class="regexp">    Log.e(TAG, &quot;replaceMethod&quot;, e);</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<p>2、优点</p>
<p>1）可以多次打补丁。如果本地保存了多个补丁，那么AndFix会按照补丁生成的时间顺序加载补丁。具体是根据.apatch文件中的PATCH.MF的字段Created-Time。</p>
<p>2）安全性</p>
<p>readme提示开发者需要验证下载过来的apatch文件的签名是否就是在使用apkpatch工具时使用的签名，如果不验证那么任何人都可以制作自己的apatch文件来对你的APP进行修改。<br>但是我看到AndFix已经做了验证，如果补丁文件的证书和当前apk的证书不是同一个的话，就不能加载补丁。<br>官网还有一条，提示需要验证optimize file的指纹，应该是为了防止有人替换掉本地保存的补丁文件，所以要验证MD5码，然而SecurityChecker类里面也已经做了这个工作。。但是这个MD5码是保存在sharedpreference里面，如果手机已经root那么还是可以被访问的。</p>
<p>3）不需要重启APP即可应用补丁。</p>
<p>3、缺点</p>
<p>1）不支持YunOS<br>2）无法添加新类和新的字段<br>3）需要使用加固前的apk制作补丁，但是补丁文件很容易被反编译，也就是修改过的类源码容易泄露<br>4）使用加固平台可能会使热补丁功能失效<br>5）无法添加类和字段</p>
<h2 id="三、ClassLoader"><a href="#三、ClassLoader" class="headerlink" title="三、ClassLoader"></a>三、ClassLoader</h2><p>其实我更希望将之称之为MutilDex方案，因为他是基于谷歌的MutilDex项目思想而来，dex拆分是其核心。</p>
<p>1、ClassLoader的原理</p>
<p>首先，在说到这个方案的原理的时候，我们需要先了解一下Android的ClassLoader体系</p>
<p><img src="/img/4.png" alt="4.png"></p>
<p>由上图可以看出，在叶子节点上，我们能使用到的是DexClassLoader和PathClassLoader，这也是Android中加载类一般使用到的。</p>
<p>首先看下这两个类的区别：</p>
<p>对于PathClassLoader，从文档上的注释来看：</p>
<blockquote>
<p>Provides a simple {@link ClassLoader} implementation that operates on a list of files and directories in the local file system, but does not attempt to load classes from the network. Android uses this class for its system class loader and for its application class loader(s).</p>
</blockquote>
<p>Android是使用这个类作为其系统类和应用类的加载器,只能去加载已经安装到Android系统中的apk文件。</p>
<p>对于DexClassLoader，依然看下注释：</p>
<blockquote>
<p>A class loader that loads classes from {@code .jar} and {@code .apk} files containing a {@code classes.dex} entry. This can be used to execute code not installed as part of an application.</p>
</blockquote>
<p>可以用来从.jar和.apk类型的文件内部加载classes、dex文件。可以用来执行非安装的程序代码。Android应用就是用它来加载;</p>
<p>那这两个ClassLoader有与我们的热修复有什么联系？</p>
<p>好吧，我们先来看看代码吧：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/<span class="regexp">/BaseDexClassLoader:  </span></span><br><span class="line"><span class="regexp">@Override  </span></span><br><span class="line"><span class="regexp">protected Class&lt; ?&gt; findClass(String name) throws ClassNotFoundException &#123;  </span></span><br><span class="line"><span class="regexp">    List&lt;Throwable&gt; suppressedExceptions = new ArrayList&lt;Throwable&gt;(); </span></span><br><span class="line"><span class="regexp">    Class c = pathList.findClass(name, suppressedExceptions);  </span></span><br><span class="line"><span class="regexp">    if (c == null) &#123;  </span></span><br><span class="line"><span class="regexp">        ClassNotFoundException cnfe = new ClassNotFoundException(&quot;Didn&#x27;t find class \&quot;&quot; + name + &quot;\&quot; on path: &quot; + pathList);  </span></span><br><span class="line"><span class="regexp">        for (Throwable t : suppressedExceptions) &#123;  </span></span><br><span class="line"><span class="regexp">            cnfe.addSuppressed(t);  </span></span><br><span class="line"><span class="regexp">       &#125;  </span></span><br><span class="line"><span class="regexp">    throw cnfe;  </span></span><br><span class="line"><span class="regexp">    &#125;  </span></span><br><span class="line"><span class="regexp">    return c;  </span></span><br><span class="line"><span class="regexp">&#125; </span></span><br><span class="line"><span class="regexp"></span></span><br></pre></td></tr></table></figure>

<p>由上述函数可知，当我们需要加载一个class时，实际是从pathList中去需要的，查阅源码，发现pathList是DexPathList类的一个实例。好，接着去分析DexPathList类中的findClass函数。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> public Class findClass(String name, List&lt;Throwable&gt; suppressed) &#123;      </span><br><span class="line"> 	<span class="keyword">for</span> (Element element : dexElements) &#123;  </span><br><span class="line">       DexFile dex = element.dexFile;  </span><br><span class="line">        <span class="keyword">if</span> (dex != null) &#123;  </span><br><span class="line">            Class clazz = dex.loadClassBinaryName(name, definingContext, suppressed);  </span><br><span class="line">            <span class="keyword">if</span> (clazz != null) &#123;  </span><br><span class="line">                <span class="keyword">return</span> clazz;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">   &#125;  </span><br><span class="line">    <span class="keyword">if</span> (dexElementsSuppressedExceptions != null) &#123;  </span><br><span class="line">        suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> null;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>那么我们开始有点头绪了。我们在使用类的时候，会让PathClassLoader或者DexClassLoader对该类进行类加载。而加载的过程就是，遍历一个装在dex文件（每个dex文件实际上是一个DexFile对象）的数组（Element数组，Element是一个内部类），然后依次去加载所需要的class文件，直到找到为止。</p>
<p>BaseDexClassLoader中有个pathList对象，pathList中包含一个DexFile的集合dexElements，而对于类加载，就是遍历这个集合，通过DexFile去寻找。一个ClassLoader可以包含多个dex文件，每个dex文件是一个Element，多个dex文件排列成一个有序的数组dexElements，当找类的时候，会按顺序遍历dex文件，然后从当前遍历的dex文件中找类，如果找类则返回，如果找不到从下一个dex文件继续查找。</p>
<p>而这里面就正好让我们有机可乘。对，也就是理论上，如果在不同的dex中有相同的类存在，那么会优先选择排在前面的dex文件的类，如下图：</p>
<p><img src="/img/5.png" alt="5.png"></p>
<p>在此基础上，我们觉得可以用来作为热补丁的方案。把有问题的类打包到一个dex（patch.dex）中去，然后把这个dex插入到Elements的最前面，这样，在类加载的过程中便会优先加载补丁包中dex的类，如下图：</p>
<p><img src="/img/6.png" alt="6.png"></p>
<p>嗯，原理大致就是这样。</p>
<p>但是，在实现过程中，我们还会遇到一个CLASS_ISPREVERIFIED问题。</p>
<p>什么是CLASS_ISPREVERIFIED问题？</p>
<p>首先我们来看看一下代码：</p>
<p><img src="/img/7.png" alt="7.png"></p>
<p>这段代码是dex转化成odex(dexopt)的代码中的一段，我们知道当一个apk在安装的时候，apk中的classes.dex会被虚拟机(dexopt)优化成odex文件，然后才会拿去执行。</p>
<p>虚拟机在启动的时候，会有许多的启动参数，其中一项就是verify选项，当verify选项被打开的时候，上面doVerify变量为true，那么就会执行dvmVerifyClass进行类的校验，如果dvmVerifyClass校验类成功，那么这个类会被打上CLASS_ISPREVERIFIED的标志。这样看来，打上CLASS_ISPREVERIFIED其实是Android的一种性能优化方式。</p>
<p>那么具体的校验过程是什么样子的呢？<br>此代码在DexVerify.cpp中，如下：</p>
<p><img src="/img/8.png" alt="8.png"></p>
<p>概括一下就是如果以上方法中直接引用到的类（第一层级关系，不会进行递归搜索）和clazz都在同一个dex中的话，那么这个类就会被打上CLASS_ISPREVERIFIED。</p>
<p>而被打上CLASS_ISPREVERIFIED之后，在ClassLoader加载与需要修改类相关的相关类时候，却发现他们两个却不是来自于同一个dex的，这个时候就会抛出异常了。</p>
<p>所以我们接下要做的就是阻止相关类被打上CLASS_ISPREVERIFIED标记。</p>
<p>一般采用的方案是往所有类的构造函数里面插入了一段代码，代码如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ClassVerifier.<span class="variable constant_">PREVENT_VERIFY</span>) &#123;</span><br><span class="line">	System.out.println(AntilazyLoad.<span class="keyword">class</span>);<span class="regexp">//</span>需要修改的类</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，需要与修改的类以及其相关类，在进行校验的时候，因为修改后的类所在的dex与原来的dex不同，也就是与相关类的dex不同，这样，他们就不会被打上CLASS_ISPREVERIFIED了。</p>
<p>为了实现以上操作，QQ空间采用了javassist动态代码注入。用javassist将这个类在编译打包的过程中插入到目标类中。</p>
<p>大致的流程是：在dx工具执行之前，将LoadBugClass.class文件呢，进行修改，再其构造中添加System.out.println(dodola.hackdex.AntilazyLoad.class)，然后继续打包的流程。注意：AntilazyLoad.class这个类是独立在hack.dex中。</p>
<p>总结下，其实我们需要做的就是两件事：</p>
<p>1、动态改变BaseDexClassLoader对象间接引用的dexElements；</p>
<p>2、在app打包的时候，阻止相关类去打上CLASS_ISPREVERIFIED标志。所有与该类相关的类都需要进行动态注入，可进行修改，也是需要进行fix的对象。</p>
<h2 id="四、基于Proxy-x2F-Delegate"><a href="#四、基于Proxy-x2F-Delegate" class="headerlink" title="四、基于Proxy&#x2F;Delegate"></a>四、基于Proxy&#x2F;Delegate</h2><p>当项目有加壳子,插件化或热修复等需求的时候,可以使用Proxy&#x2F;Delegate Application框架的方式。</p>
<p>在正常的模式中,一个程序一般只有一个Application入口,而Proxy&#x2F;Delegate模式中需要有两个Application,原程序的Application改为Delegate Application,再新加一个Proxy Application,由Proxy Application 提供一系列的个性化定制,再将所有的context和context相关的引用全部转化为Delegate Application的实例,让外界包括Delegate Application自身都以为该App的Application入口就是Delegate Application.</p>
<p>采用的是Proxy&#x2F;Delegate Application框架。</p>
<p>主要实现的流程:</p>
<p>1、替换主程序dex文件为代理启动程序的dex文件</p>
<p>2、代理启动程序启动后,动态加载主程序dex</p>
<p>3、ProxyApplication替换消除本身Context引用为MyApplication</p>
<p>4、启动主程序的Application.</p>
<p>经过上述的步骤处理,由于程序启动dex只是一个代理,而主程序的dex是动态加载的,所以就可以达到不升级主程序不更改版本号只升级dex文件来修复线上紧急bug的目的.</p>
<h2 id="五、四种方案的比较"><a href="#五、四种方案的比较" class="headerlink" title="五、四种方案的比较"></a>五、四种方案的比较</h2><ol>
<li>Xposed方法生成补丁难度较大，需要反射写混淆后的代码，粒度太细，如果替换方法很多的话，工作量巨大。</li>
<li>AndFix支持2.3 - 6.0系统，但JNI不像JAVA那样标准，所以偶尔会有未知的机型异常。从实现来说，类似Xposed，通过JNI来替代方法，更加简洁的完成补丁修复，应用PATCH不需要重启。但由于实现上直接跳过了类初始化，设置为初始化完毕，所以静态函数、静态成员、构造函数都会出现问题，复杂的类Class.forName很可能直接崩溃。</li>
<li>ClassLoader方案支持2.3 - 6.0系统，对启动速度会有略微影响，而且只能下次启动生效。</li>
<li>Proxy&#x2F;Delegate方案，对于dex的要求比较高，如果DEx文件较为庞大，启动速度会变慢。</li>
</ol>
<p>相比而言，ClassLoader方案较为可靠，但是如果Dex文件较为庞大，启动速度会变慢；而AndFix则适用于应用不重启即可修复，且方法够简单；Xposed方案较为复杂，暂不考虑。</p>
<h2 id="六、基于以上四种方案的开源框架以及比较"><a href="#六、基于以上四种方案的开源框架以及比较" class="headerlink" title="六、基于以上四种方案的开源框架以及比较"></a>六、基于以上四种方案的开源框架以及比较</h2><p>1、Dexpost：</p>
<p>1）原理：在底层虚拟机运行时hoop方法； </p>
<p>2）缺点：适配方面存在一些问题，目前不支持android6.0，5,1；art运行时； </p>
<p>3）优点：无需重启就可以达到修复bug的目的；</p>
<p>2、AndFix：</p>
<p>1）原理：在Native层使用指针替换的方法替换bug方法，达到修复bug的目的；</p>
<p>2）缺点：</p>
<p>底层替换，稳定性方面可能需要实际检测； </p>
<p>不支持YunOS；</p>
<p>无法添加新类和新的字段；</p>
<p>需要使用加固前的apk制作补丁，但是补丁文件很容易被反编译，也就是修改过的类源码容易泄露；</p>
<p>使用加固平台可能会使热补丁功能失效；</p>
<p>无法添加类和字段；</p>
<p>3）优点：无需中期就可以达到修复bug的目的；</p>
<p>3、HotFix：</p>
<p>1）原理：通过替换类加载器中bugclass，达到修复bug的目的；</p>
<p>2）缺点：需要重新启动才可以修复bug； </p>
<p>3）优点：java运行层修复，稳定性较好；</p>
<p>4、Nuwa：</p>
<p>1）原理：通过替换类加载器中bugclass，达到修复bug的目的； </p>
<p>2）缺点：需要重新启动才可以修复bug； </p>
<p>3）优点：java运行层修复，稳定性较好；自动化热修复</p>
<p>5、DroidFix：</p>
<p>1）原理：通过替换类加载器中bugclass，达到修复bug的目的；</p>
<p>2）缺点：需要重新启动才可以修复bug； </p>
<p>3）优点：java运行层修复，稳定性较好；</p>
<p>6、dynamic-load-apk</p>
<p>1）缺点：不支持Service和BroadcastReceiver；迁移成本高，需要修改插件，插件app需要继承自proxyActivity</p>
<p>2）优点: 插件无需安装host即可吊起；支持R访问插件资源；插件支持Activity和FragmentActivity；基本无反射调用；插件安装后任可独立运行</p>
<p>7、Droid Plugin</p>
<p>1）缺点：无法使用自定义资源的通知；法注册一些特殊Intent Filter的组件（四大组件）；对Native支持不好</p>
<p>2）优点：插件无需任何修改，可独立安装运行，也可以做插件运行；四大组件无需在Host程序注册；超强隔离性，不同插件运行在不同的进程中；资源完全隔离；实现进程管理，插件的空进程会被及时回收，占用内存低；插件的静态广播会被当作动态处理，如果插件没有运行，静态广播永远不会触发；API侵入性低</p>
<p>8、DynamicAPK</p>
<p>1）优点：<br>迁移成本低（无需做任何activity&#x2F;fragment&#x2F;resource的proxy实现）不使用代理来管理插件的activity&#x2F;fragment的生命周期。修改后aapt会处理插件种的资源，R.java中的资源引用和普通Android工程没有区别，开发者可以保持原有的开发规范；</p>
<p>更加有利于并发开发；</p>
<p>提升编译速度；</p>
<p>提升启动速度。</p>
<p>2）缺点：</p>
<p>dex解压、dexopt、加载耗时较长，使用按需加载启动时间过长</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item"> YalesonChan </span><span class="level-item">25 minutes read (About 3823 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/24/2016-05-08-Tencent-Offer/">不只是三面</a></h1><div class="content"><p>前天，5月6号收到腾讯offer通知的时候，感到终于松了一口气。为了这个offer我也是跑了不少地方了，也可以很清晰的看得到这一两年来的变化。两个月的风尘，也可以暂时停下了。</p>
<p>回顾这次的能够得到腾讯的offer，我只有一句话可以总结：</p>
<p>这个offer，不只是只有三面。</p>
<h2 id="缘由"><a href="#缘由" class="headerlink" title="缘由"></a>缘由</h2><p>关于腾讯，我是面过了好多次了，不管是内推，还是说正常流程，都有参与过，但是那时候还是初出茅庐，对于面试还是不得要领，一直弄得很是不顺。心中虽有不甘，但是，却也没有想过说放弃任何一次机会。尤其是大三下了，虽说已经有了offer在身，却还是想要去尝试一番。</p>
<p>于是，当森然给我提及到，这次腾讯在找长沙站实习生招聘的志愿者的时候，我立马给腾讯这次长沙站的HR发了个邮件自荐。恰好，仿佛是命运眷顾，这位HR正是，我去年大二的时候，也是差不多这个时候腾讯霸面时候认识的中南的学长，那时候他是刚进入腾讯帮忙招聘。那时候虽然霸面没成功（其实霸面确实比正常流程的难，不过不失是一次机会），但是最大的收获是认识了学长满哥。就这样，我成了这次长沙站的志愿者。</p>
<p>而后，便又给学长投了一份简历。</p>
<p>真的很感谢满哥，真的很热心，因为不知道是什么原因，我的简历被卡在了内推二面环节，当时的面试官没有释放我的简历，导致我无法进行正常流程，霸面也不行，而感谢满哥能够不厌其烦的为我跟那个面试官沟通，释放简历，给了我一次、也是实习生招聘的最后一次面试机会。很是宝贵。</p>
<h2 id="初试"><a href="#初试" class="headerlink" title="初试"></a>初试</h2><p>因为我是志愿者，在长沙站的这一周的招聘里面，我是有工作需要做的，没有多少时间准备。不过庆幸的是，以前的面试经验给了我很大的帮助，而且在工作之余，我热心的跟来面试来霸面的同学交流搭讪，能够感觉到大家都是很厉害的人，也能够更加体会到，作为面试官，作为一家公司，他们需要的会是一位怎样的员工。</p>
<p>那是第一天招聘的下午，轮到我去面试了。换班、上楼。很奇怪，没有很紧张，估计是在此之前了解的比较清楚了，舌头也说开了吧。具体面试的问题不是太记得清楚了。但是记得面试官问的大多是我的项目的问题，自己也对项目做足了功课的，所以没有太难。不过，面的时间有点短，感觉没有尽情的展示了自己的清楚，所以对结果有点紧张。<br>之后在志愿者工作的时候，我又几次遇到初试官下来拿简历或是拿饭，很开心，便跟他搭上话来。其实面试官真的很好说话的。</p>
<p>当天晚上，没有收到通知，状态也没有变化。</p>
<p>次日下午，再次刷微信查询的时候，终于状态变成了复试，自己一个人在走道上跟疯了似的，又蹦又跳的。</p>
<p><img src="/img/interview2.png" alt="interview2.png"></p>
<h2 id="复试"><a href="#复试" class="headerlink" title="复试"></a>复试</h2><p>收到复试通知后，当晚，我开始有点像高考复习一样，复习我所知道的知识点，尤其是数据结构中的树、图，算法导论中的排序、查找、分治、动态规划等等，博客（写博客真的是很重要，不论是在复习的时候，还是在面试的时候，因为面试的时候你可以直接展示给面试官你的成果，当然，你也要熟悉才行，最好是原创的），JVM等等。</p>
<p>我有做笔记的习惯，在以前的面试的时候，我还专门列了下自己所能够展示的知识点、加分项。所以，这次的复试准备的算是很充足了。</p>
<p>但是，剧情确实曲折的，我没想到的是，在一开始复试官便给了我一道完全没有思考过的问题（也是自己作死，在自我介绍的时候给自己挖了个坑）：C原因中，相同的Int，一个赋值为0，一个赋值为500，这两个Int有什么区别。这个真是没有回答的很好，但是，我说了下自己的理解。</p>
<p>之后，给了我一道题，手写代码。这道题的思路是很简单的一道需要排序的二分查找。虽然简单，但花了点时间，想用归并排序，出了问题。这也是我这次面试觉得最大的遗憾的地方。</p>
<p>这个时候了，我是有点方了。面试官人很好，也没有问多少我的技术方卖弄的问题了。开始问我，为什么选择腾讯，为什么想要做这个岗位，有什么想要问他的这样的问题。</p>
<p>虽然已经知道这位复试官面试的时候大多在20分钟左右，但没想到这么快就抛出了这个问题，我心想这是要悬。所以，在回答之后的这些问题的时候，我努力表现自己的诚意，也表现出自己在腾讯之后的职业发展，自己的目标明确，这几年的经历以及努力。最后又表示自己对这次面试的态度，说，自己对这次面试是不满意的，不管是第一个问题，还是拿到手写代码，都不是自己满意的，说自己一直在写《剑指offer》的试题，并上传到了自己的github上面了，也在经营分享自己的微信公众号。</p>
<p>复试官显然是感受到了我的执着。于是看了下我的初试官的评语，提了到我的初试官也问过的问题，也是我写过的一篇博客探讨过的问题——Android 的热修复方案。一道题，仿佛找到突破口一般，我开始沿着我的思路，把Android热修复的四大方案讲完，有发散到JVM以及GC算法上面了，思路清晰，有条有理。</p>
<p>还没等讲完，复试官便直接给了我通过的回复。真的，我整个人是飘着下来的，一直怀疑自己是不是听错了。因为我能够感觉到自己这么久来的努力在被肯定了。一扫前几天来的不顺。</p>
<p>当晚，我的状态变成了HR面。</p>
<p><img src="/img/interviewHR.png" alt="interviewHR.png"></p>
<h2 id="HR面"><a href="#HR面" class="headerlink" title="HR面"></a>HR面</h2><p>虽说，HR面是不怎么刷人了，但是鉴于武汉站的时候，那么多的HR面被刷的前车之鉴，我还是google了下，仔细准备HR面。其实也不是很知道如何准备，主要是需要放松心态，把HR当做是同事朋友，大家坐在一起聊一聊自己的经历看法见解。</p>
<p>这次是涛哥面我，因为之前在志愿者工作的时候，便与涛哥坐在一起吃过饭，了解到涛哥是一个很会聊天的人，所以，不是很紧张。跟涛哥聊得很开心，而且之后我发现，我的面试估计都可以称之为典范了吧，因为所有要问的问题我都被问了，其他人没有被问的我也被问了。</p>
<p>这次HR面，我可以说也是知道是通过了的。</p>
<p>所以，当次日刷状态的时候，我的状态改变了。</p>
<p><img src="/img/interviewAll.png" alt="interviewAll.png"></p>
<p>但是这时，你还不能说稳了。因为这只是说你的面试过了而已，之后，关于通过者的信息会传回到腾讯总部你将要在的部门（大多是你复试官所在的部门），让部门经理审核。所以，还不能说稳了，因为之后没能得到offer的人也不是没有。</p>
<p>一周之后，我接到了腾讯打来的电话，确认offer，签约。</p>
<h2 id="关于简历"><a href="#关于简历" class="headerlink" title="关于简历"></a>关于简历</h2><p>简历真是敲门砖，是HR认识到你的第一印象。所以，简历一定要排版好，该写的写上，不会的、不熟悉的、不是十分有分量的不要写。然后简历打印不要用硬纸板打印，使用普通的纸打印就行了。<br>而面产品的，我的建议是，附上的材料不要太多，捡重要的附上，简洁明了，表达你自己的见解就行了。当然，材料在排版、色调方面最好也要注意。</p>
<h2 id="关于霸面"><a href="#关于霸面" class="headerlink" title="关于霸面"></a>关于霸面</h2><p>1、最好是停留在现场等待。虽说，腾讯招聘的时候，有专门的霸面区接收霸面简历，HR也让霸面的同学回去等待。但是综合我的所见，我发现最好还是停留在现场等待。因为HR哥哥姐姐也是过来人，都知道霸面是需要更多的勇气的，也理解霸面同学的焦急无奈的情绪，他们都是很好的人，也会想办法给你机会的。再者是，面试官面试速度是不一样的，一天的面试人数也是不一样的，有时面试官会下来拿霸面同学的简历，而在现场的同学更加有机会与面试官攀谈上，率先让他过目简历。</p>
<p>2、要灵活。关于霸面，也是需要动动脑筋的。不是说你在那儿等就行了，总会有机会的，机会也是需要争取的，运气也是需要脱颖而出的。相比于在现场傻傻等待面试机会的同学，我更加佩服的是那些不只是把眼光放于当前这场招聘的同学。一、你需要等待表现出诚意，也要表现在HR面前，让他们看到你的努力，最好是有机会能够与HR攀谈上，表现出你自己，与他们成为朋友，这是最好的结果，再不济也能够给他们留个眼熟啊。二、如果你不好意思与HR交流，毕竟还是有点尴尬的，你也可以与在场的面试的同学交流，了解了解你的对手都是一些什么样的人，大家对于面试的想法，面试官都面了什么，他们是怎么回答的，你又该怎么回答，自己有什么不足等等。而且面试现场真的也有好多的美女咧，交几个朋友总不是什么坏事。</p>
<p>3、当你觉得你已经足够勇敢的时候，其实你还需要更加的勇敢。这一点真是在霸面产品的同学身上体现的十分贴切啊。知道，面试现场的好多人都是专门从其他城市赶过来的，比如武汉、南昌、南宁，甚至是北京，很多的研究生，很多的在其他站HR面被拒的想要再抓住机会的同学，大家都是十分的努力，也是足够的勇敢的。但有时候，结果不是单单的努力就会有结果的，运气也不会一直眷顾你。这个时候，你就需要比那些好运的实力更强的又足够勇敢的变得更加勇敢才行。这次长沙站守电梯，送面试者上去面试的人是我。很多人跑来跟我说，帮忙刷他们上去，给他们一个机会。因为职责所在，没有答应。但是人不能够死脑筋，总会有办法的。很多面产品的同学，还是找到了其他办法，没有经过我，刷上去了面试官的楼层。虽然结果不是很理想，但是这是勇敢给他们制造的又多的一个机会。当然，我不是很推荐这种做法就是了，但是也是看不同面试官的。</p>
<p>4、凡事有个度。霸面是一种勇气的表现，但是需要一个度。也是这次长沙站，有个同学就多次想办法上去直接找面试官。我不知道结果如何，但是如果我是面试官，我也会觉得有点厌烦的。因为招聘就像相亲，看顺眼了，适合了自然而然就会成，自然而然就会过，不必太过于纠缠。还有就是，在霸面的过程中要有礼貌，遵守流程，不要无理取闹，听取工作人员的建议以及警惕工作人员的警告。腾讯是有一个黑名单的，无视警告的都会被计入黑名单之中。</p>
<h2 id="关于面试"><a href="#关于面试" class="headerlink" title="关于面试"></a>关于面试</h2><p>面经永远是别人的面经，最好的办法是自己亲临战场去经历去成长。在面试的时候，展示你的所能，坦然真诚坚持富有激情拥有潜力。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>最后，真的是感谢森然，感谢满哥，也感谢一起志愿服务的朋友们，也感谢自己的坚持。面试了这么多次，这次是第一次走完整个流程的，以前也没有，以前得到的offer也都是直接跟老大聊聊就成了的。整个流程下来，真的成长了不少，也涨了见识。这次是我距离腾讯offer最近的一次，还好我没有辜负满哥的期待。</p>
<p>谨以此文，记录此刻。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-24T05:34:43.614Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item"> YalesonChan </span><span class="level-item">an hour read (About 9415 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/24/2016-08-22-Java-Byte-Code/">Java字节码总结</a></h1><div class="content"><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><p><a href="#1">1. 概述</a></p>
</li>
<li><p><a href="#2">2. 举个栗子</a></p>
</li>
<li><p><a href="#3">3. Class文件结构</a></p>
</li>
<li><p><a href="#4">4. 指令</a></p>
</li>
<li><p><a href="#4.1">1)	字节码与数据类型</a></p>
</li>
<li><p><a href="#4.2">2)	加载和存储指令</a></p>
</li>
<li><p><a href="#4.3">3)	运算指令</a></p>
</li>
<li><p><a href="#4.4">4)	类型转换指令</a></p>
</li>
<li><p><a href="#4.5">5)	对象创建与访问指令</a></p>
</li>
<li><p><a href="#4.6">6)	操作数栈管理指令</a></p>
</li>
<li><p><a href="#4.7">7)	控制转移指令</a></p>
</li>
<li><p><a href="#4.8">8)	方法调用和返回指令</a></p>
</li>
<li><p><a href="#4.9">9)	异常处理指令</a></p>
</li>
<li><p><a href="#4.10">10)	同步指令</a></p>
</li>
<li><p><a href="#5">5. 再看几个栗子</a></p>
</li>
<li><p><a href="#5.1">例1</a></p>
</li>
<li><p><a href="#5.2">例2</a></p>
</li>
<li><p><a href="#5.3">例3</a></p>
</li>
</ul>
<h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a><span id="1">1. 概述</span></h2><p>学过Java的都知道，Java从一开始就打着平台无关性的旗号，说“一次编写，到处运行”，其实说到无关性，Java平台还有另外一个无关性那就是语言无关性。实现语言无关性，那么Java体系中的class文件结构或者说是字节码就显得相当重要了，其实Java从刚开始的时候就有两套规范，一个是Java语言规范，另外一个是Java虚拟机规范，Java语言规范只是规定了Java语言相关的约束以及规则，而虚拟机规范则才是真正从跨平台的角度去设计的。</p>
<p>Java代码要想执行，需要先被编译成Class文件，即使Java字节码文件，然后才能够在JVM上执行。</p>
<p>那么现在我们简单的了解下Java字节码究竟是什么。这种类汇编的指令有是如何在JVM上面执行的呢？</p>
<p>在Class文件中，Java方法里的方法体，也就是代表着一个Java源码程序中程序的部分存储在方法表集合的Code属性中。存储在Code属性中的是字节码，也就是编译后的程序。Java虚拟机的指令由两部分组成，首先是一个字节长度、代表某种含义的数字（即操作码），在操作码后面跟着零个或多个代表这个操作所需的参数（即操作数）。由于Java虚拟机采用的是面向操作数栈而不是寄存器的架构，所以大多数指令不包含操作数，只有一个操作码。</p>
<p>操作码的长度只有一个字节，这就限制了操作码的个数不超过256个。同时，Class文件格式放弃了编译后代码的操作数长度对齐，这就意味着虚拟机处理那些超过一个字节的数据时，不得不在运行时从字节中重建出具体数据的结构。比如，如果要将一个两个字节长的无符号整数使用两个无符号字节存储起来分别是byte1和byte2，那么就需要这样构造出原始的无符号整数：</p>
<pre><code>(byte1&lt;&lt;8) | byte2
</code></pre>
<p>操作数的数量以及长度，取决于操作码，若一个操作数长度超过了一个字节，将会以Big-Endian顺序存储(高位在前字节码)。</p>
<p>这样会在某种程度上导致执行字节码时损失一些性能。但这样做也有好处，那就是由于不需要对齐，省去了中间的填充与间隔符号；用一个字节来表示操作码，也是为了获得短小的编译代码。这样就尽可能的减少了编译后的代码的长度，非常适合网络传输。</p>
<p>如果不考虑异常处理的话，那么Java虚拟机的解释器可以使用下面的伪代码作为基本的执行模型来理解：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">do</span>&#123;  </span><br><span class="line">    自动计算<span class="variable constant_">PC</span>寄存器的值加<span class="number">1</span>;  </span><br><span class="line">    根据<span class="variable constant_">PC</span>寄存器的指示位置，从字节码流中取出操作码;  </span><br><span class="line">    <span class="keyword">if</span>(字节码存在操作数) 从字节码流中取出操作数;  </span><br><span class="line">    执行操作码所定义的操作;  </span><br><span class="line">&#125;<span class="keyword">while</span>(字节码长度&gt;<span class="number">0</span>);  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-举个栗子"><a href="#2-举个栗子" class="headerlink" title="2. 举个栗子"></a><span id="2">2. 举个栗子</span></h2><p>可能大家现在有点不明觉厉哦，那么咱们先上代码，看看是个什么情况。</p>
<p>首先是一个简单的在控制台打印“Hello”的Java代码，如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">SimpleClass</span> &#123;</span><br><span class="line">    public void sayHello() &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后我们使用javac  SimpleClass.java命令，编译该Java代码，生成相应的Class文件。然后，继续在终端中使用javap -verbose SimpleClass，打印Class文件中的内容。如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Classfile /<span class="symbol">C:</span>/Users/yalechen/Desktop/<span class="variable constant_">JVM</span>/Java Byte Code/samples/SimpleClass.<span class="keyword">class</span></span><br><span class="line">  <span class="title class_">Last</span> modified <span class="number">2016</span>-<span class="number">8</span>-<span class="number">16</span>; size <span class="number">400</span> bytes</span><br><span class="line">  <span class="variable constant_">MD5</span> checksum 92d47034320261dac69592f3c3e33c2e</span><br><span class="line">  Compiled from <span class="string">&quot;SimpleClass.java&quot;</span></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">SimpleClass</span></span><br><span class="line">  minor <span class="symbol">version:</span> <span class="number">0</span></span><br><span class="line">  major <span class="symbol">version:</span> <span class="number">52</span></span><br><span class="line">  <span class="symbol">flags:</span> <span class="variable constant_">ACC_PUBLIC</span>, <span class="variable constant_">ACC_SUPER</span></span><br><span class="line">Constant <span class="symbol">pool:</span></span><br><span class="line">   <span class="comment">#1 = Methodref          #6.#14         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   <span class="comment">#2 = Fieldref           #15.#16        // java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">   <span class="comment">#3 = String             #17            // Hello</span></span><br><span class="line">   <span class="comment">#4 = Methodref          #18.#19        // java/io/PrintStream.println:(Ljava/lang/String;)V</span></span><br><span class="line">   <span class="comment">#5 = Class              #20            // SimpleClass</span></span><br><span class="line">   <span class="comment">#6 = Class              #21            // java/lang/Object</span></span><br><span class="line">   <span class="comment">#7 = Utf8               &lt;init&gt;</span></span><br><span class="line">   <span class="comment">#8 = Utf8               ()V</span></span><br><span class="line">   <span class="comment">#9 = Utf8               Code</span></span><br><span class="line">  <span class="comment">#10 = Utf8               LineNumberTable</span></span><br><span class="line">  <span class="comment">#11 = Utf8               sayHello</span></span><br><span class="line">  <span class="comment">#12 = Utf8               SourceFile</span></span><br><span class="line">  <span class="comment">#13 = Utf8               SimpleClass.java</span></span><br><span class="line">  <span class="comment">#14 = NameAndType        #7:#8          // &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  <span class="comment">#15 = Class              #22            // java/lang/System</span></span><br><span class="line">  <span class="comment">#16 = NameAndType        #23:#24        // out:Ljava/io/PrintStream;</span></span><br><span class="line">  <span class="comment">#17 = Utf8               Hello</span></span><br><span class="line">  <span class="comment">#18 = Class              #25            // java/io/PrintStream</span></span><br><span class="line">  <span class="comment">#19 = NameAndType        #26:#27        // println:(Ljava/lang/String;)V</span></span><br><span class="line">  <span class="comment">#20 = Utf8               SimpleClass</span></span><br><span class="line">  <span class="comment">#21 = Utf8               java/lang/Object</span></span><br><span class="line">  <span class="comment">#22 = Utf8               java/lang/System</span></span><br><span class="line">  <span class="comment">#23 = Utf8               out</span></span><br><span class="line">  <span class="comment">#24 = Utf8               Ljava/io/PrintStream;</span></span><br><span class="line">  <span class="comment">#25 = Utf8               java/io/PrintStream</span></span><br><span class="line">  <span class="comment">#26 = Utf8               println</span></span><br><span class="line">  <span class="comment">#27 = Utf8               (Ljava/lang/String;)V</span></span><br><span class="line">&#123;</span><br><span class="line">  public SimpleClass();</span><br><span class="line">    <span class="symbol">descriptor:</span> ()V</span><br><span class="line">    <span class="symbol">flags:</span> <span class="variable constant_">ACC_PUBLIC</span></span><br><span class="line">    <span class="symbol">Code:</span></span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: invokespecial <span class="comment">#1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">      <span class="symbol">LineNumberTable:</span></span><br><span class="line">        line <span class="number">3</span>: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  public void sayHello();</span><br><span class="line">    <span class="symbol">descriptor:</span> ()V</span><br><span class="line">    <span class="symbol">flags:</span> <span class="variable constant_">ACC_PUBLIC</span></span><br><span class="line">    <span class="symbol">Code:</span></span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: getstatic     <span class="comment">#2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">         <span class="number">3</span>: ldc           <span class="comment">#3                  // String Hello</span></span><br><span class="line">         <span class="number">5</span>: invokevirtual <span class="comment">#4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span></span><br><span class="line">         <span class="number">8</span>: <span class="keyword">return</span></span><br><span class="line">      <span class="symbol">LineNumberTable:</span></span><br><span class="line">        line <span class="number">6</span>: <span class="number">0</span></span><br><span class="line">        line <span class="number">7</span>: <span class="number">8</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="symbol">SourceFile:</span> <span class="string">&quot;SimpleClass.java&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们从上往下依次解析。</p>
<ol>
<li><pre><code>首先是该Class文件的整体信息介绍，包括文件所在路径、最近修改时间、文件大小、MD5校验值、从哪个Java编译而来。接下来才是正文。
</code></pre>
</li>
<li><pre><code>我们一步一步来：
</code></pre>
</li>
</ol>
<p>1）	该类的声明</p>
<p>2）	Minor version，表示Class文件的次版本号。Major version，表示Class文件的主版本号。major_version和minor_version主要用来表示当前的虚拟机是否接受当前这种版本的Class文件。不同版本的Java编译器编译的Class文件对应的版本是不一样的。高版本的虚拟机支持低版本的编译器编译的 Class文件结构。比如Java SE 6.0对应的虚拟机支持Java SE 5.0的编译器编译的Class文件结构，反之则不行。</p>
<p>3）	Flags，是该类的一些标识，包括访问权限（public、private、protected），父类、实现的接口等等。</p>
<p>4）	Constant pool，常量池。以下的一些都是定义的常量。这个算是Java代码编译上的一种优化，把一些引用明确的变量、方法、类等，转换成直接引用。</p>
<p>在能够唯一确定方法的直接引用的时候，虚拟机会将常量表里的符号引用转换为直接引用。但是如果方法是动态绑定的，也就是说在编译期我们并不知道使用哪个方法（或者叫不知道使用方法的哪个版本），那么这个时候就需要在运行时才能确定哪个版本的方法将被调用，这个时候才能将符号引用转换为直接引用。这个问题提到的多个版本的方法在java中的重载和多态重写问题息息相关。</p>
<p>具体的定义，比如：</p>
<pre><code>#1 = Methodref          #6.#14      // java/lang/Object.&quot;&lt;init&gt;&quot;:()V
</code></pre>
<p>#1是定义的引用的别称；</p>
<p>Methodref是该引用的具体类别，还有好几种不同的类别，之后会提及；</p>
<p>#6.#14是具体的引用名称，不过此时的引用名称也是有下面定义的引用别称来表示的。后面的双斜杠注释表示对引用的解释。</p>
<p>5）	花括号中的便是SimpleClasss类的内容了。其中是一个一个的方法定义。</p>
<p>6）	public SimpleClass();这个是构造方法的声明。简直就是Java代码有没有。</p>
<p>7）	descriptor: ()V描述。()V，看到括号里面没有参数，V便是Void，所以这是个无参无返回值的方法。</p>
<p>8）	flags的含义跟跟上面提及的一样。</p>
<p>9）	code属性，表示的是方法的具体内容。</p>
<p>10）stack、locals以及args_size，读入栈深度建立符合要求的操作数栈，读入局部变量大小建立符合要求的局部变量表，根据参数个数向局部变量表中依序加入参数（第一个参数是引用当前对象的this，所以空参数列表的参数数也是1）</p>
<p>11）LineNumberTable，是指每一个java字节码指令对应java代码文件中的第几行，以方便定位。</p>
<p>12）同理，sayHello方法也是如此道理。</p>
<p>13）SourceFile，这是源代码。</p>
<p>不知大家看懂了多少，先凑合着来，慢慢理清头绪。
 </p>
<h2 id="3-Class文件结构"><a href="#3-Class文件结构" class="headerlink" title="3. Class文件结构"></a><span id="3">3. Class文件结构</span></h2><p>首先需要明确如下几点：</p>
<p>1）Class文件是由8个字节为基础的字节流构成的，这些字节流之间都严格按照规定的顺序排列，并且字节之间不存在任何空隙，对于超过8个字节的数据，将按照Big-Endian的顺序存储的，也就是说高位字节存储在低的地址上面，而低位字节存储到高地址上面，其实这也是class文件要跨平台的关键，因为 PowerPC架构的处理采用Big-Endian的存储顺序，而x86系列的处理器则采用Little-Endian的存储顺序，因此为了Class文件在各中处理器架构下保持统一的存储顺序，虚拟机规范必须对起进行统一。</p>
<p>2） Class文件结构采用类似C语言的结构体来存储数据的，主要有两类数据项，无符号数和表，无符号数用来表述数字，索引引用以及字符串等，比如u1,u2,u4,u8分别代表1个字节，2个字节，4个字节，8个字节的无符号数，而表是有多个无符号数以及其它的表组成的复合结构。</p>
<p>明确了上面的两点以后，我们接下来后来看看Class文件中按照严格的顺序排列的字节流都具体包含些什么数据：</p>
<p><img src="/img/javabytecode1.png" alt="javabytecode1.png"></p>
<p>在看上图的时候，有一点我们需要注意，比如cp_info，cp_info表示常量池，上图中用 constant_pool[constant_pool_count-1]的方式来表示常量池有constant_pool_count-1个常量，它这里是采用数组的表现形式，但是大家不要误以为所有的常量池的常量长度都是一样的，其实这个地方只是为了方便描述采用了数组的方式，但是这里并不像编程语言那里，一个int型的数组，每个int长度都一样。明确了这一点以后，我们在回过头来看看上图中每一项都具体代表了什么含义。</p>
<p>1）u4 magic 表示魔数，并且魔数占用了4个字节，魔数到底是做什么的呢？它其实就是表示一下这个文件的类型是一个Class文件，而不是一张JPG图片，或者AVI的电影。而Class文件对应的魔数是0xCAFEBABE.</p>
<p>2）u2 minor_version 表示Class文件的次版本号，并且此版本号是u2类型的无符号数表示。</p>
<p>3）u2 major_version 表示Class文件的主版本号，并且主版本号是u2类型的无符号数表示。major_version和minor_version主要用来表示当前的虚拟机是否接受当前这种版本的Class文件。不同版本的Java编译器编译的Class文件对应的版本是不一样的。高版本的虚拟机支持低版本的编译器编译的 Class文件结构。比如Java SE 6.0对应的虚拟机支持Java SE 5.0的编译器编译的Class文件结构，反之则不行。</p>
<p>4）u2 constant_pool_count 表示常量池的数量。这里我们需要重点来说一下常量池是什么东西，请大家不要与Jvm内存模型中的运行时常量池混淆了，Class文件中常量池主要存储了字面量以及符号引用，其中字面量主要包括字符串，final常量的值或者某个属性的初始值等等，而符号引用主要存储类和接口的全限定名称，字段的名称以及描述符，方法的名称以及描述符，这里名称可能大家都容易理解，至于描述符的概念，放到下面说字段表以及方法表的时候再说。另外大家都知道Jvm的内存模型中有堆，栈，方法区，程序计数器构成，而方法区中又存在一块区域叫运行时常量池，运行时常量池中存放的东西其实也就是编译器长生的各种字面量以及符号引用，只不过运行时常量池具有动态性，它可以在运行的时候向其中增加其它的常量进去，最具代表性的就是String的intern方法。</p>
<p>5）cp_info 表示常量池，这里面就存在了上面说的各种各样的字面量和符号引用。放到常量池的中数据项在The Java Virtual Machine Specification Java SE 7 Edition 中一共有14个常量，每一种常量都是一个表，并且每种常量都用一个公共的部分tag来表示是哪种类型的常量。</p>
<p>下面分别简单描述一下具体细节等到后面的实例中我们再细化。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">CONSTANT_Utf8_info      tag标志位为<span class="number">1</span>,   <span class="variable constant_">UTF</span>-<span class="number">8</span>编码的字符串</span><br><span class="line"></span><br><span class="line">CONSTANT_Integer_info  tag标志位为<span class="number">3</span>，整形字面量</span><br><span class="line"></span><br><span class="line">CONSTANT_Float_info     tag标志位为<span class="number">4</span>，浮点型字面量</span><br><span class="line"></span><br><span class="line">CONSTANT_Long_info     tag标志位为<span class="number">5</span>，长整形字面量</span><br><span class="line"></span><br><span class="line">CONSTANT_Double_info  tag标志位为<span class="number">6</span>，双精度字面量</span><br><span class="line"></span><br><span class="line">CONSTANT_Class_info    tag标志位为<span class="number">7</span>，类或接口的符号引用</span><br><span class="line"></span><br><span class="line">CONSTANT_String_info    tag标志位为<span class="number">8</span>，字符串类型的字面量</span><br><span class="line"></span><br><span class="line">CONSTANT_Fieldref_info  tag标志位为<span class="number">9</span>,  字段的符号引用</span><br><span class="line"></span><br><span class="line">CONSTANT_Methodref_info  tag标志位为<span class="number">10</span>，类中方法的符号引用</span><br><span class="line"></span><br><span class="line">CONSTANT_InterfaceMethodref_info tag标志位为<span class="number">11</span>, 接口中方法的符号引用</span><br><span class="line"></span><br><span class="line">CONSTANT_NameAndType_info tag 标志位为<span class="number">12</span>，字段和方法的名称以及类型的符号引用</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可参考下图。</p>
<p><img src="/img/javabytecode2.png" alt="javabytecode2.png"></p>
<p>而这是在Java字节码中常出现的各种常量类型的字符描述符：</p>
<p><img src="/img/javabytecode3.png" alt="javabytecode3.png"></p>
<p>6）u2 access_flags 表示类或者接口的访问信息，具体如下图所示：</p>
<p><img src="/img/javabytecode4.png" alt="javabytecode4.png"></p>
<p>7）u2 this_class 表示类的常量池索引，指向常量池中CONSTANT_Class_info的常量</p>
<p>8）u2 super_class 表示超类的索引，指向常量池中CONSTANT_Class_info的常量</p>
<p>9）u2 interface_counts 表示接口的数量</p>
<p>10）u2 interface[interface_counts]表示接口表，它里面每一项都指向常量池中CONSTANT_Class_info常量</p>
<p>11）u2 fields_count 表示类的实例变量和类变量的数量</p>
<p>12）field_info fields[fields_count]表示字段表的信息，其中字段表的结构如下图所示：</p>
<p><img src="/img/javabytecode5.png" alt="javabytecode5.png"></p>
<p>上图中access_flags表示字段的访问表示，比如字段是public,private，protect 等，name_index表示字段名称，指向常量池中类型是CONSTANT_UTF8_info的常量，descriptor_index表示字段的描述符，它也指向常量池中类型为 CONSTANT_UTF8_info的常量，attributes_count表示字段表中的属性表的数量，而属性表是则是一种用与描述字段，方法以及类的属性的可扩展的结构，不同版本的Java虚拟机所支持的属性表的数量是不同的。</p>
<p><img src="/img/javabytecode6.png" alt="javabytecode6.png"></p>
<p>13）u2 methods_count表示方法表的数量</p>
<p>14）method_info 表示方法表，方法表的具体结构如下图所示：</p>
<p><img src="/img/javabytecode7.png" alt="javabytecode7.png"></p>
<p>其中access_flags表示方法的访问表示，name_index表示名称的索引，descriptor_index表示方法的描述符，attributes_count以及attribute_info类似字段表中的属性表，只不过字段表和方法表中属性表中的属性是不同的，比如方法表中就Code属性，表示方法的代码，而字段表中就没有Code属性。Code属性的结构如下图：</p>
<p><img src="/img/javabytecode8.png" alt="javabytecode8.png"></p>
<p>attribute_name_index指向常量池中值为Code的常量；</p>
<p>attribute_length表示Code属性表的长度（这里需要注意的时候长度不包括attribute_name_index和attribute_length的6个字节的长度）；</p>
<p>max_stack表示最大栈深度，虚拟机在运行时根据这个值来分配栈帧中操作数的深度，而max_locals代表了局部变量表的存储空间；</p>
<p>max_locals的单位为slot，slot是虚拟机为局部变量分配内存的最小单元，在运行时，对于不超过32位类型的数据类型，比如 byte,char,int等占用1个slot，而double和Long这种64位的数据类型则需要分配2个slot，另外max_locals的值并不是所有局部变量所需要的内存数量之和，因为slot是可以重用的，当局部变量超过了它的作用域以后，局部变量所占用的slot就会被重用；</p>
<p>code_length代表了字节码指令的数量，而code表示的时候字节码指令，从上图可以知道code的类型为u1,一个u1类型的取值为0x00-0xFF,对应的十进制为0-255，目前虚拟机规范已经定义了200多条指令；</p>
<p>exception_table_length以及exception_table分别代表方法对应的异常信息；</p>
<p>attributes_count和attribute_info分别表示了Code属性中的属性数量和属性表，从这里可以看出Class的文件结构中，属性表是很灵活的，它可以存在于Class文件，方法表，字段表以及Code属性中。</p>
<p>15） attribute_count表示属性表的数量，说到属性表，我们需要明确以下几点：</p>
<ul>
<li><p>属性表存在于Class文件结构的最后，字段表，方法表以及Code属性中，也就是说属性表中也可以存在属性表</p>
</li>
<li><p>属性表的长度是不固定的，不同的属性，属性表的长度是不同的</p>
</li>
</ul>
<p>16）LineNumberTable，用于描述java源代码的行号和字节码行号的对应关系，它不是运行时必需的属性，如果通过-g:none的编译器参数来取消生成这项信息的话，最大的影响就是异常发生的时候，堆栈中不能显示出出错的行号，调试的时候也不能按照源代码来设置断点，接下来我们再看一下LineNumberTable的结构如下图所示：</p>
<p><img src="/img/javabytecode9.png" alt="javabytecode9.png"></p>
<p>其中attribute_name_index表示常量池的索引，attribute_length表示属性长度，而start_pc和 line_number分表表示字节码的行号和源代码的行号。</p>
<p>17）SourceFile，SourceFile的结构如下图所示：</p>
<p><img src="/img/javabytecode10.png" alt="javabytecode10.png"></p>
<p>其中attribute_length为属性的长度，sourcefile_index指向常量池中值为源代码文件名称的常量。</p>
<h2 id="4-指令"><a href="#4-指令" class="headerlink" title="4. 指令"></a><span id="4">4. 指令</span></h2><p>以下是具体使用到的Java字节码指令集。</p>
<h3 id="1-字节码与数据类型"><a href="#1-字节码与数据类型" class="headerlink" title="1)	字节码与数据类型"></a><span id="4.1">1)	字节码与数据类型</span></h3><p>在Java虚拟机的指令集中，大多数的指令都包含了操作所对应的数据类型信息。比如iload指令表示从局部变量表中加载int型数据到操作数栈中，而fload表示加载float类型的数据。不过，这两条指令再虚拟机的内部可能是由同一段代码来实现的，但在class文件中必须有自己的操作码。</p>
<p>我们已经知道Java指令的长度只有一个字节，这就限制了指令集的大小。如果每个指令都像上面两个指令那样包含所有的数据类型，那么就有可能导致指令过多。因此，Java虚拟机的指令集对于特定的操作只提供了有限的类型相关指令去支持它。比如，大多数指令没有支持整数类型byte、char和short，甚至没有指令支持boolean类型。</p>
<p>这些指令中都有特殊的字符来表示专门支持的类型：i代表int类型，l代表long，s代表short，b代表byte，c代表char，f代表float，d代表double，a代表Reference。</p>
<p>这里仅仅介绍一下指令的种类以及作用，并不会过多的介绍各个指令的含义以及使用，需要的话可以查看《Java虚拟机规范（Java SE 7版）》。</p>
<h3 id="2-加载和存储指令"><a href="#2-加载和存储指令" class="headerlink" title="2)	加载和存储指令"></a><span id="4.2">2)	加载和存储指令</span></h3><p>加载指令用于将局部变量表中的数据传送到操作数栈中，而存储指令用于将操作数栈中的结果传送到局部变量表中。这类指令包括如下几种：</p>
<p>将一个局部变量加载到操作栈，比如iload、iload<n>、fload、fload<n>、lload、lload<n>、dload、dload<n>、aload、aload<n>；</p>
<p>将一个数值从操作数栈存储到局部变量表，比如istore、istore<n>、lstore、lstore<n>、fstore、fstore<n>、dstore、dstore<n>、astore、astore<n>；</p>
<p>将一个常量加载到操作数栈，比如bipush、sipush、ldc、ldc_w、ldc2_w、aconst_null、iconst_ml、iconst_<i>、lconst_<l>、fconst_<f>、dconst_<d>；</p>
<p>扩充局部变量表的访问索引的指令：wide；</p>
<p>上面中带尖括号的指令实际是一组指令。比如iload<n>，代表了iload_1、iload_2和iload_3。这几组指令是某个带操作数的指令（比如iload）的特殊形式，它们省略了操作数，不过操作数隐含在指令中。</p>
<h3 id="3-运算指令"><a href="#3-运算指令" class="headerlink" title="3)	运算指令"></a><span id="4.3">3)	运算指令</span></h3><p>运算或算术指令用于对一个或两个操作数栈上的值进行某种特定的运算，并将结果存入栈顶。大体上可以分为两种，对整数进行运算的指令和对浮点数进行运算的指令。不过，由于没有支持byte、short、char和boolean的算术指令，对于这些数据的运算，会把它们转化为int类型进行运算。指令列出如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">加法指令：iadd、ladd、fadd、dadd；</span><br><span class="line"></span><br><span class="line">减法指令：isub、lsub、fsub、dsub；</span><br><span class="line"></span><br><span class="line">乘法指令：imul、lmul、fmul、dmul；</span><br><span class="line"></span><br><span class="line">除法指令：idiv、ldiv、fdiv、ddiv；</span><br><span class="line"></span><br><span class="line">求余指令：irem、lrem、frem、drem；</span><br><span class="line"></span><br><span class="line">取反指令：ineg、lneg、fneg、dneg；</span><br><span class="line"></span><br><span class="line">位移指令：ishl、ishr、iushr、lshl、lshr、lushr；</span><br><span class="line"></span><br><span class="line">按位或指令：ior、lor；</span><br><span class="line"></span><br><span class="line">按位与指令：iand、land；</span><br><span class="line"></span><br><span class="line">按位异或指令：ixor、lxor；</span><br><span class="line"></span><br><span class="line">局部变量自增指令：iinc；</span><br><span class="line"></span><br><span class="line">比较指令：dcmpg、dcmpl、fcmpg、fcmpl、lcmp；</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-类型转换指令"><a href="#4-类型转换指令" class="headerlink" title="4)	类型转换指令"></a><span id="4.4">4)	类型转换指令</span></h3><p>类型转换指令用来将两种不同类型进行转换，这些转换操作一般用于实现代码中的显示类型转换操作，或者前面提到的字节码指令集中数据类型相关指令无法与数据类型一一对应的问题。</p>
<p>虚拟机直接支持宽化类型转换，即小范围类型向大范围类型的安全转换，不需要显示的转换指令。</p>
<p>但是处理窄化类型转换时，必须显示使用转换指令来完成，这些指令包括：i2b、i2c、i2s、l2i、f2l、d2i、d2l和d2f。这些指令可能会导致数值的精度丢失。</p>
<h3 id="5-对象创建与访问指令"><a href="#5-对象创建与访问指令" class="headerlink" title="5)	对象创建与访问指令"></a><span id="4.5">5)	对象创建与访问指令</span></h3><p>虽然类实例和数组都是对象，但是虚拟机创建类对象和数组的指令是不同的。对象创建后，就可以通过对象访问指令获取对象实例或者数组实例中的字段或数组元素，指令如下：</p>
<p>创建类实例的指令：new；</p>
<p>创建数组的指令：newarray、anewarray、multianewarray；</p>
<p>访问类字段和实例字段的指令：getfield、putfield、getstatic、putstatic；</p>
<p>把一个数组元素加载到操作数栈的指令：baload、caload、saload、iaload、laload、faload、daload、aaload；</p>
<p>将一个操作数栈的值存储到数组元素中的指令：bastore、castore、sastore、iastore、fastore、dastore、aastore；</p>
<p>取数组长度的指令：arraylength；</p>
<p>检查类实例类型的指令：instanceof、checkcast；</p>
<h3 id="6-操作数栈管理指令"><a href="#6-操作数栈管理指令" class="headerlink" title="6)	操作数栈管理指令"></a><span id="4.6">6)	操作数栈管理指令</span></h3><p>就像操作一个普通的栈一样，Java虚拟机提供了一些用于直接操作操作数栈的指令，包括：</p>
<p>将操作数栈的栈顶一个或两个元素出栈：pop、pop2；</p>
<p>复制栈顶一个或两个数值并将复制值或双份的复制值重新压入栈顶：dup、dup2、dup_x1、dup2_x1、dup_x2、dup2_x2；</p>
<p>将栈顶最顶端的两个数值互换：swap；</p>
<h3 id="7-控制转移指令"><a href="#7-控制转移指令" class="headerlink" title="7)	控制转移指令"></a><span id="4.7">7)	控制转移指令</span></h3><p>控制转移指令可以让Java虚拟机有条件或无条件的从指定的位置指令而不是控制转移指令的下一条指令继续执行，可以理解为控制转移指令改变了PC寄存器的值。指令如下：</p>
<p>条件分支：ifeq、iflt、ifle、ifgt、ifge、ifnonnull、if_icmpeq、if_icmpne、if_icmplt、if_icmpgt、、if_icmpge、if_acmpeq和if_acmpne；</p>
<p>复合条件分支：tableswitch、lookupswitch；</p>
<p>无条件分支：goto、goto_w、jsr、jsr_w、ret；</p>
<h3 id="8-方法调用和返回指令"><a href="#8-方法调用和返回指令" class="headerlink" title="8)	方法调用和返回指令"></a><span id="1">8)	方法调用和返回指令</span></h3><p>这里仅仅列出5条用于方法调用的指令：</p>
<p>invokevirtual指令用于调用对象的实例方法，根据对象的实际类型进行分派（虚方法分派），这也是Java语言中最常见的方法分派方式；</p>
<p>invokeinterface指令用于调用接口方法，它会在运行时搜索一个实现了这个接口方法的对象，找出适合的方法进行调用；</p>
<p>invokespecial指令用于调用一些需要特殊处理的实例方法，包括实例初始化方法、私有方法和父类方法；</p>
<p>invokestatic指令用于调用类方法（static方法）；</p>
<p>invokedynamic指令用于在运行时动态解析出调用点限定符索引用的方法，并执行方法，前面4条指令的分派逻辑都固化在Java虚拟机内部，而invokedynamic指令的分派逻辑是由用户所设定的引导方法决定的；</p>
<p>方法调用指令与类型无关，但是方法返回指令是根据返回值的类型区分的，包括ireturn、lreturn、freturn、dreturn和areturn，另外还有一个return指令供声明为void的方法、实例初始化方法以及类和接口的类初始化方法使用。</p>
<h3 id="9-异常处理指令"><a href="#9-异常处理指令" class="headerlink" title="9)	异常处理指令"></a><span id="1">9)	异常处理指令</span></h3><p>在Java程序中显式抛出异常的操作（throw语句）都是由athrow指令来实现的，除了用throw语句显式抛出异常外，Java虚拟机规范还规定了许多运行时异常会在其他Java虚拟机指令检测到异常状况时自动抛出。</p>
<p>而在Java虚拟机中，处理异常（catch语句）不是由字节码指令来完成的，而是采用异常表来完成的。</p>
<h3 id="10-同步指令"><a href="#10-同步指令" class="headerlink" title="10)	同步指令"></a><span id="1">10)	同步指令</span></h3><p>Java虚拟机可以支持方法级的同步和方法内部一段指令序列的同步，这两种同步结构都是使用管程（Monitor）来支持的。</p>
<p>方法级的同步是隐式的，即不需要通过字节码指令来控制，它实现在方法调用和返回操作中。虚拟机可以从方法常量池的方法表结构中的ACC_SYNCHRONIZED访问标志得知一个方法是否声明为同步方法。当方法调用时，调用指令就会去检查方法的ACC_SYNCHRONIZED访问标志是否被设置了，如果设置，执行线程就要求持有管程。在方法执行期间，执行线程持有了管程，其他任何线程都无法再获取到同一个管程。如果一个方法在执行期间发生了异常，并在方法中无法处理此异常，那么这个同步方法所持有的管程将在异常抛出后自动释放。</p>
<p>同步一段指令集序列通常是由Java语言中的synchronized语句块表示的，Java虚拟机的指令集中有monitorenter和monitorexit指令来支持synchronized关键字的语义。正确实现synchronized关键字需要Javac编译器和Java虚拟机两者共同协作。编译器必须保证每个monitorenter指令都有对应的monitorexit指令。</p>
<h2 id="5-再看几个栗子"><a href="#5-再看几个栗子" class="headerlink" title="5. 再看几个栗子"></a><span id="5">5. 再看几个栗子</span></h2><h3 id="例1"><a href="#例1" class="headerlink" title="例1"></a><span id="5.1">例1</span></h3><p>Java源代码如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">TestDemo</span> &#123;</span><br><span class="line">    public static int minus(int x)&#123;</span><br><span class="line">        <span class="keyword">return</span> -x;</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        int x = <span class="number">5</span>;</span><br><span class="line">        int y = minus(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Javap–verbose TestDemo之后，得到Java字节码：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Classfile /<span class="symbol">C:</span>/Users/yalechen/Desktop/<span class="variable constant_">JVM</span>/Java Byte Code/samples/TestDemo/TestDemo.<span class="keyword">class</span></span><br><span class="line">  <span class="title class_">Last</span> modified <span class="number">2016</span>-<span class="number">8</span>-<span class="number">16</span>; size <span class="number">342</span> bytes</span><br><span class="line">  <span class="variable constant_">MD5</span> checksum 77ff8854473da6d63caf8a5347bb3434</span><br><span class="line">  Compiled from <span class="string">&quot;TestDemo.java&quot;</span></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">TestDemo</span></span><br><span class="line">  minor <span class="symbol">version:</span> <span class="number">0</span></span><br><span class="line">  major <span class="symbol">version:</span> <span class="number">52</span></span><br><span class="line">  <span class="symbol">flags:</span> <span class="variable constant_">ACC_PUBLIC</span>, <span class="variable constant_">ACC_SUPER</span></span><br><span class="line">Constant <span class="symbol">pool:</span></span><br><span class="line">   <span class="comment">#1 = Methodref          #4.#15         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   <span class="comment">#2 = Methodref          #3.#16         // TestDemo.minus:(I)I</span></span><br><span class="line">   <span class="comment">#3 = Class              #17            // TestDemo</span></span><br><span class="line">   <span class="comment">#4 = Class              #18            // java/lang/Object</span></span><br><span class="line">   <span class="comment">#5 = Utf8               &lt;init&gt;</span></span><br><span class="line">   <span class="comment">#6 = Utf8               ()V</span></span><br><span class="line">   <span class="comment">#7 = Utf8               Code</span></span><br><span class="line">   <span class="comment">#8 = Utf8               LineNumberTable</span></span><br><span class="line">   <span class="comment">#9 = Utf8               minus</span></span><br><span class="line">  <span class="comment">#10 = Utf8               (I)I</span></span><br><span class="line">  <span class="comment">#11 = Utf8               main</span></span><br><span class="line">  <span class="comment">#12 = Utf8               ([Ljava/lang/String;)V</span></span><br><span class="line">  <span class="comment">#13 = Utf8               SourceFile</span></span><br><span class="line">  <span class="comment">#14 = Utf8               TestDemo.java</span></span><br><span class="line">  <span class="comment">#15 = NameAndType        #5:#6          // &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  <span class="comment">#16 = NameAndType        #9:#10         // minus:(I)I</span></span><br><span class="line">  <span class="comment">#17 = Utf8               TestDemo</span></span><br><span class="line">  <span class="comment">#18 = Utf8               java/lang/Object</span></span><br><span class="line">&#123;</span><br><span class="line">  public TestDemo();</span><br><span class="line">    <span class="symbol">descriptor:</span> ()V</span><br><span class="line">    <span class="symbol">flags:</span> <span class="variable constant_">ACC_PUBLIC</span></span><br><span class="line">    <span class="symbol">Code:</span></span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: invokespecial <span class="comment">#1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V	V表示Void，()表示无参数，冒号之前表示的是方法名</span></span><br><span class="line">         <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">      <span class="symbol">LineNumberTable:</span></span><br><span class="line">        line <span class="number">3</span>: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  public static int minus(int);</span><br><span class="line">    <span class="symbol">descriptor:</span> (I)I					/<span class="regexp">/描述符描述的参数列表和返回类型.I表示int</span></span><br><span class="line"><span class="regexp">    flags: ACC_PUBLIC, ACC_STATIC			/</span><span class="regexp">/访问权限</span></span><br><span class="line"><span class="regexp">    Code:</span></span><br><span class="line"><span class="regexp">      stack=1, locals=1, args_size=1</span></span><br><span class="line"><span class="regexp">         0: iload_0					/</span><span class="regexp">/将slot0压入栈顶，也就是传入的参数</span></span><br><span class="line"><span class="regexp">         1: ineg					/</span><span class="regexp">/将栈顶的值弹出取负后压回栈顶</span></span><br><span class="line"><span class="regexp">         2: ireturn</span></span><br><span class="line"><span class="regexp">      LineNumberTable:</span></span><br><span class="line"><span class="regexp">        line 5: 0</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  public static void main(java.lang.String[]);</span></span><br><span class="line"><span class="regexp">    descriptor: ([Ljava/lang</span><span class="regexp">/String;)V</span></span><br><span class="line"><span class="regexp">    flags: ACC_PUBLIC, ACC_STATIC</span></span><br><span class="line"><span class="regexp">    Code:						/</span><span class="regexp">/确定可以访问后进入Code属性表执行命令</span></span><br><span class="line"><span class="regexp">      stack=1, locals=3, args_size=1			/</span><span class="regexp">/读入栈深度建立符合要求的操作数栈，读入局部变量大小建立符合要求的局部变量表，根据参数个数向局部变量表中依序加入参数（第一个参数是引用当前对象的this，所以空参数列表的参数数也是1）</span></span><br><span class="line"><span class="regexp">         0: iconst_5					/</span><span class="regexp">/前面 0 表示标识。将整数5压入栈顶</span></span><br><span class="line"><span class="regexp">         1: istore_1					/</span><span class="regexp">/将栈顶整数值存入局部变量表的slot1（slot0是参数this）到这为止，int x = 5;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">         2: iload_1					/</span><span class="regexp">/将slot1压入栈顶</span></span><br><span class="line"><span class="regexp">         3: invokestatic  #2                  /</span><span class="regexp">/ Method minus:(I)I		调用静态累方法minus。二进制invokestatic方法用于调用静态方法，参数是根据常量池中已经转换为直接引用的常量，意即minus函数在方法区中的地址，找到这个地址调用函数，向其中加入的参数是栈顶的值</span></span><br><span class="line"><span class="regexp">         6: istore_2					/</span><span class="regexp">/此时的栈顶元素是经过了 minus 方法处理过了的</span></span><br><span class="line"><span class="regexp">         7: return</span></span><br><span class="line"><span class="regexp">      LineNumberTable:</span></span><br><span class="line"><span class="regexp">        line 8: 0</span></span><br><span class="line"><span class="regexp">        line 9: 2</span></span><br><span class="line"><span class="regexp">        line 10: 7</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">SourceFile: &quot;TestDemo.java&quot;</span></span><br><span class="line"><span class="regexp"></span></span><br></pre></td></tr></table></figure>

<h3 id="例2"><a href="#例2" class="headerlink" title="例2"></a><span id="5.2">例2</span></h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/<span class="regexp">/测试重载机制</span></span><br><span class="line"><span class="regexp">public class TestDemo1 &#123;</span></span><br><span class="line"><span class="regexp">    static class Human&#123;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    static class Man extends Human&#123;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    static class Woman extends Human&#123;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    public void sayHello(Human human) &#123;</span></span><br><span class="line"><span class="regexp">        System.out.println(&quot;hello human&quot;);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    public void sayHello(Man man) &#123;</span></span><br><span class="line"><span class="regexp">        System.out.println(&quot;hello man&quot;);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    public void sayHello(Woman woman) &#123;</span></span><br><span class="line"><span class="regexp">        System.out.println(&quot;hello woman&quot;);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    public static void main(String[] args) &#123;</span></span><br><span class="line"><span class="regexp">        TestDemo1 demo = new TestDemo1();</span></span><br><span class="line"><span class="regexp">        Human man = new Man();</span></span><br><span class="line"><span class="regexp">        Human woman = new Woman();</span></span><br><span class="line"><span class="regexp">        demo.sayHello(man);</span></span><br><span class="line"><span class="regexp">        demo.sayHello(woman);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br></pre></td></tr></table></figure>

<p>Java字节码：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Classfile /<span class="symbol">C:</span>/Users/yalechen/Desktop/<span class="variable constant_">JVM</span>/Java Byte Code/samples/TestDemo/TestDemo1.<span class="keyword">class</span></span><br><span class="line">  <span class="title class_">Last</span> modified <span class="number">2016</span>-<span class="number">8</span>-<span class="number">16</span>; size <span class="number">883</span> bytes</span><br><span class="line">  <span class="variable constant_">MD5</span> checksum 5a1df45f23bd666f3c6c716e50265345</span><br><span class="line">  Compiled from <span class="string">&quot;TestDemo1.java&quot;</span></span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">TestDemo1</span>					/<span class="regexp">/重载</span></span><br><span class="line"><span class="regexp">  minor version: 0</span></span><br><span class="line"><span class="regexp">  major version: 52</span></span><br><span class="line"><span class="regexp">  flags: ACC_PUBLIC, ACC_SUPER</span></span><br><span class="line"><span class="regexp">Constant pool:</span></span><br><span class="line"><span class="regexp">   #1 = Methodref          #14.#32        /</span><span class="regexp">/ java/lang</span><span class="regexp">/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="regexp">   #2 = Fieldref           #33.#34        /</span><span class="regexp">/ java/lang</span><span class="regexp">/System.out:Ljava/io</span><span class="regexp">/PrintStream;</span></span><br><span class="line"><span class="regexp">   #3 = String             #35            /</span><span class="regexp">/ hello human</span></span><br><span class="line"><span class="regexp">   #4 = Methodref          #36.#37        /</span><span class="regexp">/ java/io</span><span class="regexp">/PrintStream.println:(Ljava/lang</span><span class="regexp">/String;)V</span></span><br><span class="line"><span class="regexp">   #5 = String             #38            /</span><span class="regexp">/ hello man</span></span><br><span class="line"><span class="regexp">   #6 = String             #39            /</span><span class="regexp">/ hello woman</span></span><br><span class="line"><span class="regexp">   #7 = Class              #40            /</span><span class="regexp">/ TestDemo1</span></span><br><span class="line"><span class="regexp">   #8 = Methodref          #7.#32         /</span><span class="regexp">/ TestDemo1.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="regexp">   #9 = Class              #41            /</span><span class="regexp">/ TestDemo1$Man</span></span><br><span class="line"><span class="regexp">  #10 = Methodref          #9.#32         /</span><span class="regexp">/ TestDemo1$Man.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="regexp">  #11 = Class              #42            /</span><span class="regexp">/ TestDemo1$Woman</span></span><br><span class="line"><span class="regexp">  #12 = Methodref          #11.#32        /</span><span class="regexp">/ TestDemo1$Woman.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="regexp">  #13 = Methodref          #7.#43         /</span><span class="regexp">/ TestDemo1.sayHello:(LTestDemo1$Human;)V</span></span><br><span class="line"><span class="regexp">  #14 = Class              #44            /</span><span class="regexp">/ java/lang</span><span class="regexp">/Object</span></span><br><span class="line"><span class="regexp">  #15 = Utf8               Woman</span></span><br><span class="line"><span class="regexp">  #16 = Utf8               InnerClasses</span></span><br><span class="line"><span class="regexp">  #17 = Utf8               Man</span></span><br><span class="line"><span class="regexp">  #18 = Class              #45            /</span><span class="regexp">/ TestDemo1$Human</span></span><br><span class="line"><span class="regexp">  #19 = Utf8               Human</span></span><br><span class="line"><span class="regexp">  #20 = Utf8               &lt;init&gt;</span></span><br><span class="line"><span class="regexp">  #21 = Utf8               ()V</span></span><br><span class="line"><span class="regexp">  #22 = Utf8               Code</span></span><br><span class="line"><span class="regexp">  #23 = Utf8               LineNumberTable</span></span><br><span class="line"><span class="regexp">  #24 = Utf8               sayHello</span></span><br><span class="line"><span class="regexp">  #25 = Utf8               (LTestDemo1$Human;)V</span></span><br><span class="line"><span class="regexp">  #26 = Utf8               (LTestDemo1$Man;)V</span></span><br><span class="line"><span class="regexp">  #27 = Utf8               (LTestDemo1$Woman;)V</span></span><br><span class="line"><span class="regexp">  #28 = Utf8               main</span></span><br><span class="line"><span class="regexp">  #29 = Utf8               ([Ljava/lang</span><span class="regexp">/String;)V</span></span><br><span class="line"><span class="regexp">  #30 = Utf8               SourceFile</span></span><br><span class="line"><span class="regexp">  #31 = Utf8               TestDemo1.java</span></span><br><span class="line"><span class="regexp">  #32 = NameAndType        #20:#21        /</span><span class="regexp">/ &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="regexp">  #33 = Class              #46            /</span><span class="regexp">/ java/lang</span><span class="regexp">/System</span></span><br><span class="line"><span class="regexp">  #34 = NameAndType        #47:#48        /</span><span class="regexp">/ out:Ljava/io</span><span class="regexp">/PrintStream;</span></span><br><span class="line"><span class="regexp">  #35 = Utf8               hello human</span></span><br><span class="line"><span class="regexp">  #36 = Class              #49            /</span><span class="regexp">/ java/io</span><span class="regexp">/PrintStream</span></span><br><span class="line"><span class="regexp">  #37 = NameAndType        #50:#51        /</span><span class="regexp">/ println:(Ljava/lang</span><span class="regexp">/String;)V</span></span><br><span class="line"><span class="regexp">  #38 = Utf8               hello man</span></span><br><span class="line"><span class="regexp">  #39 = Utf8               hello woman</span></span><br><span class="line"><span class="regexp">  #40 = Utf8               TestDemo1</span></span><br><span class="line"><span class="regexp">  #41 = Utf8               TestDemo1$Man</span></span><br><span class="line"><span class="regexp">  #42 = Utf8               TestDemo1$Woman</span></span><br><span class="line"><span class="regexp">  #43 = NameAndType        #24:#25        /</span><span class="regexp">/ sayHello:(LTestDemo1$Human;)V</span></span><br><span class="line"><span class="regexp">  #44 = Utf8               java/lang</span><span class="regexp">/Object</span></span><br><span class="line"><span class="regexp">  #45 = Utf8               TestDemo1$Human</span></span><br><span class="line"><span class="regexp">  #46 = Utf8               java/lang</span><span class="regexp">/System</span></span><br><span class="line"><span class="regexp">  #47 = Utf8               out</span></span><br><span class="line"><span class="regexp">  #48 = Utf8               Ljava/io</span><span class="regexp">/PrintStream;</span></span><br><span class="line"><span class="regexp">  #49 = Utf8               java/io</span><span class="regexp">/PrintStream</span></span><br><span class="line"><span class="regexp">  #50 = Utf8               println</span></span><br><span class="line"><span class="regexp">  #51 = Utf8               (Ljava/lang</span><span class="regexp">/String;)V</span></span><br><span class="line"><span class="regexp">&#123;</span></span><br><span class="line"><span class="regexp">  public TestDemo1();				/</span><span class="regexp">/构造方法</span></span><br><span class="line"><span class="regexp">    descriptor: ()V</span></span><br><span class="line"><span class="regexp">    flags: ACC_PUBLIC</span></span><br><span class="line"><span class="regexp">    Code:</span></span><br><span class="line"><span class="regexp">      stack=1, locals=1, args_size=1</span></span><br><span class="line"><span class="regexp">         0: aload_0</span></span><br><span class="line"><span class="regexp">         1: invokespecial #1                  /</span><span class="regexp">/ Method java/lang</span><span class="regexp">/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="regexp">         4: return</span></span><br><span class="line"><span class="regexp">      LineNumberTable:</span></span><br><span class="line"><span class="regexp">        line 1: 0</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  public void sayHello(TestDemo1$Human);</span></span><br><span class="line"><span class="regexp">    descriptor: (LTestDemo1$Human;)V</span></span><br><span class="line"><span class="regexp">    flags: ACC_PUBLIC</span></span><br><span class="line"><span class="regexp">    Code:</span></span><br><span class="line"><span class="regexp">      stack=2, locals=2, args_size=2</span></span><br><span class="line"><span class="regexp">         0: getstatic     #2                  /</span><span class="regexp">/ Field java/lang</span><span class="regexp">/System.out:Ljava/io</span><span class="regexp">/PrintStream;</span></span><br><span class="line"><span class="regexp">         3: ldc           #3                  /</span><span class="regexp">/ String hello human</span></span><br><span class="line"><span class="regexp">         5: invokevirtual #4                  /</span><span class="regexp">/ Method java/io</span><span class="regexp">/PrintStream.println:(Ljava/lang</span><span class="regexp">/String;)V</span></span><br><span class="line"><span class="regexp">         8: return</span></span><br><span class="line"><span class="regexp">      LineNumberTable:</span></span><br><span class="line"><span class="regexp">        line 11: 0</span></span><br><span class="line"><span class="regexp">        line 12: 8</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  public void sayHello(TestDemo1$Man);</span></span><br><span class="line"><span class="regexp">    descriptor: (LTestDemo1$Man;)V</span></span><br><span class="line"><span class="regexp">    flags: ACC_PUBLIC</span></span><br><span class="line"><span class="regexp">    Code:</span></span><br><span class="line"><span class="regexp">      stack=2, locals=2, args_size=2</span></span><br><span class="line"><span class="regexp">         0: getstatic     #2                  /</span><span class="regexp">/ Field java/lang</span><span class="regexp">/System.out:Ljava/io</span><span class="regexp">/PrintStream;</span></span><br><span class="line"><span class="regexp">         3: ldc           #5                  /</span><span class="regexp">/ String hello man</span></span><br><span class="line"><span class="regexp">         5: invokevirtual #4                  /</span><span class="regexp">/ Method java/io</span><span class="regexp">/PrintStream.println:(Ljava/lang</span><span class="regexp">/String;)V</span></span><br><span class="line"><span class="regexp">         8: return</span></span><br><span class="line"><span class="regexp">      LineNumberTable:</span></span><br><span class="line"><span class="regexp">        line 14: 0</span></span><br><span class="line"><span class="regexp">        line 15: 8</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  public void sayHello(TestDemo1$Woman);</span></span><br><span class="line"><span class="regexp">    descriptor: (LTestDemo1$Woman;)V</span></span><br><span class="line"><span class="regexp">    flags: ACC_PUBLIC</span></span><br><span class="line"><span class="regexp">    Code:</span></span><br><span class="line"><span class="regexp">      stack=2, locals=2, args_size=2</span></span><br><span class="line"><span class="regexp">         0: getstatic     #2                  /</span><span class="regexp">/ Field java/lang</span><span class="regexp">/System.out:Ljava/io</span><span class="regexp">/PrintStream;</span></span><br><span class="line"><span class="regexp">         3: ldc           #6                  /</span><span class="regexp">/ String hello woman</span></span><br><span class="line"><span class="regexp">         5: invokevirtual #4                  /</span><span class="regexp">/ Method java/io</span><span class="regexp">/PrintStream.println:(Ljava/lang</span><span class="regexp">/String;)V</span></span><br><span class="line"><span class="regexp">         8: return</span></span><br><span class="line"><span class="regexp">      LineNumberTable:</span></span><br><span class="line"><span class="regexp">        line 17: 0</span></span><br><span class="line"><span class="regexp">        line 18: 8</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  public static void main(java.lang.String[]);</span></span><br><span class="line"><span class="regexp">    descriptor: ([Ljava/lang</span><span class="regexp">/String;)V</span></span><br><span class="line"><span class="regexp">    flags: ACC_PUBLIC, ACC_STATIC</span></span><br><span class="line"><span class="regexp">    Code:</span></span><br><span class="line"><span class="regexp">      stack=2, locals=4, args_size=1</span></span><br><span class="line"><span class="regexp">         0: new           #7                  /</span><span class="regexp">/ class TestDemo1</span></span><br><span class="line"><span class="regexp">         3: dup</span></span><br><span class="line"><span class="regexp">         4: invokespecial #8                  /</span><span class="regexp">/ Method &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="regexp">         7: astore_1</span></span><br><span class="line"><span class="regexp">         8: new           #9                  /</span><span class="regexp">/ class TestDemo1$Man</span></span><br><span class="line"><span class="regexp">        11: dup</span></span><br><span class="line"><span class="regexp">        12: invokespecial #10                 /</span><span class="regexp">/ Method TestDemo1$Man.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="regexp">        15: astore_2</span></span><br><span class="line"><span class="regexp">        16: new           #11                 /</span><span class="regexp">/ class TestDemo1$Woman</span></span><br><span class="line"><span class="regexp">        19: dup</span></span><br><span class="line"><span class="regexp">        20: invokespecial #12                 /</span><span class="regexp">/ Method TestDemo1$Woman.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="regexp">        23: astore_3</span></span><br><span class="line"><span class="regexp">        24: aload_1</span></span><br><span class="line"><span class="regexp">        25: aload_2</span></span><br><span class="line"><span class="regexp">        26: invokevirtual #13                 /</span><span class="regexp">/ Method sayHello:(LTestDemo1$Human;)V</span></span><br><span class="line"><span class="regexp">        29: aload_1</span></span><br><span class="line"><span class="regexp">        30: aload_3</span></span><br><span class="line"><span class="regexp">        31: invokevirtual #13                 /</span><span class="regexp">/ Method sayHello:(LTestDemo1$Human;)V</span></span><br><span class="line"><span class="regexp">        34: return</span></span><br><span class="line"><span class="regexp">      LineNumberTable:				/</span><span class="regexp">/与源代码中的各行代码进行相互匹配</span></span><br><span class="line"><span class="regexp">        line 20: 0</span></span><br><span class="line"><span class="regexp">        line 21: 8</span></span><br><span class="line"><span class="regexp">        line 22: 16</span></span><br><span class="line"><span class="regexp">        line 23: 24</span></span><br><span class="line"><span class="regexp">        line 24: 29</span></span><br><span class="line"><span class="regexp">        line 25: 34</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">SourceFile: &quot;TestDemo1.java&quot;</span></span><br><span class="line"><span class="regexp">InnerClasses:</span></span><br><span class="line"><span class="regexp">     static #15= #11 of #7; /</span><span class="regexp">/Woman=class TestDemo1$Woman of class TestDemo1</span></span><br><span class="line"><span class="regexp">     static #17= #9 of #7; /</span><span class="regexp">/Man=class TestDemo1$Man of class TestDemo1</span></span><br><span class="line"><span class="regexp">     static #19= #18 of #7; /</span><span class="regexp">/Human=class TestDemo1$Human of class TestDemo1</span></span><br><span class="line"><span class="regexp"></span></span><br></pre></td></tr></table></figure>

<h3 id="例3"><a href="#例3" class="headerlink" title="例3"></a><span id="5.3">例3</span></h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/*重写*<span class="regexp">/</span></span><br><span class="line"><span class="regexp">public class TestDemo2 &#123;</span></span><br><span class="line"><span class="regexp">    static class Human&#123;</span></span><br><span class="line"><span class="regexp">        public void sayHello() &#123;</span></span><br><span class="line"><span class="regexp">            System.out.println(&quot;hello human&quot;);</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    static class Man extends Human&#123;</span></span><br><span class="line"><span class="regexp">        public void sayHello() &#123;</span></span><br><span class="line"><span class="regexp">            System.out.println(&quot;hello man&quot;);</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    static class Woman extends Human&#123;</span></span><br><span class="line"><span class="regexp">        public void sayHello() &#123;</span></span><br><span class="line"><span class="regexp">            System.out.println(&quot;hello woman&quot;);</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    public static void main(String[] args) &#123;</span></span><br><span class="line"><span class="regexp">        Human man = new Man();</span></span><br><span class="line"><span class="regexp">        Human woman = new Woman();</span></span><br><span class="line"><span class="regexp">        man.sayHello();</span></span><br><span class="line"><span class="regexp">        woman.sayHello();</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br></pre></td></tr></table></figure>

<p>Java字节码：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Classfile /<span class="symbol">C:</span>/Users/yalechen/Desktop/<span class="variable constant_">JVM</span>/Java Byte Code/samples/TestDemo/TestDemo2.<span class="keyword">class</span></span><br><span class="line">  <span class="title class_">Last</span> modified <span class="number">2016</span>-<span class="number">8</span>-<span class="number">16</span>; size <span class="number">464</span> bytes</span><br><span class="line">  <span class="variable constant_">MD5</span> checksum 2183e6c960f34e773da47dac5f8d717a</span><br><span class="line">  Compiled from <span class="string">&quot;TestDemo2.java&quot;</span></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">TestDemo2</span></span><br><span class="line">  minor <span class="symbol">version:</span> <span class="number">0</span></span><br><span class="line">  major <span class="symbol">version:</span> <span class="number">52</span></span><br><span class="line">  <span class="symbol">flags:</span> <span class="variable constant_">ACC_PUBLIC</span>, <span class="variable constant_">ACC_SUPER</span></span><br><span class="line">Constant <span class="symbol">pool:</span></span><br><span class="line">   <span class="comment">#1 = Methodref          #8.#22         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   <span class="comment">#2 = Class              #23            // TestDemo2$Man</span></span><br><span class="line">   <span class="comment">#3 = Methodref          #2.#22         // TestDemo2$Man.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   <span class="comment">#4 = Class              #24            // TestDemo2$Woman</span></span><br><span class="line">   <span class="comment">#5 = Methodref          #4.#22         // TestDemo2$Woman.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   <span class="comment">#6 = Methodref          #12.#25        // TestDemo2$Human.sayHello:()V</span></span><br><span class="line">   <span class="comment">#7 = Class              #26            // TestDemo2</span></span><br><span class="line">   <span class="comment">#8 = Class              #27            // java/lang/Object</span></span><br><span class="line">   <span class="comment">#9 = Utf8               Woman</span></span><br><span class="line">  <span class="comment">#10 = Utf8               InnerClasses</span></span><br><span class="line">  <span class="comment">#11 = Utf8               Man</span></span><br><span class="line">  <span class="comment">#12 = Class              #28            // TestDemo2$Human</span></span><br><span class="line">  <span class="comment">#13 = Utf8               Human</span></span><br><span class="line">  <span class="comment">#14 = Utf8               &lt;init&gt;</span></span><br><span class="line">  <span class="comment">#15 = Utf8               ()V</span></span><br><span class="line">  <span class="comment">#16 = Utf8               Code</span></span><br><span class="line">  <span class="comment">#17 = Utf8               LineNumberTable</span></span><br><span class="line">  <span class="comment">#18 = Utf8               main</span></span><br><span class="line">  <span class="comment">#19 = Utf8               ([Ljava/lang/String;)V</span></span><br><span class="line">  <span class="comment">#20 = Utf8               SourceFile</span></span><br><span class="line">  <span class="comment">#21 = Utf8               TestDemo2.java</span></span><br><span class="line">  <span class="comment">#22 = NameAndType        #14:#15        // &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  <span class="comment">#23 = Utf8               TestDemo2$Man</span></span><br><span class="line">  <span class="comment">#24 = Utf8               TestDemo2$Woman</span></span><br><span class="line">  <span class="comment">#25 = NameAndType        #29:#15        // sayHello:()V</span></span><br><span class="line">  <span class="comment">#26 = Utf8               TestDemo2</span></span><br><span class="line">  <span class="comment">#27 = Utf8               java/lang/Object</span></span><br><span class="line">  <span class="comment">#28 = Utf8               TestDemo2$Human</span></span><br><span class="line">  <span class="comment">#29 = Utf8               sayHello</span></span><br><span class="line">&#123;</span><br><span class="line">  public TestDemo2();</span><br><span class="line">    <span class="symbol">descriptor:</span> ()V</span><br><span class="line">    <span class="symbol">flags:</span> <span class="variable constant_">ACC_PUBLIC</span></span><br><span class="line">    <span class="symbol">Code:</span></span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: invokespecial <span class="comment">#1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">      <span class="symbol">LineNumberTable:</span></span><br><span class="line">        line <span class="number">3</span>: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    <span class="symbol">descriptor:</span> ([Ljava/lang/String;)V</span><br><span class="line">    <span class="symbol">flags:</span> <span class="variable constant_">ACC_PUBLIC</span>, <span class="variable constant_">ACC_STATIC</span></span><br><span class="line">    <span class="symbol">Code:</span></span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">3</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: new           <span class="comment">#2                  // class TestDemo2$Man</span></span><br><span class="line">         <span class="number">3</span>: dup</span><br><span class="line">         <span class="number">4</span>: invokespecial <span class="comment">#3                  // Method TestDemo2$Man.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="number">7</span>: astore_1</span><br><span class="line">         <span class="number">8</span>: new           <span class="comment">#4                  // class TestDemo2$Woman</span></span><br><span class="line">        <span class="number">11</span>: dup</span><br><span class="line">        <span class="number">12</span>: invokespecial <span class="comment">#5                  // Method TestDemo2$Woman.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">        <span class="number">15</span>: astore_2</span><br><span class="line">        <span class="number">16</span>: aload_1</span><br><span class="line">        <span class="number">17</span>: invokevirtual <span class="comment">#6                  // Method TestDemo2$Human.sayHello:()V</span></span><br><span class="line">        <span class="number">20</span>: aload_2</span><br><span class="line">        <span class="number">21</span>: invokevirtual <span class="comment">#6                  // Method TestDemo2$Human.sayHello:()V</span></span><br><span class="line">        <span class="number">24</span>: <span class="keyword">return</span></span><br><span class="line">      <span class="symbol">LineNumberTable:</span></span><br><span class="line">        line <span class="number">21</span>: <span class="number">0</span></span><br><span class="line">        line <span class="number">22</span>: <span class="number">8</span></span><br><span class="line">        line <span class="number">23</span>: <span class="number">16</span></span><br><span class="line">        line <span class="number">24</span>: <span class="number">20</span></span><br><span class="line">        line <span class="number">25</span>: <span class="number">24</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="symbol">SourceFile:</span> <span class="string">&quot;TestDemo2.java&quot;</span></span><br><span class="line"><span class="symbol">InnerClasses:</span></span><br><span class="line">     static <span class="comment">#9= #4 of #7; //Woman=class TestDemo2$Woman of class TestDemo2</span></span><br><span class="line">     static <span class="comment">#11= #2 of #7; //Man=class TestDemo2$Man of class TestDemo2</span></span><br><span class="line">     static <span class="comment">#13= #12 of #7; //Human=class TestDemo2$Human of class TestDemo2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以从例2和例3看出，无论是重载还是重写，都是二进制指令invokevirtual调用了sayHello方法来执行的。</p>
<p>在重载中，程序调用的是参数实际类型不同的方法，但是虚拟机最终分派了相同外观类型（静态类型）的方法，这说明在重载的过程中虚拟机在运行的时候是只看参数的外观类型（静态类型）的，而这个外观类型（静态类型）是在编译的时候就已经确定的，和虚拟机没有关系。这种依赖静态类型来做方法的分配叫做静态分派。</p>
<p>在重写中，程序调用的是不同实际类型的同名方法，虚拟机依据对象的实际类型去寻找是否有这个方法，如果有就执行，如果没有去父类里找，最终在实际类型里找到了这个方法，所以最终是在运行期动态分派了方法。在编译的时候我们可以看到字节码指示的方法都是一样的符号引用，但是运行期虚拟机能够根据实际类型去确定出真正需要的直接引用。这种依赖实际类型来做方法的分配叫做动态分派。得益于java虚拟机的动态分派会在分派前确定对象的实际类型，面向对象的多态性才能体现出来。</p>
<p> </p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-24T05:34:43.602Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-24T05:34:43.602Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item"> YalesonChan </span><span class="level-item">8 minutes read (About 1160 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/24/2016-01-16-PageRank-R/">R语言实现PageRank</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>当今，一个算法能够支撑起一个商业帝国，这句话还真不是吹的，你看Google就知道了。Google当年就是靠PageRank雄起的，将网页搜索业务做得风生水起。</p>
<p>而今天，我们就来看看如何使用R语言来实现PageRank算法的。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p>1.PageRank的原理</p>
<p>2.PageRank实现步骤</p>
<p>3.R代码实现</p>
<h2 id="1-PageRank的原理"><a href="#1-PageRank的原理" class="headerlink" title="1.PageRank的原理"></a>1.PageRank的原理</h2><p>其实说白了，PageRank原理就是：</p>
<blockquote>
<p>PageRank让链接来”投票”</p>
</blockquote>
<p>一个页面的“得票数”由所有链向它的页面的重要性来决定。到一个页面的超链接相当于对该页投一票。</p>
<p>一个页面的PageRank是由所有链向它的页面（“链入页面”）的重要性经过递归算法得到的。</p>
<p>一个有较多链入的页面会有较高的等级，相反如果一个页面没有任何链入页面，那么它没有等级。</p>
<p>PageRank的计算基于以下两个<code>基本假设</code>：</p>
<p>数量假设：如果一个页面节点接收到的其他网页指向的入链数量越多，那么这个页面越重要。</p>
<p>质量假设：指向页面A的入链质量不同，质量高的页面会通过链接向其他页面传递更多的权重。所以越是质量高的页面指向页面A，则页面A越重要。</p>
<p>要提高PageRank有3个<code>要点</code>：</p>
<ul>
<li>反向链接数</li>
<li>反向链接是否来自PageRank较高的页面</li>
<li>反向链接源页面的链接数</li>
</ul>
<p>基于以上特点，我们再来看看PageRank的基本公式吧。</p>
<p><img src="/img/pr.png" alt="pr"></p>
<h2 id="2-PageRank实现步骤"><a href="#2-PageRank实现步骤" class="headerlink" title="2.PageRank实现步骤"></a>2.PageRank实现步骤</h2><ul>
<li><p>构造邻接矩阵</p>
<p>  列：源页面</p>
<p>  行：目标页面</p>
</li>
<li><p>概率矩阵(转移矩阵)</p>
<p>计算公式在这儿体现跟连接数有关的</p>
</li>
<li><p>求开率矩阵的特征值</p>
<p>一般使用的是迭代的算法。当然也可以使用R中的API直接给出特征值。<br>而是用迭代的话，在一轮更新页面PageRank得分的计算中，每个页面将其当前的PageRank值平均分配到本页面包含的出链上，这样每个链接即获得了相应的权值。而每个页面将所有指向本页面的入链所传入的权值求和，即可得到新的PageRank得分。当每个页面都获得了更新后的PageRank值，就完成了一轮PageRank计算。</p>
</li>
</ul>
<h2 id="3-R代码实现"><a href="#3-R代码实现" class="headerlink" title="3.R代码实现"></a>3.R代码实现</h2><p>分别用下面3种方式实现PageRank:</p>
<ul>
<li>未考虑阻尼系统的情况</li>
<li>包括考虑阻尼系统的情况</li>
<li>直接用R的特征值计算函数</li>
</ul>
<p>但是，在这之前，我们还有新建一个page.csv文件，方便我们后面的实现说明。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>,<span class="number">2</span></span><br><span class="line"><span class="number">1</span>,<span class="number">3</span></span><br><span class="line"><span class="number">1</span>,<span class="number">4</span></span><br><span class="line"><span class="number">2</span>,<span class="number">3</span></span><br><span class="line"><span class="number">2</span>,<span class="number">4</span></span><br><span class="line"><span class="number">3</span>,<span class="number">4</span></span><br><span class="line"><span class="number">4</span>,<span class="number">2</span></span><br></pre></td></tr></table></figure>

<h3 id="1-未考虑阻尼系统的情况"><a href="#1-未考虑阻尼系统的情况" class="headerlink" title="1)未考虑阻尼系统的情况"></a>1)未考虑阻尼系统的情况</h3><p>以下是函数定义。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#构建邻接矩阵</span></span><br><span class="line">adjacencyMatrix&lt;-function(pages)&#123;</span><br><span class="line">  n&lt;-max(apply(pages,<span class="number">2</span>,max))</span><br><span class="line">  A &lt;- matrix(<span class="number">0</span>,n,n)</span><br><span class="line">  <span class="keyword">for</span>(i <span class="keyword">in</span> <span class="number">1</span><span class="symbol">:nrow</span>(pages)) A[pages[i,]<span class="variable">$dist</span>,pages[i,]<span class="variable">$src</span>]&lt;-<span class="number">1</span></span><br><span class="line">  A</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#变换概率矩阵</span></span><br><span class="line">probabilityMatrix&lt;-function(G)&#123;</span><br><span class="line">  <span class="comment"># 按列相加</span></span><br><span class="line">  cs &lt;- colSums(G)</span><br><span class="line">  cs[cs==<span class="number">0</span>] &lt;- <span class="number">1</span></span><br><span class="line">  n &lt;- nrow(G)</span><br><span class="line">  A &lt;- matrix(<span class="number">0</span>,nrow(G),ncol(G))</span><br><span class="line">  <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span><span class="symbol">:n</span>) A[i,] &lt;- A[i,] + G[i,]/cs</span><br><span class="line">  A</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#递归计算矩阵特征值。跟权重有关的</span></span><br><span class="line">eigenMatrix&lt;-function(G,iter=<span class="number">100</span>)&#123;</span><br><span class="line">  <span class="comment"># iter&lt;-10</span></span><br><span class="line">  n&lt;-nrow(G)</span><br><span class="line">  x &lt;- rep(<span class="number">1</span>,n)</span><br><span class="line">  <span class="comment"># 迭代,x为每一轮计算的权重，也是pR值。</span></span><br><span class="line">  <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span><span class="symbol">:iter</span>) x &lt;- G %*% x</span><br><span class="line">  x/sum(x)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pages&lt;-read.table(file=<span class="string">&quot;page.csv&quot;</span>,header=<span class="variable constant_">FALSE</span>,sep=<span class="string">&quot;,&quot;</span>)</span><br><span class="line">names(pages)&lt;-c(<span class="string">&quot;src&quot;</span>,<span class="string">&quot;dist&quot;</span>);pages</span><br></pre></td></tr></table></figure>

<p>以下便开始执行程序。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; A&lt;-adjacencyMatrix(pages);A</span><br><span class="line"></span><br><span class="line">            [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>]</span><br><span class="line">[<span class="number">1</span>,]    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line">[<span class="number">2</span>,]    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">1</span></span><br><span class="line">[<span class="number">3</span>,]    <span class="number">1</span>    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line">[<span class="number">4</span>,]    <span class="number">1</span>    <span class="number">1</span>    <span class="number">1</span>    <span class="number">0</span></span><br><span class="line"></span><br><span class="line">&gt; G&lt;-probabilityMatrix(A);G</span><br><span class="line"></span><br><span class="line">      [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>]</span><br><span class="line">[<span class="number">1</span>,] <span class="number">0.0000000</span>  <span class="number">0.0</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line">[<span class="number">2</span>,] <span class="number">0.3333333</span>  <span class="number">0.0</span>    <span class="number">0</span>    <span class="number">1</span></span><br><span class="line">[<span class="number">3</span>,] <span class="number">0.3333333</span>  <span class="number">0.5</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line">[<span class="number">4</span>,] <span class="number">0.3333333</span>  <span class="number">0.5</span>    <span class="number">1</span>    <span class="number">0</span></span><br><span class="line"></span><br><span class="line">&gt; q&lt;-eigenMatrix(G,<span class="number">10</span>);q</span><br><span class="line"></span><br><span class="line">    [,<span class="number">1</span>]</span><br><span class="line">[<span class="number">1</span>,] <span class="number">0.0000000</span></span><br><span class="line">[<span class="number">2</span>,] <span class="number">0.4036458</span></span><br><span class="line">[<span class="number">3</span>,] <span class="number">0.1979167</span></span><br><span class="line">[<span class="number">4</span>,] <span class="number">0.3984375</span></span><br></pre></td></tr></table></figure>

<h3 id="2-包括考虑阻尼系统的情况"><a href="#2-包括考虑阻尼系统的情况" class="headerlink" title="2)包括考虑阻尼系统的情况"></a>2)包括考虑阻尼系统的情况</h3><p>dProbabilityMatrix是对于adjacencyMatrix函数的重构。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#变换概率矩阵,考虑d的情况</span></span><br><span class="line">dProbabilityMatrix&lt;-function(G,d=<span class="number">0.85</span>)&#123;</span><br><span class="line">  cs &lt;- colSums(G)</span><br><span class="line">  cs[cs==<span class="number">0</span>] &lt;- <span class="number">1</span></span><br><span class="line">  n &lt;- nrow(G)</span><br><span class="line">  <span class="comment"># (1-d)/n</span></span><br><span class="line">  delta &lt;- (<span class="number">1</span>-d)/n</span><br><span class="line">  A &lt;- matrix(delta,nrow(G),ncol(G))</span><br><span class="line">  <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span><span class="symbol">:n</span>) A[i,] &lt;- A[i,] + d*G[i,]/cs</span><br><span class="line">  A</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt; pages&lt;-read.table(file=<span class="string">&quot;page.csv&quot;</span>,header=<span class="variable constant_">FALSE</span>,sep=<span class="string">&quot;,&quot;</span>)</span><br><span class="line">&gt; names(pages)&lt;-c(<span class="string">&quot;src&quot;</span>,<span class="string">&quot;dist&quot;</span>);pages</span><br><span class="line"></span><br><span class="line">  src dist</span><br><span class="line"><span class="number">1</span>   <span class="number">1</span>    <span class="number">2</span></span><br><span class="line"><span class="number">2</span>   <span class="number">1</span>    <span class="number">3</span></span><br><span class="line"><span class="number">3</span>   <span class="number">1</span>    <span class="number">4</span></span><br><span class="line"><span class="number">4</span>   <span class="number">2</span>    <span class="number">3</span></span><br><span class="line"><span class="number">5</span>   <span class="number">2</span>    <span class="number">4</span></span><br><span class="line"><span class="number">6</span>   <span class="number">3</span>    <span class="number">4</span></span><br><span class="line"><span class="number">7</span>   <span class="number">4</span>    <span class="number">2</span></span><br><span class="line"></span><br><span class="line">&gt; A&lt;-adjacencyMatrix(pages);A</span><br><span class="line"></span><br><span class="line">      [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>]</span><br><span class="line">[<span class="number">1</span>,]    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line">[<span class="number">2</span>,]    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">1</span></span><br><span class="line">[<span class="number">3</span>,]    <span class="number">1</span>    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line">[<span class="number">4</span>,]    <span class="number">1</span>    <span class="number">1</span>    <span class="number">1</span>    <span class="number">0</span></span><br><span class="line"></span><br><span class="line">&gt; G&lt;-dProbabilityMatrix(A);G</span><br><span class="line">        [,<span class="number">1</span>]   [,<span class="number">2</span>]   [,<span class="number">3</span>]   [,<span class="number">4</span>]</span><br><span class="line">[<span class="number">1</span>,] <span class="number">0.0375000</span> <span class="number">0.0375</span> <span class="number">0.0375</span> <span class="number">0.0375</span></span><br><span class="line">[<span class="number">2</span>,] <span class="number">0.3208333</span> <span class="number">0.0375</span> <span class="number">0.0375</span> <span class="number">0.8875</span></span><br><span class="line">[<span class="number">3</span>,] <span class="number">0.3208333</span> <span class="number">0.4625</span> <span class="number">0.0375</span> <span class="number">0.0375</span></span><br><span class="line">[<span class="number">4</span>,] <span class="number">0.3208333</span> <span class="number">0.4625</span> <span class="number">0.8875</span> <span class="number">0.0375</span></span><br><span class="line"></span><br><span class="line">&gt; q&lt;-eigenMatrix(G,<span class="number">100</span>);q</span><br><span class="line">      [,<span class="number">1</span>]</span><br><span class="line">[<span class="number">1</span>,] <span class="number">0.0375000</span></span><br><span class="line">[<span class="number">2</span>,] <span class="number">0.3738930</span></span><br><span class="line">[<span class="number">3</span>,] <span class="number">0.2063759</span></span><br><span class="line">[<span class="number">4</span>,] <span class="number">0.3822311</span></span><br></pre></td></tr></table></figure>

<p>增加阻尼系数后，ID&#x3D;1的页面，就有值了PR(1)&#x3D;(1-d)&#x2F;n&#x3D;(1-0.85)&#x2F;4&#x3D;0.0375，即无外链页面的最小值。</p>
<h3 id="3-直接用R的特征值计算函数"><a href="#3-直接用R的特征值计算函数" class="headerlink" title="3)直接用R的特征值计算函数"></a>3)直接用R的特征值计算函数</h3><p>增加的函数：calcEigenMatrix<br>用于直接计算矩阵特征值，可以有效地减少的循环的操作，提高程序运行效率。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#直接计算矩阵特征值.即特解</span></span><br><span class="line">calcEigenMatrix&lt;-function(G)&#123;</span><br><span class="line">  x &lt;- Re(eigen(G)<span class="variable">$vectors</span>[,<span class="number">1</span>])</span><br><span class="line">  x/sum(x)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt; pages&lt;-read.table(file=<span class="string">&quot;page.csv&quot;</span>,header=<span class="variable constant_">FALSE</span>,sep=<span class="string">&quot;,&quot;</span>)</span><br><span class="line">&gt; names(pages)&lt;-c(<span class="string">&quot;src&quot;</span>,<span class="string">&quot;dist&quot;</span>);pages</span><br><span class="line">    src dist</span><br><span class="line"><span class="number">1</span>   <span class="number">1</span>    <span class="number">2</span></span><br><span class="line"><span class="number">2</span>   <span class="number">1</span>    <span class="number">3</span></span><br><span class="line"><span class="number">3</span>   <span class="number">1</span>    <span class="number">4</span></span><br><span class="line"><span class="number">4</span>   <span class="number">2</span>    <span class="number">3</span></span><br><span class="line"><span class="number">5</span>   <span class="number">2</span>    <span class="number">4</span></span><br><span class="line"><span class="number">6</span>   <span class="number">3</span>    <span class="number">4</span></span><br><span class="line"><span class="number">7</span>   <span class="number">4</span>    <span class="number">2</span></span><br><span class="line"></span><br><span class="line">&gt; A&lt;-adjacencyMatrix(pages);A</span><br><span class="line">      [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>]</span><br><span class="line">[<span class="number">1</span>,]    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line">[<span class="number">2</span>,]    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">1</span></span><br><span class="line">[<span class="number">3</span>,]    <span class="number">1</span>    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line">[<span class="number">4</span>,]    <span class="number">1</span>    <span class="number">1</span>    <span class="number">1</span>    <span class="number">0</span></span><br><span class="line"></span><br><span class="line">&gt; G&lt;-dProbabilityMatrix(A);G</span><br><span class="line">        [,<span class="number">1</span>]   [,<span class="number">2</span>]   [,<span class="number">3</span>]   [,<span class="number">4</span>]</span><br><span class="line">[<span class="number">1</span>,] <span class="number">0.0375000</span> <span class="number">0.0375</span> <span class="number">0.0375</span> <span class="number">0.0375</span></span><br><span class="line">[<span class="number">2</span>,] <span class="number">0.3208333</span> <span class="number">0.0375</span> <span class="number">0.0375</span> <span class="number">0.8875</span></span><br><span class="line">[<span class="number">3</span>,] <span class="number">0.3208333</span> <span class="number">0.4625</span> <span class="number">0.0375</span> <span class="number">0.0375</span></span><br><span class="line">[<span class="number">4</span>,] <span class="number">0.3208333</span> <span class="number">0.4625</span> <span class="number">0.8875</span> <span class="number">0.0375</span></span><br><span class="line"></span><br><span class="line">&gt; q&lt;-calcEigenMatrix(G);q</span><br><span class="line">[<span class="number">1</span>] <span class="number">0.0375000</span> <span class="number">0.3732476</span> <span class="number">0.2067552</span> <span class="number">0.3824972</span></span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-24T05:34:43.602Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-24T05:34:43.602Z" title="7/24/2022, 1:34:43 PM">2022-07-24</time></span><span class="level-item"> YalesonChan </span><span class="level-item">13 minutes read (About 1970 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/24/2016-04-04-Android-ContentProvider/">Content Provider on Android</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Content Provider是Android组件中最基本也是最为常见用的四大组件之一。</p>
<p>主要用于对外共享数据，也就是通过Content Provider把应用中的数据共享给其他应用访问，其他应用可以通过Content Provider对指定应用中的数据进行操作。Content Provider分为系统的和自定义的，系统的也就是例如联系人，图片等数据。</p>
<p>Android中对数据操作包含有：</p>
<p>file, sqlite3, SharedPreferences, ContectResolver与ContentProvider。前三种数据操作方式都只是针对本应用内数据，程序不能通过这三种方法去操作别的应用内的数据。Android中提供ContectResolver与ContentProvider来操作别的应用程序的数据。</p>
<p>使用方式：</p>
<p>一个应用实现ContentProvider来提供内容给别的应用来操作</p>
<p>一个应用通过ContentResolver来操作别的应用数据，当然在自己的应用中也可以。</p>
<p>以下这段是Google Doc中对ContentProvider的大致概述：</p>
<p>内容提供者将一些特定的应用程序数据供给其它应用程序使用。内容提供者继承于Content Provider基类，为其它应用程序取用和存储它管理的数据实现了一套标准方法。然而，应用程序并不直接调用这些方法，而是使用一个 ContentResolver对象，调用它的方法作为替代。ContentResolver可以与任意内容提供者进行会话，与其合作来对所有相关交互通讯进行管理。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li>为什么使用Content Provider？</li>
<li>Content Provider的关键类</li>
<li>ContentProvider的使用</li>
<li>监听ContentProvider中数据的变化</li>
</ol>
<h2 id="一、为什么使用Content-Provider？"><a href="#一、为什么使用Content-Provider？" class="headerlink" title="一、为什么使用Content Provider？"></a>一、为什么使用Content Provider？</h2><p>关于数据共享，以前我们学习过文件操作模式，知道通过指定文件的操作模式为Context.MODE_WORLD_READABLE或Context.MODE_WORLD_WRITEABLE同样也可以对外共享数据。那么，这里为何要使用ContentProvider对外共享数据呢？</p>
<p>是这样的，如果采用文件操作模式对外共享数据，数据的访问方式会因数据存储的方式而不同，导致数据的访问方式无法统一，如：采用xml文件对外共享数据，需要进行xml解析才能读取数据；采用sharedpreferences共享数据，需要使用sharedpreferences API读取数据。</p>
<p>使用ContentProvider对外共享数据的好处是统一了数据的访问方式。</p>
<h2 id="二、Content-Provider的关键类"><a href="#二、Content-Provider的关键类" class="headerlink" title="二、Content Provider的关键类"></a>二、Content Provider的关键类</h2><p>1、ContentProvider</p>
<p>Android提供了一些主要数据类型的ContentProvider，比如音频、视频、图片和私人通讯录等。可在android.provider包下面找到一些Android提供的ContentProvider。通过获得这些ContentProvider可以查询它们包含的数据，当然前提是已获得适当的读取权限。</p>
<p>主要方法：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public boolean onCreate() 在创建ContentProvider时调用；</span><br><span class="line">public Cursor query(Uri, String[], String, String[], String) 用于查询指定Uri的ContentProvider，返回一个Cursor；</span><br><span class="line">public Uri insert(Uri, ContentValues) 用于添加数据到指定Uri的ContentProvider中；</span><br><span class="line">public int update(Uri, ContentValues, String, String[]) 用于更新指定Uri的ContentProvider中的数据；</span><br><span class="line">public int delete(Uri, String, String[]) 用于从指定Uri的ContentProvider中删除数据；</span><br><span class="line">public String getType(Uri) 用于返回指定的Uri中的数据的<span class="variable constant_">MIME</span>类型。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>public String getType(Uri) 用于返回指定的Uri中的数据的MIME类型</p>
</blockquote>
<p>1）如果操作的数据属于集合类型，那么MIME类型字符串应该以vnd.android.cursor.dir&#x2F;开头。</p>
<p>例如：要得到所有person记录的Uri为content:&#x2F;&#x2F;contacts&#x2F;person，那么返回的MIME类型字符串为”vnd.android.cursor.dir&#x2F;person”。</p>
<p>2）如果要操作的数据属于非集合类型数据，那么MIME类型字符串应该以vnd.android.cursor.item&#x2F;开头。</p>
<p>例如：要得到id为10的person记录的Uri为content:&#x2F;&#x2F;contacts&#x2F;person&#x2F;10，那么返回的MIME类型字符串应为”vnd.android.cursor.item&#x2F;person”。</p>
<p>2、ContentResolver</p>
<p>当外部应用需要对ContentProvider中的数据进行添加、删除、修改和查询操作时，可以使用ContentResolver类来完成，要获取ContentResolver对象，可以使用Context提供的getContentResolver()方法。</p>
<blockquote>
<p>ContentResolver cr &#x3D; getContentResolver();</p>
</blockquote>
<p>ContentResolver提供的方法和ContentProvider提供的方法对应的有以下几个方法。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public Uri insert(Uri uri, ContentValues values) 用于添加数据到指定Uri的ContentProvider中；</span><br><span class="line">public int delete(Uri uri, String selection, String[] selectionArgs) 用于从指定Uri的ContentProvider中删除数据；</span><br><span class="line">public int update(Uri uri, ContentValues values, String selection, String[] selectionArgs) 用于更新指定Uri的ContentProvider中的数据；</span><br><span class="line">public Cursor query(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder) 用于查询指定Uri的ContentProvider。</span><br></pre></td></tr></table></figure>

<p>3、Uri解析类</p>
<p>Uri指定了将要操作的ContentProvider，其实可以把一个Uri看作是一个网址，我们把Uri分为三部分：</p>
<p>第一部分是”content:&#x2F;&#x2F;“，可以看作是网址中的”http:&#x2F;&#x2F;“；</p>
<p>第二部分是主机名或authority，用于唯一标识这个ContentProvider，外部应用需要根据这个标识来找到它。可以看作是网址中的主机名，如”blog.csdn.net”；</p>
<p>第三部分是路径名，用来表示将要操作的数据。可以看作网址中细分的内容路径。</p>
<p><img src="/img/Uri.png" alt="Uri.png"></p>
<p>因为Uri代表了要操作的数据，所以我们经常需要解析Uri，并从Uri中获取数据。Android系统提供了两个用于操作Uri的工具类，分别为UriMatcher和ContentUris 。</p>
<p>1）UriMatcher类用于匹配Uri。</p>
<p>1、把你需要匹配Uri路径全部给注册上</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/<span class="regexp">/常量UriMatcher.NO_MATCH表示不匹配任何路径的返回码</span></span><br><span class="line"><span class="regexp">UriMatcher  sMatcher = new UriMatcher(UriMatcher.NO_MATCH);</span></span><br><span class="line"><span class="regexp">sMatcher.addURI(&quot;com.cyw.provider.personprovider&quot;, &quot;person&quot;, 1);</span></span><br><span class="line"><span class="regexp">sMatcher.addURI(&quot;com.cyw.provider.personprovider&quot;, &quot;person/</span><span class="comment">#&quot;, 2);//#号为通配符</span></span><br><span class="line">switch (sMatcher.match(Uri.parse(<span class="string">&quot;content://com.cyw.provider.personprovider/person/10&quot;</span>))) &#123; </span><br><span class="line">   <span class="keyword">case</span> <span class="number">1</span></span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">2</span></span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">   <span class="symbol">default:</span>/<span class="regexp">/不匹配</span></span><br><span class="line"><span class="regexp">     break;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<p>2、使用sMatcher.match(uri)方法对输入的Uri进行匹配，如果匹配就返回匹配码，匹配码是调用addURI()方法传入的第三个参数​</p>
<p>2）ContentUris类用于操作Uri路径后面的ID部分，它有两个比较实用的方法：</p>
<p>1、withAppendedId(uri, id)用于为路径加上ID部分：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Uri uri = Uri.parse(<span class="string">&quot;content://com.cyw.provider.personprovider/person&quot;</span>)</span><br><span class="line">Uri resultUri = ContentUris.withAppendedId(uri, <span class="number">10</span>); </span><br><span class="line"><span class="regexp">//</span>生成后的Uri为：<span class="symbol">content:</span>/<span class="regexp">/com.cyw.provider.personprovider/person</span><span class="regexp">/10</span></span><br></pre></td></tr></table></figure>

<p>2、parseId(uri)方法用于从路径中获取ID部分：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Uri uri = Uri.parse(<span class="string">&quot;content://com.cyw.provider.personprovider/person/10&quot;</span>)</span><br><span class="line">long personid = ContentUris.parseId(uri);<span class="regexp">//</span>获取的结果为<span class="symbol">:</span><span class="number">10</span></span><br></pre></td></tr></table></figure>


<h2 id="三、ContentProvider的使用"><a href="#三、ContentProvider的使用" class="headerlink" title="三、ContentProvider的使用"></a>三、ContentProvider的使用</h2><p>1、需要继承ContentProvider并重写方法</p>
<p>2、需要在AndroidManifest.xml使用<provider>对该ContentProvider进行配置，为了能让其他应用找到该ContentProvider ，ContentProvider采用了authorities（主机名&#x2F;域名）对它进行唯一标识，你可以把ContentProvider看作是一个网站，authorities 就是域名。<br>​</p>
<h2 id="四、监听ContentProvider中数据的变化"><a href="#四、监听ContentProvider中数据的变化" class="headerlink" title="四、监听ContentProvider中数据的变化"></a>四、监听ContentProvider中数据的变化</h2><p>1、如果ContentProvider的访问者需要知道ContentProvider中的数据发生变化，可以在ContentProvider发生数据变化时调用getContentResolver().notifyChange(uri, null)来通知注册在此URI上的访问者，例子如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> <span class="title class_">PersonContentProvider</span> extends ContentProvider &#123;</span><br><span class="line">   public Uri insert(Uri uri, ContentValues values) &#123;</span><br><span class="line">      db.insert(<span class="string">&quot;person&quot;</span>, <span class="string">&quot;personid&quot;</span>, values);</span><br><span class="line">   getContext().getContentResolver().notifyChange(uri, null);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、如果ContentProvider的访问者需要得到数据变化通知，必须使用ContentObserver对数据（数据采用uri描述）进行监听，当监听到数据变化通知时，系统就会调用ContentObserver的onChange()方法：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">getContentResolver().registerContentObserver(Uri.parse(<span class="string">&quot;content://com.cyw.providers.personprovider/person&quot;</span>),</span><br><span class="line">       <span class="literal">true</span>, new PersonObserver(new Handler()));</span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">PersonObserver</span> extends ContentObserver&#123;</span><br><span class="line">   public PersonObserver(Handler handler) &#123;</span><br><span class="line">      <span class="variable language_">super</span>(handler);</span><br><span class="line">   &#125;</span><br><span class="line">   public void onChange(boolean selfChange) &#123;</span><br><span class="line">      <span class="regexp">//</span>此处可以进行相应的业务处理</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/page/0/">Previous</a></div><div class="pagination-next"><a href="/page/2/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Your name"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Your name</p><p class="is-size-6 is-block">Your title</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Your location</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">29</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-24T05:34:45.046Z">2022-07-24</time></p><p class="title"><a href="/2022/07/24/2016-01-20-OpenCV-with-CodeBlocks/">OpenCV with CodeBlocks</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-24T05:34:43.614Z">2022-07-24</time></p><p class="title"><a href="/2022/07/24/2016-01-19-Rescue-Simulation-League-Team-Description-S.O.S-(Iran)/">RoboCup Rescue 2015 – Rescue Simulation League Team Description S.O.S (Iran)</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-24T05:34:43.614Z">2022-07-24</time></p><p class="title"><a href="/2022/07/24/2016-01-22-Gaussian-Blur/">Gaussian Blur</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-24T05:34:43.614Z">2022-07-24</time></p><p class="title"><a href="/2022/07/24/2016-04-04-Android-Activity/">Activity on Android</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-24T05:34:43.614Z">2022-07-24</time></p><p class="title"><a href="/2022/07/24/2016-04-04-Android-Service/">Service on Android</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">July 2022</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a><p class="is-size-7"><span>&copy; 2022 John Doe</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>