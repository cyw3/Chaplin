<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>MACD策略 - cyw3</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="cyw3"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="cyw3"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="前言各位看官好，我是小陈。前两篇文章，我们一起写了个数据表格和走势图，恩，是不是很容易啊，有没有信心满满现在！那么，接下来，我们来个有点难度的。咱们一起写一下MACD股票策略吧。 移动平均线(MA)是股市中最常用的一种技术分析方法，用来在大行情的波动段找到有效的交易信号。移动平均线不仅简单，而且有效，对股市操作具有神奇的指导作用，能有效地打败大部分的主观策略，是炒股、炒期货的必备基本工具。 接下来"><meta property="og:type" content="blog"><meta property="og:title" content="MACD策略"><meta property="og:url" content="http://example.com/2022/07/24/2016-01-14-MACD/"><meta property="og:site_name" content="cyw3"><meta property="og:description" content="前言各位看官好，我是小陈。前两篇文章，我们一起写了个数据表格和走势图，恩，是不是很容易啊，有没有信心满满现在！那么，接下来，我们来个有点难度的。咱们一起写一下MACD股票策略吧。 移动平均线(MA)是股市中最常用的一种技术分析方法，用来在大行情的波动段找到有效的交易信号。移动平均线不仅简单，而且有效，对股市操作具有神奇的指导作用，能有效地打败大部分的主观策略，是炒股、炒期货的必备基本工具。 接下来"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://s3.cn-north-1.amazonaws.com.cn/static.qutke.com/report/56a4c67e9c61215c5fd0a6bb-Rplot03.png"><meta property="article:published_time" content="2022-07-24T06:56:22.285Z"><meta property="article:modified_time" content="2022-07-24T06:56:22.285Z"><meta property="article:author" content="cyw3"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://s3.cn-north-1.amazonaws.com.cn/static.qutke.com/report/56a4c67e9c61215c5fd0a6bb-Rplot03.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2022/07/24/2016-01-14-MACD/"},"headline":"MACD策略","image":["https://s3.cn-north-1.amazonaws.com.cn/static.qutke.com/report/56a4c67e9c61215c5fd0a6bb-Rplot03.png"],"datePublished":"2022-07-24T06:56:22.285Z","dateModified":"2022-07-24T06:56:22.285Z","author":{"@type":"Person","name":"yalechen"},"publisher":{"@type":"Organization","name":"cyw3","logo":{"@type":"ImageObject","url":{"text":"Cyw3"}}},"description":"前言各位看官好，我是小陈。前两篇文章，我们一起写了个数据表格和走势图，恩，是不是很容易啊，有没有信心满满现在！那么，接下来，我们来个有点难度的。咱们一起写一下MACD股票策略吧。 移动平均线(MA)是股市中最常用的一种技术分析方法，用来在大行情的波动段找到有效的交易信号。移动平均线不仅简单，而且有效，对股市操作具有神奇的指导作用，能有效地打败大部分的主观策略，是炒股、炒期货的必备基本工具。 接下来"}</script><link rel="canonical" href="http://example.com/2022/07/24/2016-01-14-MACD/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Cyw3</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cyw3/cyw3.github.io"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-07-24T06:56:22.285Z" title="7/24/2022, 2:56:22 PM">2022-07-24</time>发表</span><span class="level-item"><time dateTime="2022-07-24T06:56:22.285Z" title="7/24/2022, 2:56:22 PM">2022-07-24</time>更新</span><span class="level-item"> yalechen </span><span class="level-item">18 分钟读完 (大约2709个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">MACD策略</h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>各位看官好，我是小陈。前两篇文章，我们一起写了个数据表格和走势图，恩，是不是很容易啊，有没有信心满满现在！那么，接下来，我们来个有点难度的。咱们一起写一下MACD股票策略吧。</p>
<p>移动平均线(MA)是股市中最常用的一种技术分析方法，用来在大行情的波动段找到有效的交易信号。移动平均线不仅简单，而且有效，对股市操作具有神奇的指导作用，能有效地打败大部分的主观策略，是炒股、炒期货的必备基本工具。</p>
<p>接下来，我们仔细研究一下MACD策略的简单而又神奇之处吧。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p>1.MACD的介绍<br>2.均线模型展示<br>3.R语言实现MACD策略</p>
<h2 id="1、MACD的介绍"><a href="#1、MACD的介绍" class="headerlink" title="1、MACD的介绍"></a>1、MACD的介绍</h2><p>在介绍MACD之前，我们来介绍一下MA，也就是移动平均线。<br>移动平均线(MA,Moving average）是以道·琼斯的”平均成本概念”为理论基础，采用统计学中”移动平均”的原理，将一段时期内的股票价格平均值连成曲线，用来显示股价的历史波动情况，进而反映股价指数未来发展趋势的技术分析方法。它是道氏理论的形象化表述。<br>移动平均线的计算方法就是求连续若干天的收盘价的算术平均。天数就是MA的参数。</p>
<p>计算公式： MA &#x3D; (C1+C2+C3+C4+C5+….+Cn)&#x2F;n ,C为收盘价，n为移动平均周期数。例如，5日移动平均价格计算方法为：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">MA5</span> = （前四天收盘价+前三天收盘价+前天收盘价+昨天收盘价+今天收盘价）/<span class="number">5</span> </span><br></pre></td></tr></table></figure>

<p>移动平均线依时间长短可分为三种，即短期移动平均线，中期移动平均线，长期移动平均线。短期移动平均线一般以5日或10日为计算期间，中期移动平均线大多以30日、60日为计算期间；长期移动平均线大多以100天和200天为计算期间。有根据处理数据的方式的不同，移动平均线又分为简单移动平均线(SMA)、加权移动平均线(WMA)，以及指数平滑移动平均线(EMA)。</p>
<p>而今天我们说的，MACD(Moving Average Convergence &#x2F; Divergence)也是基于移动平均线发展而来。</p>
<p>MACD称为指数平滑移动平均线，是从双指数移动平均线发展而来的，由快的指数移动平均线（EMA）减去慢的指数移动平均线，MACD的意义和双移动平均线基本相同，但阅读起来更方便。当MACD从负数转向正数，是买的信号。当MACD从正数转向负数，是卖的信号。当MACD以大角度变化，表示快的移动平均线和慢的移动平均线的差距非常迅速的拉开，代表了一个市场大趋势的转变。</p>
<h2 id="2、均线模型展示"><a href="#2、均线模型展示" class="headerlink" title="2、均线模型展示"></a>2、均线模型展示</h2><p>这里，为了让大家能够跟更好的理解，我特地制作一下走势图。<br><a target="_blank" rel="noopener" href="https://i.qutke.com/apps/56a4fc1c310a3c464064943f"><img src="https://s3.cn-north-1.amazonaws.com.cn/static.qutke.com/report/56a4c67e9c61215c5fd0a6bb-Rplot03.png" alt="yieldchart"></a></p>
<p>这是以IBM2010年1月到2012年1月的股价走势。其中黑线代表的是K线（该公司每天的股价），蓝线代表的是ma5（该公司每5天收盘价的均值连成的曲线），以及绿线ma20（该公司每20天收盘价的均值连成的曲线）。可以看到，ma20被无数个红点以及紫点覆盖掉了。红点是表示此时ma5&gt;ma20，紫点是ma5&lt;ma20.</p>
<p>从图中，我们可以直观的看到，红线总是在上升，而紫线则总是在下降。自然而然地，大家就会想到，我们应该在红线的第一个点买入，在紫线的第一个点卖出，这样，我们就可以挣得更多钱了。</p>
<p>当然也不是说，使用了MACD策略，我们就一定赚钱，坐着收钱了。毕竟股市可不是这样简单的东西。但是MACD策略却可以让我们更加清晰的看到市场的本质，提高了胜率。不过，即便是有输有赢，我们也要找到胜率最高的那一只股票是不。以下这幅图便是我们今天的任务了。使用我们今天学到的MACD策略，并对这么一组股票进行模拟交易，然后按照收益率高低进行排序。第一行是沪深300指数，以作比较。</p>
<iframe style="width:100%;height:600px;border:0;padding:0;margin:0;" src="https://console.qutke.com/diagram/info/56a5ccbb310a3c4640649458?config={ %22color%22:%22%23ffffff%22}"></iframe>

<h2 id="3、R语言实现MACD策略"><a href="#3、R语言实现MACD策略" class="headerlink" title="3、R语言实现MACD策略"></a>3、R语言实现MACD策略</h2><p>1）初始化</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">library(quantmod)</span><br><span class="line">library(plyr)</span><br><span class="line">library(<span class="variable constant_">TTR</span>)</span><br><span class="line">library(scales)</span><br><span class="line">library(ggplot2)</span><br><span class="line">library(qutke)</span><br><span class="line">key &lt;- <span class="string">&#x27;faca4c8ff4dc1502d87944ea9cfd74f19918f0aef37fde6746b61d4d339bfcf3&#x27;</span></span><br><span class="line">init(key)</span><br></pre></td></tr></table></figure>

<p>2）选定参数</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sDate&lt;-as.Date(<span class="string">&quot;2015-1-1&quot;</span>) <span class="comment">#开始日期</span></span><br><span class="line">eDate&lt;-Sys.Date() <span class="comment">#结束日期</span></span><br><span class="line">tradingDay &lt;- getDate(data=<span class="string">&#x27;tradingDay&#x27;</span>,startdate=sDate,enddate=eDate,key=key)</span><br><span class="line">length &lt;- length(tradingDay)</span><br><span class="line">sDate &lt;- tradingDay[<span class="number">1</span>]</span><br><span class="line">eDate &lt;- tradingDay[length]</span><br></pre></td></tr></table></figure>

<p>可以通过getIndudtry方法获取况客的股票代码。不过因为有点多，所以我这里只选其中的20多支股票的股票代码。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># industry &lt;- getIndustry(data=&#x27;industryType&#x27;,date=eDate,key=key)</span></span><br><span class="line"><span class="comment"># qtid &lt;- industry$qtid</span></span><br><span class="line">qtid &lt;- c(<span class="string">&#x27;002230.SZ&#x27;</span>,<span class="string">&#x27;002715.SZ&#x27;</span>,<span class="string">&quot;603789.SH&quot;</span>, <span class="string">&quot;603799.SH&quot;</span>, <span class="string">&quot;603806.SH&quot;</span>, <span class="string">&quot;603808.SH&quot;</span>, <span class="string">&quot;603818.SH&quot;</span>,<span class="string">&quot;603828.SH&quot;</span>, <span class="string">&quot;603869.SH&quot;</span>, <span class="string">&quot;603883.SH&quot;</span>,</span><br><span class="line">          <span class="string">&quot;603885.SH&quot;</span>, <span class="string">&quot;603889.SH&quot;</span>, <span class="string">&quot;603898.SH&quot;</span>, <span class="string">&quot;603899.SH&quot;</span>, <span class="string">&quot;603901.SH&quot;</span>, <span class="string">&quot;603918.SH&quot;</span>, <span class="string">&quot;603939.SH&quot;</span>, <span class="string">&quot;603968.SH&quot;</span>,</span><br><span class="line">          <span class="string">&quot;603969.SH&quot;</span>, <span class="string">&quot;603988.SH&quot;</span> ,<span class="string">&quot;603989.SH&quot;</span>, <span class="string">&quot;603993.SH&quot;</span>, <span class="string">&quot;603997.SH&quot;</span>, <span class="string">&quot;603998.SH&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>3）获取每支股票的数据，包括每个交易日的收盘价、ma5、ma20.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dailyQuote &lt;- getDailyQuote(data=<span class="string">&#x27;mktFwdDaily&#x27;</span>,qtid=qtid,startdate=sDate,enddate=eDate,key=key)</span><br><span class="line">ldata &lt;- dailyQuote[,grep(<span class="string">&quot;qtid|date|close|ma5|ma20&quot;</span>, names(dailyQuote)) ]</span><br><span class="line"><span class="comment">#为true时候，补全ldata中是na的数值，以最近日期的数据 进行赋值 </span></span><br><span class="line">ldata&lt;-na.locf(ldata, fromLast=<span class="variable constant_">TRUE</span>)</span><br></pre></td></tr></table></figure>

<p>因为这次涉及到的数据处理比较多，听起来也比较虚，所以，我们在写代码的时候，可以多查看一下所得到的变量的数据结构是什么样子的。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&gt; head(dailyQuote)</span><br><span class="line">       qtid       date close    volume      value    fwdAdj fwdAdjOpen fwdAdjHi fwdAdjLo fwdAdjClose       ret    logRet</span><br><span class="line"><span class="number">1</span> <span class="number">000001</span>.<span class="variable constant_">SZ</span> <span class="number">2015</span>-<span class="number">01</span>-<span class="number">05</span> <span class="number">16.02</span> <span class="number">286043643</span> <span class="number">4565387846</span> <span class="number">0.7574074</span>   <span class="number">12.11094</span> <span class="number">12.33059</span> <span class="number">11.81556</span>    <span class="number">12.13367</span>  <span class="number">0.011364</span>  <span class="number">0.011300</span></span><br><span class="line"><span class="number">2</span> <span class="number">000001</span>.<span class="variable constant_">SZ</span> <span class="number">2015</span>-<span class="number">01</span>-<span class="number">06</span> <span class="number">15.78</span> <span class="number">216642140</span> <span class="number">3453446168</span> <span class="number">0.7574074</span>   <span class="number">12.00491</span> <span class="number">12.41391</span> <span class="number">11.77769</span>    <span class="number">11.95189</span> -<span class="number">0.014981</span> -<span class="number">0.015095</span></span><br><span class="line"><span class="number">3</span> <span class="number">000001</span>.<span class="variable constant_">SZ</span> <span class="number">2015</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">15.48</span> <span class="number">170012067</span> <span class="number">2634796409</span> <span class="number">0.7574074</span>   <span class="number">11.78526</span> <span class="number">11.98976</span> <span class="number">11.58833</span>    <span class="number">11.72467</span> -<span class="number">0.019011</span> -<span class="number">0.019194</span></span><br><span class="line"><span class="number">4</span> <span class="number">000001</span>.<span class="variable constant_">SZ</span> <span class="number">2015</span>-<span class="number">01</span>-08 <span class="number">14.96</span> <span class="number">140771421</span> <span class="number">2128003432</span> <span class="number">0.7574074</span>   <span class="number">11.73981</span> <span class="number">11.79283</span> <span class="number">11.28537</span>    <span class="number">11.33081</span> -<span class="number">0.033592</span> -<span class="number">0.034169</span></span><br><span class="line"><span class="number">5</span> <span class="number">000001</span>.<span class="variable constant_">SZ</span> <span class="number">2015</span>-<span class="number">01</span>-09 <span class="number">15.08</span> <span class="number">250850023</span> <span class="number">3835378100</span> <span class="number">0.7574074</span>   <span class="number">11.28537</span> <span class="number">12.02006</span> <span class="number">11.14146</span>    <span class="number">11.42170</span>  <span class="number">0.008021</span>  <span class="number">0.007989</span></span><br><span class="line"><span class="number">6</span> <span class="number">000001</span>.<span class="variable constant_">SZ</span> <span class="number">2015</span>-<span class="number">01</span>-<span class="number">12</span> <span class="number">14.77</span> <span class="number">155329086</span> <span class="number">2293104602</span> <span class="number">0.7574074</span>   <span class="number">11.26265</span> <span class="number">11.39898</span> <span class="number">10.98241</span>    <span class="number">11.18691</span> -<span class="number">0.020557</span> -<span class="number">0.020771</span></span><br><span class="line">     vwap      vol30   ma5  ma10  ma20 ma60</span><br><span class="line"><span class="number">1</span> <span class="number">15.9605</span> <span class="number">8427448605</span> <span class="number">11.72</span> <span class="number">11.45</span> <span class="number">11.17</span> <span class="number">9.23</span></span><br><span class="line"><span class="number">2</span> <span class="number">15.9408</span> <span class="number">8529417547</span> <span class="number">11.82</span> <span class="number">11.51</span> <span class="number">11.22</span> <span class="number">9.30</span></span><br><span class="line"><span class="number">3</span> <span class="number">15.4977</span> <span class="number">8476692763</span> <span class="number">11.91</span> <span class="number">11.52</span> <span class="number">11.23</span> <span class="number">9.37</span></span><br><span class="line"><span class="number">4</span> <span class="number">15.1167</span> <span class="number">8460683917</span> <span class="number">11.83</span> <span class="number">11.54</span> <span class="number">11.27</span> <span class="number">9.43</span></span><br><span class="line"><span class="number">5</span> <span class="number">15.2895</span> <span class="number">8493042075</span> <span class="number">11.71</span> <span class="number">11.62</span> <span class="number">11.31</span> <span class="number">9.49</span></span><br><span class="line"><span class="number">6</span> <span class="number">14.7629</span> <span class="number">8437985489</span> <span class="number">11.52</span> <span class="number">11.62</span> <span class="number">11.34</span> <span class="number">9.55</span></span><br><span class="line"></span><br><span class="line">&gt; head(ldata)</span><br><span class="line">       qtid       date  close    ma5  ma20</span><br><span class="line"><span class="number">1</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2015</span>-<span class="number">01</span>-<span class="number">05</span>  <span class="number">27.40</span>  <span class="number">17.11</span> <span class="number">18.17</span></span><br><span class="line"><span class="number">2</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2015</span>-<span class="number">01</span>-<span class="number">06</span>  <span class="number">27.72</span>  <span class="number">16.99</span> <span class="number">18.12</span></span><br><span class="line"><span class="number">3</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2015</span>-<span class="number">01</span>-<span class="number">07</span>  <span class="number">27.20</span>  <span class="number">16.95</span> <span class="number">18.08</span></span><br><span class="line"><span class="number">4</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2015</span>-<span class="number">01</span>-08  <span class="number">27.20</span>  <span class="number">17.07</span> <span class="number">18.04</span></span><br><span class="line"><span class="number">5</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2015</span>-<span class="number">01</span>-09  <span class="number">27.10</span>  <span class="number">17.13</span> <span class="number">17.97</span></span><br><span class="line"><span class="number">6</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2015</span>-<span class="number">01</span>-<span class="number">12</span>  <span class="number">27.91</span>  <span class="number">17.19</span> <span class="number">17.93</span></span><br></pre></td></tr></table></figure>

<p>4）以UP、Down标定。</p>
<p>对每只股票，以其每个交易日的ma20与ma5进行比较，当ma5&gt;ma20时候，取UP，当ma5&lt;ma20时候，取Down。然后，对数据以qtid为准进行分离并依照日期排序。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 散点数据</span></span><br><span class="line">genPoint&lt;-function(arg=c(),ldata)&#123;</span><br><span class="line">  <span class="keyword">if</span>(length(arg)&gt;<span class="number">2</span>)&#123;</span><br><span class="line">    stop(<span class="string">&#x27;The length of args is two.&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(length(arg)&lt;<span class="number">2</span>)&#123;</span><br><span class="line">    arg &lt;- c(arg,<span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">#[,c(1,arg[1])]</span></span><br><span class="line">  pdata &lt;- ldata[which(ldata[,arg[<span class="number">2</span>]]&gt;ldata[,arg[<span class="number">1</span>]]),]</span><br><span class="line">  pdata &lt;- cbind(pdata,<span class="string">&#x27;op&#x27;</span>=c(<span class="string">&#x27;Down&#x27;</span>)) <span class="comment">#添加op列</span></span><br><span class="line">  xdata &lt;- ldata[which(ldata[,arg[<span class="number">2</span>]]&lt;=ldata[,arg[<span class="number">1</span>]]),]</span><br><span class="line">  xdata &lt;- cbind(xdata,<span class="string">&#x27;op&#x27;</span>=<span class="string">&#x27;UP&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span>(rbind(pdata,xdata))</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">#以qtid分离数据，并返回一个list</span></span><br><span class="line">separateQtid&lt;-function(pdata,qtid)&#123;</span><br><span class="line">  <span class="keyword">if</span>(length(qtid)&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">    stop(<span class="string">&#x27;The length of qtid is at least one.&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  xdata &lt;- list()</span><br><span class="line">  <span class="keyword">for</span>(id <span class="keyword">in</span> qtid)&#123;</span><br><span class="line">    xdata[[id]] &lt;- pdata[which(pdata<span class="variable">$qtid</span>==id),]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>(xdata)</span><br><span class="line">&#125;</span><br><span class="line">pdata&lt;-genPoint(c(<span class="number">5</span>,<span class="number">4</span>),ldata)</span><br><span class="line">pdata &lt;- separateQtid(pdata,qtid)</span><br><span class="line"><span class="comment">#以date数据进行排序</span></span><br><span class="line"><span class="keyword">for</span>(id <span class="keyword">in</span> qtid)&#123;</span><br><span class="line">  pdata[[id]] &lt;- pdata[[id]][order(pdata[[id]]<span class="variable">$date</span>,decreasing=F),]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>这个时候pdata是一个list类型的结构，所以我只列出其中一个元素的前几行数据以展示。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; head(pdata[[<span class="number">1</span>]])</span><br><span class="line">       qtid       date close   ma5  ma20   op</span><br><span class="line"><span class="number">1</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2014</span>-<span class="number">01</span>-<span class="number">02</span> <span class="number">48.07</span> <span class="number">17.36</span> <span class="number">17.28</span> Down</span><br><span class="line"><span class="number">2</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2014</span>-<span class="number">01</span>-<span class="number">03</span> <span class="number">47.05</span> <span class="number">17.41</span> <span class="number">17.29</span> Down</span><br><span class="line"><span class="number">3</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2014</span>-<span class="number">01</span>-<span class="number">06</span> <span class="number">45.12</span> <span class="number">17.27</span> <span class="number">17.29</span>   <span class="variable constant_">UP</span></span><br><span class="line"><span class="number">4</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2014</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">45.08</span> <span class="number">17.12</span> <span class="number">17.27</span>   <span class="variable constant_">UP</span></span><br><span class="line"><span class="number">5</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2014</span>-<span class="number">01</span>-08 <span class="number">45.44</span> <span class="number">16.95</span> <span class="number">17.24</span>   <span class="variable constant_">UP</span></span><br><span class="line"><span class="number">6</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2014</span>-<span class="number">01</span>-09 <span class="number">45.42</span> <span class="number">16.75</span> <span class="number">17.18</span>   <span class="variable constant_">UP</span></span><br></pre></td></tr></table></figure>

<p>5）选择交易点。</p>
<p>也就是上面的走势图所说的，在红线的第一点买入，在紫线的第一点卖出。<br>模型设计思路：</p>
<ol>
<li>以5日均线和20日均线的交叉，进行交易信号的判断。</li>
<li>当5日均线上穿20日均线则买入(红色)，下穿20日均线卖出(蓝色)。</li>
</ol>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Signal&lt;-function(ldata=c(),pdata,qtid)&#123;</span><br><span class="line">  <span class="keyword">if</span>(length(qtid)&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">    stop(<span class="string">&#x27;The length of qtid is at least one.&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  op1 &lt;- list()</span><br><span class="line">  <span class="keyword">for</span>(id <span class="keyword">in</span> qtid)&#123;</span><br><span class="line">    pdata[[id]] &lt;- pdata[[id]][order(pdata[[id]]<span class="variable">$date</span>,decreasing=F),]</span><br><span class="line">    op &lt;- pdata[[id]][<span class="number">1</span>,]</span><br><span class="line">    tmp &lt;- op<span class="variable">$op</span></span><br><span class="line">    i &lt;- <span class="number">2</span></span><br><span class="line">    nrow &lt;- nrow(pdata[[id]])</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=nrow)&#123;</span><br><span class="line">      <span class="keyword">if</span>(tmp!=pdata[[id]][i,]<span class="variable">$op</span>)&#123;</span><br><span class="line">        op &lt;- rbind(op,pdata[[id]][i,])</span><br><span class="line">      &#125;</span><br><span class="line">      tmp &lt;- pdata[[id]][i,]<span class="variable">$op</span></span><br><span class="line">      i=i+<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    op1[[id]] &lt;- op</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>(op1)</span><br><span class="line">&#125;</span><br><span class="line">tdata&lt;-Signal(ldata,pdata,qtid)</span><br></pre></td></tr></table></figure>

<p>同pdata一样，这也是只展示了tdata的部分。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; head(tdata[[<span class="number">1</span>]])</span><br><span class="line">        qtid       date close   ma5  ma20   op</span><br><span class="line"><span class="number">1</span>  <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2014</span>-<span class="number">01</span>-<span class="number">02</span> <span class="number">48.07</span> <span class="number">17.36</span> <span class="number">17.28</span> Down</span><br><span class="line"><span class="number">3</span>  <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2014</span>-<span class="number">01</span>-<span class="number">06</span> <span class="number">45.12</span> <span class="number">17.27</span> <span class="number">17.29</span>   <span class="variable constant_">UP</span></span><br><span class="line"><span class="number">10</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2014</span>-<span class="number">01</span>-<span class="number">15</span> <span class="number">48.80</span> <span class="number">17.14</span> <span class="number">17.10</span> Down</span><br><span class="line"><span class="number">36</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2014</span>-<span class="number">02</span>-<span class="number">27</span> <span class="number">49.85</span> <span class="number">19.18</span> <span class="number">19.48</span>   <span class="variable constant_">UP</span></span><br><span class="line"><span class="number">64</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2014</span>-<span class="number">04</span>-09 <span class="number">46.82</span> <span class="number">16.94</span> <span class="number">16.86</span> Down</span><br><span class="line"><span class="number">72</span> <span class="number">002230</span>.<span class="variable constant_">SZ</span> <span class="number">2014</span>-<span class="number">04</span>-<span class="number">21</span> <span class="number">25.71</span> <span class="number">16.88</span> <span class="number">16.91</span>   <span class="variable constant_">UP</span></span><br></pre></td></tr></table></figure>

<p>6）模拟交易</p>
<p>预先设定参数是：本金为100000元，每次都全部买入卖出，即持仓比例为1，手续费为0.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#利用交易信号数据，进行模拟交易</span></span><br><span class="line"><span class="comment">#参数：交易信号tdata ,本金capital,持仓比例position,手续费比例fee</span></span><br><span class="line">trade&lt;-function(tdata,capital=<span class="number">100000</span>,position=<span class="number">1</span>,fee=<span class="number">0</span>)&#123;</span><br><span class="line">  value &lt;- as.numeric(tdata<span class="variable">$close</span>) </span><br><span class="line">  asset &lt;- capital</span><br><span class="line">  <span class="keyword">if</span>(tdata[<span class="number">1</span>,]<span class="variable">$op</span>==<span class="string">&#x27;Down&#x27;</span>)&#123;</span><br><span class="line">    amount &lt;- (asset*position)<span class="string">%/%value[1]</span></span><br><span class="line"><span class="string">    cash &lt;- (asset*position)%%value[1]</span></span><br><span class="line"><span class="string">    #奇数为0，偶数为asset减去上一次的。</span></span><br><span class="line"><span class="string">    diff &lt;- 0.00</span></span><br><span class="line"><span class="string">  &#125;else if(tdata[1,]$op==&#x27;UP&#x27;)&#123;</span></span><br><span class="line"><span class="string">    amount &lt;- 0</span></span><br><span class="line"><span class="string">    cash &lt;- asset</span></span><br><span class="line"><span class="string">    diff &lt;- 0.00</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  i&lt;-2</span></span><br><span class="line"><span class="string">  nrow &lt;- nrow(tdata)</span></span><br><span class="line"><span class="string">  while(i&lt;=nrow)&#123;</span></span><br><span class="line"><span class="string">    #Down 买入</span></span><br><span class="line"><span class="string">    if(tdata[i,]$op==&#x27;Down&#x27;)&#123;</span></span><br><span class="line"><span class="string">      asset &lt;- c(asset,tail(asset,1))</span></span><br><span class="line"><span class="string">      amount &lt;- c(amount,(tail(asset,1)*position)%/</span>%value[i])</span><br><span class="line">      cash &lt;- c(cash,(tail(asset,<span class="number">1</span>)*position)<span class="string">%%value[i]+(tail(asset,1)*(1-position)))</span></span><br><span class="line"><span class="string">      diff &lt;- c(diff,0.00)</span></span><br><span class="line"><span class="string">    &#125;else if(tdata[i,]$op==&#x27;UP&#x27;)&#123;</span></span><br><span class="line"><span class="string">      #UP 卖出</span></span><br><span class="line"><span class="string">      cash &lt;- c(cash,(tail(amount,1)*value[i])+tail(cash,1))</span></span><br><span class="line"><span class="string">      amount &lt;- c(amount,0)</span></span><br><span class="line"><span class="string">      asset &lt;- c(asset,tail(amount,1)*value[i]+tail(cash,1))</span></span><br><span class="line"><span class="string">      diff &lt;- c(diff,tail(asset,1)-tail(asset,2)[1])</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    i=i+1</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  result &lt;- list()</span></span><br><span class="line"><span class="string">  result[[&#x27;ticks&#x27;]] &lt;- cbind(tdata,cash,amount,asset,diff)</span></span><br><span class="line"><span class="string">  indexRise &lt;- c()</span></span><br><span class="line"><span class="string">  indexFall &lt;- c()</span></span><br><span class="line"><span class="string">  i &lt;- 2</span></span><br><span class="line"><span class="string">  while(i&lt;=nrow)&#123;</span></span><br><span class="line"><span class="string">    if(result[[&#x27;ticks&#x27;]][i,]$diff &gt; 0)&#123;</span></span><br><span class="line"><span class="string">      indexRise &lt;- c(indexRise,i-1,i)</span></span><br><span class="line"><span class="string">    &#125;else if(result[[&#x27;ticks&#x27;]][i,]$diff &lt; 0)&#123;</span></span><br><span class="line"><span class="string">      indexFall &lt;- c(indexFall,i-1,i)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    i &lt;- i+1</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  result[[&#x27;rise&#x27;]] &lt;- result$ticks[indexRise,]</span></span><br><span class="line"><span class="string">  result[[&#x27;fall&#x27;]] &lt;- result$ticks[indexFall,]</span></span><br><span class="line"><span class="string">  return(result)</span></span><br><span class="line"><span class="string">&#125; </span></span><br><span class="line"><span class="string">#设定交易参数，以$10W为本金，满仓买入或卖出，手续为0，传入交易信号。</span></span><br><span class="line"><span class="string"># 查看每笔交易，将会变成一个list，保存每一个qtid的交易记录result</span></span><br><span class="line"><span class="string">#每一个qtid的交易记录</span></span><br><span class="line"><span class="string">tradeList &lt;- list()</span></span><br><span class="line"><span class="string">for(id in qtid)&#123;</span></span><br><span class="line"><span class="string">  tradeList[[id]] &lt;- trade(tdata[[id]],100000)</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>7）计算收益率，并记录在一个列表里面，生成dataframe，信息包含日期，代码，名称，收益率，涨跌幅，近1周涨跌，近1月涨跌，年初至今涨跌。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">income &lt;- c()</span><br><span class="line">quoteChangeDaily &lt;- c()</span><br><span class="line">quoteChangeWeek &lt;- c()</span><br><span class="line">quoteChangeMonth &lt;- c() </span><br><span class="line">quoteChangeFYear &lt;- c()</span><br><span class="line"><span class="keyword">for</span>(id <span class="keyword">in</span> qtid)&#123;</span><br><span class="line">  <span class="comment">#C(),收益率。收益率 = （当天的股价-买入价）/ 买入价 *100%</span></span><br><span class="line">  income &lt;- c(income,(tail(tradeList[[id]]$ticks<span class="variable">$asset</span>,<span class="number">1</span>)-tradeList[[id]]$ticks<span class="variable">$asset</span>[<span class="number">1</span>])/tradeList[[id]]$ticks<span class="variable">$asset</span>[<span class="number">1</span>]*<span class="number">100</span>)</span><br><span class="line">  mktYest &lt;- getDailyQuote(data=<span class="string">&#x27;mktFwdDaily&#x27;</span>,qtid = id,startdate=pdata[[id]]<span class="variable">$date</span>[nrow(pdata[[id]])-<span class="number">1</span>],enddate=pdata[[id]]<span class="variable">$date</span>[nrow(pdata[[id]])-<span class="number">1</span>],key=key)</span><br><span class="line">  mktWeek &lt;- getDailyQuote(data=<span class="string">&#x27;mktFwdDaily&#x27;</span>,qtid = id,startdate=pdata[[id]]<span class="variable">$date</span>[nrow(pdata[[id]])-<span class="number">5</span>],enddate=pdata[[id]]<span class="variable">$date</span>[nrow(pdata[[id]])-<span class="number">5</span>],key=key)</span><br><span class="line">  mktMonth &lt;- getDailyQuote(data=<span class="string">&#x27;mktFwdDaily&#x27;</span>,qtid = id,startdate=pdata[[id]]<span class="variable">$date</span>[nrow(pdata[[id]])-<span class="number">20</span>],enddate=pdata[[id]]<span class="variable">$date</span>[nrow(pdata[[id]])-<span class="number">20</span>],key=key)</span><br><span class="line">  mktFYear &lt;- getDailyQuote(data=<span class="string">&#x27;mktFwdDaily&#x27;</span>,qtid = id,startdate=pdata[[id]]<span class="variable">$date</span>[<span class="number">1</span>],enddate=pdata[[id]]<span class="variable">$date</span>[<span class="number">1</span>],key=key)</span><br><span class="line">  <span class="comment">#涨跌幅 .涨跌幅的计算公式是：(当前最新成交价（或收盘价）-开盘参考价)÷开盘参考价×100%  [which(mktYest$qtid==id),]</span></span><br><span class="line">  quoteChangeDaily &lt;- c(quoteChangeDaily,(as.numeric(tail(pdata[[id]], <span class="number">1</span>)<span class="variable">$close</span>)-mktYest<span class="variable">$close</span>)/mktYest<span class="variable">$close</span>*<span class="number">100</span>)</span><br><span class="line">  <span class="comment">#近1周涨跌</span></span><br><span class="line">  quoteChangeWeek &lt;- c(quoteChangeWeek,(as.numeric(tail(pdata[[id]], <span class="number">1</span>)<span class="variable">$close</span>)-mktWeek<span class="variable">$close</span>)/mktWeek<span class="variable">$close</span>*<span class="number">100</span>)</span><br><span class="line">  <span class="comment">#近1月涨跌</span></span><br><span class="line">  quoteChangeMonth &lt;- c(quoteChangeMonth,(as.numeric(tail(pdata[[id]], <span class="number">1</span>)<span class="variable">$close</span>)-mktMonth<span class="variable">$close</span>)/mktMonth<span class="variable">$close</span>*<span class="number">100</span>)</span><br><span class="line">  <span class="comment">#年初至今涨跌</span></span><br><span class="line">  quoteChangeFYear &lt;- c(quoteChangeFYear,(as.numeric(tail(pdata[[id]], <span class="number">1</span>)<span class="variable">$close</span>)-mktFYear<span class="variable">$close</span>)/mktFYear<span class="variable">$close</span>*<span class="number">100</span>)</span><br><span class="line">&#125;</span><br><span class="line">ChiAbbr &lt;- getMD(data=<span class="string">&#x27;keyMap&#x27;</span>,qtid=qtid,key=key)<span class="variable">$ChiAbbr</span></span><br><span class="line">maDF &lt;- data.frame(<span class="string">&#x27;1&#x27;</span>=tail(dailyQuote,<span class="number">1</span>)<span class="variable">$date</span>,<span class="string">&#x27;2&#x27;</span>=qtid,<span class="string">&#x27;3&#x27;</span>=ChiAbbr,</span><br><span class="line">                   <span class="string">&#x27;4&#x27;</span>=income,<span class="string">&#x27;5&#x27;</span>=quoteChangeDaily,<span class="string">&#x27;6&#x27;</span>=quoteChangeWeek,<span class="string">&#x27;7&#x27;</span>=quoteChangeMonth,</span><br><span class="line">                   <span class="string">&#x27;8&#x27;</span>=quoteChangeFYear)</span><br><span class="line"><span class="comment">#排序</span></span><br><span class="line">maDF &lt;- maDF[order(maDF<span class="variable">$X4</span>,decreasing=T),]</span><br></pre></td></tr></table></figure>

<p>8）求取沪深300指数</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">hs300&lt;-getDailyQuote(data=<span class="string">&#x27;mktDataIndex&#x27;</span>,qtid=c(<span class="string">&#x27;000300.SH&#x27;</span>),startdate=sDate,enddate=eDate,key=key) </span><br><span class="line"></span><br><span class="line">id &lt;- c(<span class="string">&#x27;000300.SH&#x27;</span>)</span><br><span class="line"></span><br><span class="line">hs300mktWeek &lt;- hs300[nrow(hs300)-<span class="number">5</span>,]</span><br><span class="line"></span><br><span class="line">hs300mktMonth &lt;- hs300[nrow(hs300)-<span class="number">20</span>,]</span><br><span class="line"></span><br><span class="line">hs300mktFYear &lt;- hs300[<span class="number">1</span>,]</span><br><span class="line"></span><br><span class="line">quoteChangeDaily &lt;- (tail(hs300,<span class="number">1</span>)<span class="variable">$close</span>-tail(hs300,<span class="number">1</span>)<span class="variable">$prevClose</span>)/tail(hs300,<span class="number">1</span>)<span class="variable">$prevClose</span>*<span class="number">100</span></span><br><span class="line"></span><br><span class="line">quoteChangeWeek &lt;- (tail(hs300,<span class="number">1</span>)<span class="variable">$close</span>-hs300mktWeek<span class="variable">$close</span>)/hs300mktWeek<span class="variable">$close</span>*<span class="number">100</span></span><br><span class="line"></span><br><span class="line">quoteChangeMonth &lt;- (tail(hs300,<span class="number">1</span>)<span class="variable">$close</span>-hs300mktMonth<span class="variable">$close</span>)/hs300mktMonth<span class="variable">$close</span>*<span class="number">100</span></span><br><span class="line"></span><br><span class="line">quoteChangeFYear &lt;- (tail(hs300,<span class="number">1</span>)<span class="variable">$close</span>-hs300mktFYear<span class="variable">$close</span>)/hs300mktFYear<span class="variable">$close</span>*<span class="number">100</span></span><br><span class="line"></span><br><span class="line">hs300Income &lt;- c()</span><br><span class="line"></span><br><span class="line">hs300Income &lt;- (tail(hs300,<span class="number">1</span>)<span class="variable">$close</span>-hs300mktFYear<span class="variable">$close</span>)/hs300mktFYear<span class="variable">$close</span>*<span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成dataframe</span></span><br><span class="line">hs300Dt &lt;- data.frame(<span class="string">&#x27;1&#x27;</span>=tail(dailyQuote,<span class="number">1</span>)<span class="variable">$date</span>,<span class="string">&#x27;2&#x27;</span>=<span class="string">&#x27;000300.SH&#x27;</span>,<span class="string">&#x27;3&#x27;</span>=<span class="string">&#x27;沪深300&#x27;</span>,<span class="string">&#x27;4&#x27;</span>=hs300Income,<span class="string">&#x27;5&#x27;</span>=quoteChangeDaily,<span class="string">&#x27;6&#x27;</span>=quoteChangeWeek,<span class="string">&#x27;7&#x27;</span>=quoteChangeMonth,<span class="string">&#x27;8&#x27;</span>=quoteChangeFYear)</span><br></pre></td></tr></table></figure>

<p>沪深300指数的数据是这样的：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; hs300Dt </span><br><span class="line">          <span class="variable constant_">X1</span>        <span class="variable constant_">X2</span>      <span class="variable constant_">X3</span>        <span class="variable constant_">X4</span>       <span class="variable constant_">X5</span>         <span class="variable constant_">X6</span>        <span class="variable constant_">X7</span>        <span class="variable constant_">X8</span></span><br><span class="line"><span class="number">1</span> <span class="number">2016</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">000300</span>.<span class="variable constant_">SH</span> 沪深<span class="number">300</span> -<span class="number">14.50151</span> <span class="number">1.042311</span> -<span class="number">0.1688989</span> -<span class="number">18.69586</span> -<span class="number">14.50151</span></span><br></pre></td></tr></table></figure>

<p>9）合并数据，并发送到况客投研平台，进行后期的修改。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">maDF &lt;- rbind(hs300Dt,maDF)</span><br><span class="line">names(maDF)&lt;-c(<span class="string">&#x27;日期&#x27;</span>,<span class="string">&#x27;代码&#x27;</span>,<span class="string">&#x27;名称&#x27;</span>,<span class="string">&#x27;收益率(%)&#x27;</span>,<span class="string">&#x27;涨跌幅(%)&#x27;</span>,<span class="string">&#x27;周涨跌幅(%)&#x27;</span>,<span class="string">&#x27;月涨跌幅(%)&#x27;</span>,<span class="string">&#x27;年初至今涨跌幅（%）&#x27;</span>)</span><br><span class="line">postData(maDF,name=<span class="string">&#x27;maDataF&#x27;</span>,key=key)</span><br></pre></td></tr></table></figure>


<p>这样，便算是完成了。大家如果有什么不明白的话，可以随时艾特我哦。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>MACD策略</p><p><a href="http://example.com/2022/07/24/2016-01-14-MACD/">http://example.com/2022/07/24/2016-01-14-MACD/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>yalechen</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-07-24</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-07-24</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="notification is-danger">You need to set <code>install_url</code> to use ShareThis. Please set it in <code>_config.yml</code>.</div></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" href="/" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>爱发电</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/" alt="支付宝"></span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>送我杯咖啡</span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="patreon"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a><div class="notification is-danger">You forgot to set the <code>business</code> or <code>currency_code</code> for Paypal. Please set it in <code>_config.yml</code>.</div><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/07/30/2022-7-30-Binaryen-Readme/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">2022-7-30-Binaryen-Readme</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/07/24/2016-01-20-OpenCV-with-CodeBlocks/"><span class="level-item">OpenCV with CodeBlocks</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="notification is-danger">You forgot to set the <code>shortname</code> for Disqus. Please set it in <code>_config.yml</code>.</div></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="cyw3"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">cyw3</p><p class="is-size-6 is-block">ProgramAnalysis/Compiler/VirtualMachine</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shenzhen, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">31</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">2</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/cyw3" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/cyw3"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前言"><span class="level-left"><span class="level-item">1</span><span class="level-item">前言</span></span></a></li><li><a class="level is-mobile" href="#目录"><span class="level-left"><span class="level-item">2</span><span class="level-item">目录</span></span></a></li><li><a class="level is-mobile" href="#1、MACD的介绍"><span class="level-left"><span class="level-item">3</span><span class="level-item">1、MACD的介绍</span></span></a></li><li><a class="level is-mobile" href="#2、均线模型展示"><span class="level-left"><span class="level-item">4</span><span class="level-item">2、均线模型展示</span></span></a></li><li><a class="level is-mobile" href="#3、R语言实现MACD策略"><span class="level-left"><span class="level-item">5</span><span class="level-item">3、R语言实现MACD策略</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://tca.tencent.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Tencent Code Analysis</span></span><span class="level-right"><span class="level-item tag">tca.tencent.com</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-21T08:20:12.000Z">2022-10-21</time></p><p class="title"><a href="/2022/10/21/2022-10-21-front_end_framework_check/">2022-10-21-front_end_framework_check</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-30T03:20:12.000Z">2022-07-30</time></p><p class="title"><a href="/2022/07/30/2022-7-30-Binaryen-Readme/">2022-7-30-Binaryen-Readme</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-24T06:56:22.285Z">2022-07-24</time></p><p class="title"><a href="/2022/07/24/2016-01-14-MACD/">MACD策略</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-24T06:55:45.905Z">2022-07-24</time></p><p class="title"><a href="/2022/07/24/2016-01-20-OpenCV-with-CodeBlocks/">OpenCV with CodeBlocks</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-24T06:55:26.913Z">2022-07-24</time></p><p class="title"><a href="/2022/07/24/2016-01-12-Welcome-to-yalesonchan-blog/">Welcome to yalechen&#039;s blog</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">30</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/TCA/"><span class="tag">TCA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/wasm/"><span class="tag">wasm</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Cyw3</a><p class="is-size-7"><span>&copy; 2022 yalechen</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cyw3/cyw3.github.io"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>